<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Proyectos v2.4</title>
    
    <!-- LIBRERÍAS EXTERNAS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Editor de Texto Enriquecido (Quill.js) -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>
    <!-- LIBRERÍA PARA DRAG-AND-DROP (SortableJS) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<style>
    /* --- Paleta de Colores y Variables --- */
    :root {
        /* Colores Base */
        --base-primary: #003366;
        --base-secondary: #D4AF37;
        --base-success: #28a745;
        --base-danger: #dc3545;
        --base-warning: #ffc107;
        --base-info: #17a2b8;
        --base-gray: #6c757d;
        --base-full: #0080ff;

        /* Tema Claro (Default) */
        --primary-color: var(--base-primary);
        --secondary-color: var(--base-secondary);
        --success-color: var(--base-success);
        --danger-color: var(--base-danger);
        --warning-color: var(--base-warning);
        --info-color: var(--base-info);
        --gray-color: var(--base-gray);
        --full-color: var(--base-full);

        --background-color: #f0f2f5;
        --card-background: #ffffff;
        --text-color: #333;
        --light-text-color: #6c757d;
        --border-color: #e0e0e0;
        --header-bg: #fafafa;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    
    body.dark-mode {
        /* Tema Oscuro */
        --primary-color: #58a6ff;
        --secondary-color: #f7d16f;
        --success-color: #56d364;
        --danger-color: #f85149;
        --warning-color: #e3b341;
        --info-color: #56d4dd;
        --gray-color: #8b949e;
        
        --background-color: #0d1117;
        --card-background: #161b22;
        --text-color: #c9d1d9;
        --light-text-color: #8b949e;
        --border-color: #30363d;
        --header-bg: #1f242c;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: var(--background-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
    .container { max-width: 1800px; margin: 0 auto; padding: 2rem; }
    header { text-align: center; margin-bottom: 2rem; position: relative; }
    header h1 { font-size: 2.5rem; color: var(--primary-color); }
    header p { font-size: 1.1rem; color: var(--light-text-color); margin-bottom: 0; }
    
    #dark-mode-toggle { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; background: transparent; border: none; cursor: pointer; color: var(--secondary-color); }

    .tabs-nav { display: flex; justify-content: center; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; flex-wrap: wrap; }
    .tab-link { padding: 1rem 1.5rem; cursor: pointer; border: none; background: none; font-size: 1.1rem; font-weight: 600; color: var(--light-text-color); border-bottom: 4px solid transparent; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
    .tab-link:hover { color: var(--primary-color); }
    .tab-link.active { color: var(--primary-color); border-bottom-color: var(--secondary-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .project-type-tabs-nav { display: flex; justify-content: center; border-bottom: 2px solid var(--border-color); margin-bottom: 0; flex-wrap: wrap; gap: 0.75rem; }
    .project-type-tab-link { padding: 0.75rem 1.2rem; cursor: pointer; border: 1px solid var(--border-color); border-bottom: none; background-color: var(--card-background); border-radius: 12px; font-size: 0.95rem; font-weight: 600; color: var(--light-text-color); transition: all 0.2s ease; }
    .project-type-tab-link:hover { background-color: var(--header-bg); color: var(--primary-color); }
    .project-type-tab-link.active { background-color: var(--primary-color); color: var(--card-background); border-color: var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

    .card { background: var(--card-background); border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; overflow: hidden; }
    .card-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--header-bg); flex-wrap: wrap; gap: 1rem; }
    .card-header h3 { font-size: 1.5rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.75rem; }
    .card-body { padding: 1.5rem; }

    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
    #analitica .grid-container { grid-template-columns: 1fr 2fr; }
    .event-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 1.5rem;}
    
    .report-card { padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between; background-color: var(--card-background); }
    .empty-state { text-align: center; padding: 3rem; color: var(--light-text-color); font-style: italic; }

    .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn-primary { background-color: var(--primary-color); color: var(--card-background); }
    .btn-danger { background-color: var(--danger-color); color: white; }
    .btn-warning { background-color: var(--warning-color); color: black; }
    .btn-success { background-color: var(--success-color); color: white; }
    .btn-secondary { background-color: var(--gray-color); color: white; }
    .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; border-radius: 8px;}
    .icon-btn { background: none; border: none; color: var(--light-text-color); font-size: 1.1rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 50%; }
    .icon-btn:hover { background-color: var(--header-bg); color: var(--primary-color); }
    
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background-color: var(--header-bg); font-weight: 600; }
    td.actions { display: flex; gap: 0.5rem; align-items: center; }

    .event-card-item { background: var(--card-background); border-radius: 12px; box-shadow: 5px 5px 12px 0px rgba(0,0,0,0.61); display: flex; flex-direction: column; border: 1px solid var(--border-color); cursor: grab;}
    .event-card-item:active { cursor: grabbing; }
    .event-card-item.sortable-ghost { opacity: 0.4; background: #c8ebfb; }
    .event-card-item.sortable-chosen { box-shadow: 0 8px 20px rgba(0, 51, 102, 0.2); transform: scale(1.02); }
    .event-card-item-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .event-card-item-header h4 { color: var(--primary-color); cursor: pointer; transition: background-color 0.2s; padding: 5px; border-radius: 4px; width: calc(100% - 40px); }
    .event-card-item-header h4:hover { background-color: var(--header-bg); }
    .inline-edit-input { width: 100%; font-size: 1.1rem; font-weight: bold; color: var(--primary-color); border: 2px solid var(--secondary-color); border-radius: 4px; padding: 4px; font-family: inherit; background-color: var(--card-background); }
    .event-card-item-body { padding: 1rem; display: flex; flex-direction: column; gap: 1rem; flex-grow: 1; }
    .event-card-progress { display: flex; align-items: center; gap: 1rem; }
    .progress-chart-container { width: 80px; height: 80px; position: relative; flex-shrink: 0;}
    .progress-chart-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; font-weight: 700; }
    .event-card-info { font-size: 0.9rem; color: var(--light-text-color); }
    .event-card-item-footer { padding: 1rem; border-top: 1px solid var(--border-color); text-align: right; display: flex; justify-content: flex-end; gap: 0.5rem; flex-wrap: wrap; }
    .btn-manage { background-color: var(--success-color); color: white; }
    .btn-edit-details { background-color: var(--primary-color); color: var(--card-background); }

    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
    .modal-content { background-color: var(--card-background); margin: 5% auto; padding: 2rem; border-radius: 12px; max-width: 90%; width: 900px; position: relative; animation: slideIn 0.3s; border: 1px solid var(--border-color); }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .close-btn { color: var(--light-text-color); position: absolute; top: 1rem; right: 1.5rem; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    .modal-content h3 { margin-bottom: 1.5rem; color: var(--primary-color); }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--background-color); color: var(--text-color); }

    #modal-checklist .modal-content { width: 1200px; }
    #modal-descripcion .modal-content, #modal-observacion .modal-content { width: 800px; }
    #modal-miembro .modal-content, #modal-evento .modal-content, #modal-edit-evento .modal-content, #modal-bulk-miembro .modal-content, #modal-edit-pago .modal-content, #modal-transfer-task .modal-content { width: 500px; }
    #modal-responsables .modal-content { width: 400px; }
    #modal-day-tasks .modal-content { width: 600px; }


    #checklist-container { max-height: 70vh; overflow-y: auto; padding-right: 1rem; }
    .checklist-phase h4 { margin-top: 1.5rem; margin-bottom: 1rem; color: var(--primary-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 0.5rem;}
    .task-card { background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; padding: 1rem; transition: box-shadow 0.2s ease; }
    .task-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .task-main-line { display: flex; align-items: center; gap: 1rem; }
    .task-main-line input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--success-color); flex-shrink: 0; cursor: pointer;}
    .task-description { flex-grow: 1; }
    .task-description input[type="text"] { width: 100%; border: none; font-size: 1.05rem; padding: 0.25rem; border-radius: 4px; transition: background-color 0.2s; background-color: transparent; color: var(--text-color); }
    .task-description input[type="text"]:focus { background-color: var(--header-bg); outline: 1px solid var(--primary-color); }
    .task-card.completed .task-description input[type="text"] { text-decoration: line-through; color: var(--light-text-color); }
    .task-actions { display: flex; align-items: center; gap: 0.25rem; }
    .task-details { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-top: 0.75rem; padding-left: 2.2rem; font-size: 0.9rem; }
    .task-detail-item { display: flex; align-items: center; gap: 0.5rem; }
    .task-detail-item label { font-weight: 600; color: #555; }
    .task-detail-item input[type="datetime-local"] { padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.85rem; background-color: var(--background-color); color: var(--text-color); }
    .responsables-display { font-size: 0.85rem; color: var(--light-text-color); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .status-badge { padding: 0.2rem 0.6rem; border-radius: 12px; font-weight: 600; color: white; font-size: 0.8rem; cursor: pointer; text-align: center; min-width: 80px;}
    .status-badge.status-Completado { background-color: var(--success-color); }
    .status-badge.status-En-proceso { background-color: var(--info-color); }
    .status-badge.status-Aplazado { background-color: var(--warning-color); color: black; }
    .status-badge.status-Atrasado { background-color: var(--danger-color); }
    .status-badge.status-Cancelado { background-color: var(--gray-color); }
    .status-select { padding: 0.2rem 0.4rem; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.8rem; background-color: var(--background-color); color: var(--text-color); }
    .add-task-btn-container { text-align: left; margin-top: 1.5rem; }
    .btn-add-task { background: var(--secondary-color); color: var(--base-primary); }
    .subtasks-container { margin-left: 2.2rem; border-left: 2px solid var(--border-color); padding-left: 1rem; margin-top: 1rem; }
    .subtask-card { background-color: var(--header-bg); transform: scale(0.98); }
    .add-subtask-btn { background: #e0f7fa; color: #00796b; padding: 0.3rem 0.8rem; border-radius: 8px; font-size: 0.85rem; }
    
    #responsables-checkbox-container { max-height: 420px; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 6px; }
    .responsable-option { display: block; margin-bottom: 0.5rem; }
    .responsable-option label { margin-left: 0.5rem; }
    
    .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .calendar-nav h2 { color: var(--primary-color); }
    .calendar-header { font-weight: bold; text-align: center; color: var(--primary-color); padding: 1rem 1rem 0 1rem; display:grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; padding: 1rem;}
    .calendar-day { border: 1px solid var(--border-color); min-height: 120px; padding: 0.5rem; background-color: var(--card-background); position: relative; border-radius: 8px; transition: background-color 0.2s; }
    .calendar-day.other-month { background-color: var(--header-bg); color: var(--light-text-color); opacity: 0.5; }
    .day-number { font-weight: bold; }
    .day-tasks-badge { position: absolute; bottom: 8px; right: 8px; background-color: var(--secondary-color); color: var(--base-primary); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; }
    .calendar-day.has-tasks { cursor: pointer; background-color: color-mix(in srgb, var(--secondary-color) 20%, transparent); }
    .calendar-day.event-start-day { background-color: color-mix(in srgb, var(--danger-color) 20%, transparent); border: 2px solid var(--danger-color); }
    .calendar-day.event-start-day::after { content: "\f144"; font-family: "Font Awesome 6 Free"; font-weight: 900; color: var(--danger-color); position: absolute; top: 8px; right: 8px; font-size: 1.2rem; }
    #day-tasks-list li { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--border-color); list-style: none;}
    p { margin-bottom: 1.2rem; }

    /* --- ESTILOS MEJORADOS PARA FINANZAS --- */
    #finanzas-detail-view h3 { color: var(--primary-color); margin-bottom: 1.5rem; }
    #finanzas-detail-view h4 { color: var(--secondary-color); margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;}
    .finanzas-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .finanzas-pagos-list { max-height: 300px; overflow-y: auto; margin-bottom: 1rem; padding-right: 10px; }
    .finanzas-pago-item { display: grid; grid-template-columns: 2fr 1.5fr 1fr auto; gap: 1rem; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
    .finanzas-pago-item:last-child { border-bottom: none; }
    .finanzas-pago-actions { display: flex; gap: 0.5rem; }
    .finanzas-add-pago-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; }
    .finanzas-add-pago-form .form-group { margin-bottom: 0; }
    .finanzas-add-pago-form input { padding: 0.5rem; }
    .finanzas-add-pago-form button { grid-column: 1 / -1; } /* Botón ocupa toda la fila */
    
    #otros-container { display: flex; flex-direction: column; gap: 1.5rem; }
    .otro-item { border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; background-color: var(--card-background); }
    .otro-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: var(--header-bg); cursor: pointer; }
    .otro-header h4 { color: var(--primary-color); flex-grow: 1; cursor: text; }
    .otro-header .inline-edit-input { font-size: 1.15rem; }
    .otro-content { padding: 1.5rem; border-top: 1px solid var(--border-color); display: none; }
    .ql-toolbar, .ql-container { border-color: var(--border-color) !important; }
    .ql-editor { color: var(--text-color); }
    .otro-content .ql-editor { min-height: 200px; }
    .otro-item.open .otro-content { display: block; }
    .otro-item.open .toggle-icon { transform: rotate(180deg); }
    .toggle-icon { transition: transform 0.3s ease; }


    @media (max-width: 768px) {
        .container { padding: 1rem; }
        header h1 { font-size: 2rem; }
        header p { font-size: 1rem; }

        .grid-container,
        #analitica .grid-container,
        .event-grid,
        .finanzas-detail-grid { grid-template-columns: 1fr; }

        .card-header h3 { font-size: 1.25rem; }
        .card-body { padding: 1rem; }

        .modal-content,
        #modal-checklist .modal-content, #modal-descripcion .modal-content, #modal-observacion .modal-content,
        #modal-miembro .modal-content, #modal-evento .modal-content, #modal-edit-evento .modal-content, 
        #modal-bulk-miembro .modal-content, #modal-responsables .modal-content,
        #modal-day-tasks .modal-content, #modal-edit-pago .modal-content, #modal-transfer-task .modal-content {
            width: 95% !important; padding: 1.5rem 1rem; margin-top: 10%;
        }
        #checklist-container { max-height: 65vh; padding-right: 0.5rem; }
        
        .task-main-line { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
        .task-details { padding-left: 0; flex-direction: column; align-items: flex-start; gap: 0.75rem; }

        .calendar-nav { flex-direction: column; gap: 1rem; }
        #calendar-grid, .calendar-header { gap: 5px; padding: 0.5rem; }
        .calendar-day { min-height: 60px; padding: 0.25rem; font-size: 0.8rem; }

        .finanzas-add-pago-form { grid-template-columns: 1fr; }
    }

    @media (max-width: 480px) {
        .tabs-nav { justify-content: flex-start; }
        .tab-link { padding: 0.75rem 1rem; font-size: 1rem; }
        header h1 { font-size: 1.8rem; }
        .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
    }
</style>
</head>
<body>

<div class="container">
    <header>
        <button id="dark-mode-toggle" title="Alternar Modo Oscuro"><i class="fas fa-moon"></i></button>
        <h1>PROYECTO</h1>
        <p>FORTALECIMIENTO ECONÓMICO DE UNIDADES PRODUCTIVAS Y EMPRESAS MEDIANTE LA COMERCIALIZACIÓN EN MERCADOS INTERNOS Y EXTERNOS DEL DEPARTAMENTO DEL CAUCA</p>
    </header>

    <div class="tabs-nav">
        <button class="tab-link active" data-tab="analitica"><i class="fas fa-chart-pie"></i> Analítica</button>
        <button class="tab-link" data-tab="gestion"><i class="fas fa-tasks"></i> Gestión de Eventos</button>
        <button class="tab-link" data-tab="cronograma"><i class="fas fa-calendar-alt"></i> Cronograma</button>
        <button class="tab-link" data-tab="equipo"><i class="fas fa-users"></i> Gestión de Equipo</button>
        <button class="tab-link" data-tab="finanzas"><i class="fas fa-money-bill-wave"></i> Finanzas</button>
        <button class="tab-link" data-tab="otros"><i class="fas fa-stream"></i> Otros</button>
        <button class="tab-link" data-tab="reportes"><i class="fas fa-download"></i> Reportes</button>
    </div>

    <!-- MÓDULO 1: ANALÍTICA -->
    <div id="analitica" class="tab-content active">
        <div class="grid-container">
            <div class="card"><div class="card-header"><h3><i class="fas fa-tachometer-alt"></i> Avance general</h3></div><div class="card-body" style="height: 350px;"><canvas id="generalChart"></canvas></div></div>
            <div class="card"><div class="card-header"><h3><i class="fas fa-calendar-check"></i> Avance por evento</h3></div><div class="card-body" style="height: 350px;"><canvas id="eventosChart"></canvas></div></div>
        </div>
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-user-check"></i> Desempeño por persona</h3></div>
            <div class="card-body" style="height: 400px;"><canvas id="personasChart"></canvas></div>
        </div>
    </div>
    
    <!-- MÓDULO 2: GESTIÓN DE EVENTOS -->
    <div id="gestion" class="tab-content">
        <div class="project-type-tabs-nav" id="event-project-type-nav"></div>
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-clipboard-list"></i> Eventos del proyecto</h3>
                <button class="btn btn-primary" id="btn-add-evento"><i class="fas fa-plus"></i> Crear nuevo</button>
            </div>
            <div class="card-body"><div id="event-grid-container" class="event-grid"></div></div>
        </div>
    </div>
    
    <!-- MÓDULO 3: CRONOGRAMA -->
    <div id="cronograma" class="tab-content">
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-calendar-alt"></i> Cronograma mensual de tareas</h3></div>
            <div class="card-body">
                <div class="calendar-nav">
                    <button class="btn btn-primary" id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="calendar-month-year"></h2>
                    <button class="btn btn-primary" id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-header">
                    <div>Dom</div><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div>
                </div>
                <div id="calendar-grid"></div>
            </div>
        </div>
    </div>

    <!-- MÓDULO 4: GESTIÓN DE EQUIPO -->
    <div id="equipo" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-users-cog"></i> Miembros del equipo</h3>
                <div>
                    <button class="btn btn-primary" id="btn-add-miembro"><i class="fas fa-user-plus"></i> Añadir miembro</button>
                    <button class="btn btn-primary" id="btn-bulk-add-miembro"><i class="fas fa-users"></i> Carga masiva</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" id="equipo-table-container">
                    <table id="tabla-equipo">
                        <thead><tr><th>Nombre</th><th>Tareas asignadas</th><th>Acciones</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MÓDULO 5: FINANZAS (MEJORADO) -->
    <div id="finanzas" class="tab-content">
        <!-- Vista Principal: Tabla de Miembros -->
        <div id="finanzas-main-view">
            <div class="card">
                <div class="card-header">
                    <h3><i class="fas fa-wallet"></i> Resumen Financiero por Miembro</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive" id="finanzas-table-container">
                        <table id="tabla-finanzas">
                            <thead>
                                <tr>
                                    <th>Miembro del Equipo</th>
                                    <th>Total Honorarios</th>
                                    <th>Total Desplazamientos</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Vista de Detalle: Gestión de Pagos Individual (oculta por defecto) -->
        <div id="finanzas-detail-view" style="display: none;">
            <!-- El contenido se generará dinámicamente con JS -->
        </div>
    </div>

    <!-- MÓDULO 6: OTROS -->
    <div id="otros" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-box-open"></i> Listas de Contenido Personalizado</h3>
                <button class="btn btn-primary" id="btn-add-otro-item"><i class="fas fa-plus"></i> Añadir nueva lista</button>
            </div>
            <div class="card-body">
                <div id="otros-container"></div>
            </div>
        </div>
    </div>

    <!-- MÓDULO 7: REPORTES -->
    <div id="reportes" class="tab-content">
        <div class="card">
             <div class="card-header"><h3><i class="fas fa-file-excel"></i> Reportes en Excel</h3></div>
             <div class="card-body grid-container" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                 <div class="report-card"><h4><i class="fas fa-tasks"></i> Tareas por Persona</h4><p>Genera un archivo con el detalle de tareas asignadas a cada miembro del equipo.</p><button class="btn btn-primary" id="btn-download-tareas-persona"><i class="fas fa-file-excel"></i> Descargar</button></div>
                 <div class="report-card"><h4><i class="fas fa-chart-line"></i> Avance por Evento</h4><p>Genera un archivo con el resumen de avance (total de tareas, completadas, %) de cada evento.</p><button class="btn btn-primary" id="btn-download-avance-evento"><i class="fas fa-file-excel"></i> Descargar</button></div>
                 <div class="report-card"><h4><i class="fas fa-clipboard-list"></i> Estado General de Eventos</h4><p>Genera un archivo con una hoja por cada evento, detallando todas sus tareas, fases y responsables.</p><button class="btn btn-primary" id="btn-download-estado-general"><i class="fas fa-file-excel"></i> Descargar</button></div>
                 <div class="report-card"><h4><i class="fas fa-wallet"></i> Finanzas (General)</h4><p>Genera un archivo con todos los pagos (honorarios y desplazamientos) de todo el equipo.</p><button class="btn btn-primary" id="btn-download-finanzas-general"><i class="fas fa-file-excel"></i> Descargar</button></div>
                 <div class="report-card"><h4><i class="fas fa-user-tag"></i> Finanzas (Individual)</h4><p>Seleccione una persona para generar un reporte detallado de sus pagos.</p><div><select id="select-finanzas-persona"></select><button class="btn btn-primary" id="btn-download-finanzas-individual" style="width: 100%; margin-top: 1rem;"><i class="fas fa-file-excel"></i> Descargar</button></div></div>
             </div>
        </div>
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-database"></i> Gestión de Datos de la App</h3></div>
            <div class="card-body grid-container">
                <div class="report-card">
                    <h4>Exportar Datos (Backup)</h4>
                    <p>Guarda todo el estado de la aplicación (eventos, equipo, tareas, finanzas) en un archivo .json.</p>
                    <button class="btn btn-primary" id="btn-export-data"><i class="fas fa-file-export"></i> Exportar Backup</button>
                </div>
                <div class="report-card">
                    <h4>Importar Datos (Restaurar)</h4>
                    <p>Carga un archivo de backup (.json) para restaurar el estado de la aplicación. ¡Sobrescribirá los datos actuales!</p>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    <button class="btn btn-danger" onclick="document.getElementById('import-file-input').click();"><i class="fas fa-file-import"></i> Importar Backup</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALES -->
<div id="modal-checklist" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="checklist-title"></h3><div id="checklist-container"></div></div></div>
<div id="modal-miembro" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="modal-miembro-title"></h3><form id="form-miembro"><input type="hidden" id="miembro-id"><div class="form-group"><label for="miembro-nombre">Nombre del Miembro</label><input type="text" id="miembro-nombre" required></div><button type="submit" class="btn btn-primary">Guardar</button></form></div></div>
<div id="modal-evento" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3>Crear Nuevo Evento</h3><form id="form-evento"><div class="form-group"><label for="evento-nombre">Nombre del Evento</label><input type="text" id="evento-nombre" placeholder="Ej: Feria Subregional Popayán" required></div><div class="form-group"><label for="evento-fecha-inicio">Fecha de Inicio</label><input type="date" id="evento-fecha-inicio" required></div><div class="form-group"><label for="evento-fecha-fin">Fecha de Fin</label><input type="date" id="evento-fecha-fin" required></div><div class="form-group"><label for="evento-proyecto-tipo">Tipo de Proyecto</label><input type="text" id="evento-proyecto-tipo" list="proyecto-tipos-list" placeholder="Ej: Ferias, Talleres, Internos" required><datalist id="proyecto-tipos-list"></datalist></div><button type="submit" class="btn btn-primary">Crear Evento</button></form></div></div>
<div id="modal-edit-evento" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="edit-evento-title">Editar Evento</h3><form id="form-edit-evento"><input type="hidden" id="edit-evento-id"><div class="form-group"><label for="edit-evento-nombre">Nombre del Evento</label><input type="text" id="edit-evento-nombre" required></div><div class="form-group"><label for="edit-evento-fecha-inicio">Fecha de Inicio</label><input type="date" id="edit-evento-fecha-inicio" required></div><div class="form-group"><label for="edit-evento-fecha-fin">Fecha de Fin</label><input type="date" id="edit-evento-fecha-fin" required></div><div class="form-group"><label for="edit-evento-proyecto-tipo">Tipo de Proyecto</label><input type="text" id="edit-evento-proyecto-tipo" list="proyecto-tipos-list-edit" required><datalist id="proyecto-tipos-list-edit"></datalist></div><button type="submit" class="btn btn-primary">Guardar Cambios</button></form></div></div>
<div id="modal-responsables" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3>Asignar Responsables</h3><div id="responsables-checkbox-container"></div><div style="text-align: right; margin-top: 1rem;"><button id="btn-save-responsables" class="btn btn-primary">Guardar</button></div></div></div>
<div id="modal-day-tasks" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="day-tasks-title"></h3><ul id="day-tasks-list"></ul></div></div>

<!-- MODAL PARA EDITAR PAGO (AÚN NECESARIO) -->
<div id="modal-edit-pago" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3 id="edit-pago-title">Editar Pago</h3>
        <form id="form-edit-pago">
            <input type="hidden" id="edit-pago-miembro-id">
            <input type="hidden" id="edit-pago-id">
            <input type="hidden" id="edit-pago-tipo">
            <div class="form-group"><label for="edit-pago-concepto">Concepto</label><input type="text" id="edit-pago-concepto" required></div>
            <div class="form-group"><label for="edit-pago-valor">Valor</label><input type="number" id="edit-pago-valor" required></div>
            <div class="form-group"><label for="edit-pago-fechaInicio">Fecha Inicio</label><input type="date" id="edit-pago-fechaInicio" required></div>
            <div class="form-group"><label for="edit-pago-fechaFin">Fecha Fin</label><input type="date" id="edit-pago-fechaFin" required></div>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </form>
    </div>
</div>

<div id="modal-bulk-miembro" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3>Carga Masiva de Miembros de Equipo</h3><p>Introduce un nombre por línea. Cada línea se convertirá en un nuevo miembro del equipo.</p><div class="form-group"><label for="bulk-miembro-names">Nombres de Miembros</label><textarea id="bulk-miembro-names" rows="10" placeholder="Ejemplo:&#10;Juan Pérez&#10;María García&#10;Carlos Ruiz"></textarea></div><button type="submit" class="btn btn-primary" id="btn-save-bulk-miembros">Añadir Miembros</button></div></div>
<div id="modal-descripcion" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="modal-descripcion-title">Descripción del Evento</h3><input type="hidden" id="descripcion-evento-id"><button id="btn-enter-edit-mode" class="btn btn-warning btn-sm" style="position: absolute; top: 1.5rem; right: 4rem;"><i class="fas fa-pencil-alt"></i> Editar</button><div id="descripcion-view-container" class="ql-snow"><div class="ql-editor" style="height: auto; min-height: 300px; max-height: 60vh; overflow-y: auto; background-color: var(--header-bg); border-radius: 5px; padding: 1rem; border: 1px solid var(--border-color);"></div></div><div id="descripcion-editor-container" style="display: none;"><div id="evento-descripcion-editor" style="height: 300px;"></div></div><div id="descripcion-actions-container" style="text-align: right; margin-top: 1.5rem; display: none; gap: 0.5rem;"><button class="btn btn-secondary" id="btn-cancel-descripcion">Cancelar</button><button class="btn btn-primary" id="btn-save-descripcion">Guardar Cambios</button></div></div></div>
<div id="modal-observacion" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="modal-observacion-title">Observaciones de la Tarea</h3><input type="hidden" id="observacion-task-path-eid"><input type="hidden" id="observacion-task-path-f"><input type="hidden" id="observacion-task-path-tid"><input type="hidden" id="observacion-task-path-stid"><button id="btn-enter-observacion-edit-mode" class="btn btn-warning btn-sm" style="position: absolute; top: 1.5rem; right: 4rem;"><i class="fas fa-pencil-alt"></i> Editar</button><div id="observacion-view-container" class="ql-snow"><div class="ql-editor" style="height: auto; min-height: 300px; max-height: 60vh; overflow-y: auto; background-color: var(--header-bg); border-radius: 5px; padding: 1rem; border: 1px solid var(--border-color);"></div></div><div id="observacion-editor-container" style="display: none;"><div id="task-observacion-editor" style="height: 300px;"></div></div><div id="observacion-actions-container" style="text-align: right; margin-top: 1.5rem; display: none; gap: 0.5rem;"><button class="btn btn-secondary" id="btn-cancel-observacion">Cancelar</button><button class="btn btn-primary" id="btn-save-observacion">Guardar Cambios</button></div></div></div>

<!-- NUEVO MODAL PARA TRANSFERIR TAREAS -->
<div id="modal-transfer-task" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3>Transferir Tarea</h3>
        <p>Mover la tarea: <strong id="transfer-task-name"></strong></p>
        <form id="form-transfer-task">
            <input type="hidden" id="transfer-task-path">
            <div class="form-group">
                <label for="transfer-destination-event">Seleccione el evento de destino:</label>
                <select id="transfer-destination-event" required></select>
            </div>
            <button type="submit" class="btn btn-primary"><i class="fas fa-exchange-alt"></i> Transferir Tarea</button>
        </form>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. STATE AND CONFIGURATION ---
        const state = {
            eventos: [],
            equipo: [],
            eventProjectTypes: ['Ferias locales', 'Ferias subregionles', 'Ferias especializadas', 'Rutas', 'Misiones'],
            otros: [],
            settings: { darkMode: false }
        };
        const charts = {};
        const app = {};
        let quillEditor = null;
        let quillObservacionEditor = null;
        let sortableInstance = null;
        let currentCalendarDate = new Date();
        let currentEventProjectTypeFilter = 'all'; 
        app.activeQuillEditors = {};
        const emptyStateMsg = (msg) => `<div class="empty-state">${msg}</div>`;

        const taskTemplate = {
            id: null, texto: 'Nueva Tarea (Editar)', completado: false, 
            responsables: [], fechaInicio: '', fechaFin: '', subtareas: [],
            estado: 'En proceso', observacion: ''
        };

        const checklistTemplate = {
            planeacion: [ { ...taskTemplate, id: 1, texto: 'Definir objetivos y alcance del evento' }, { ...taskTemplate, id: 2, texto: 'Elaborar presupuesto detallado' }, { ...taskTemplate, id: 3, texto: 'Seleccionar y reservar lugar del evento' }, { ...taskTemplate, id: 4, texto: 'Convocar unidades productivas/empresas participantes' }, ],
            ejecucion: [ { ...taskTemplate, id: 5, texto: 'Montaje de stands y logística' }, { ...taskTemplate, id: 6, texto: 'Registro y atención de participantes' }, { ...taskTemplate, id: 7, texto: 'Desarrollo de agenda (charlas, ruedas de negocio)' }, { ...taskTemplate, id: 8, texto: 'Seguimiento y soporte durante el evento' }, ],
            cierre: [ { ...taskTemplate, id: 9, texto: 'Desmontaje y limpieza del lugar' }, { ...taskTemplate, id: 10, texto: 'Recopilar encuestas de satisfacción' }, { ...taskTemplate, id: 11, texto: 'Consolidar base de datos de asistentes/contactos' }, ],
            legalizacion: [ { ...taskTemplate, id: 12, texto: 'Elaborar informe final del evento' }, { ...taskTemplate, id: 13, texto: 'Gestionar pagos a proveedores y personal' }, { ...taskTemplate, id: 14, texto: 'Archivar toda la documentación y soportes' }, ]
        };

        // --- 2. MODALS AND UTILITIES ---
        app.modals = { 
            checklist: document.getElementById('modal-checklist'), 
            miembro: document.getElementById('modal-miembro'), 
            evento: document.getElementById('modal-evento'), 
            editEvento: document.getElementById('modal-edit-evento'), 
            responsables: document.getElementById('modal-responsables'), 
            dayTasks: document.getElementById('modal-day-tasks'), 
            editPago: document.getElementById('modal-edit-pago'), 
            bulkMiembro: document.getElementById('modal-bulk-miembro'), 
            descripcion: document.getElementById('modal-descripcion'),
            observacion: document.getElementById('modal-observacion'),
            transferTask: document.getElementById('modal-transfer-task') // NUEVO MODAL
        };
        app.openModal = (modal) => modal.style.display = 'block';
        app.closeModal = (modal) => modal.style.display = 'none';
        app.getMiembroNombre = (id) => state.equipo.find(m => m.id == id)?.nombre || 'N/A';
        app.getMiembrosNombres = (ids) => ids.map(id => app.getMiembroNombre(id)).join(', ');
        app.getAllTasks = (evento) => { const allTasks = []; if (!evento || !evento.fases) return allTasks; for (const faseName of Object.keys(evento.fases)) { if(Array.isArray(evento.fases[faseName])) { evento.fases[faseName].forEach(task => { allTasks.push({ ...task, eventoNombre: evento.nombre, faseNombre: faseName, nivel: "Tarea Principal", tareaPadre: "" }); if (task.subtareas && Array.isArray(task.subtareas)) { task.subtareas.forEach(subtask => { allTasks.push({ ...subtask, eventoNombre: evento.nombre, faseNombre: faseName, nivel: "Sub-tarea", tareaPadre: task.texto }); }); } }); } } return allTasks; };
        app.getEventProgress = (evento) => { const t = app.getAllTasks(evento); return { total: t.length, completadas: t.filter(x => x.completado).length }; };
        app.getSemaforoColor = (v) => v === 100 ? 'var(--full-color)' : v >= 67 ? 'var(--success-color)' : v >= 34 ? 'var(--warning-color)' : 'var(--danger-color)';
        app.formatCurrency = (value) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value);
        app.formatDateTime = (dt) => dt ? new Date(dt).toLocaleString('es-CO', {hour12: true, year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'}) : 'N/A';
        app.formatDate = (d) => d ? new Date(d + 'T00:00:00').toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';

        // --- 3. DATA PERSISTENCE & CALCULATIONS ---
        
        app.migrateState = (data) => {
            if (!data.eventos) data.eventos = [];
            if (!data.equipo) data.equipo = [];
            if (!data.eventProjectTypes) data.eventProjectTypes = state.eventProjectTypes;
            if (!data.otros) data.otros = [];
            if (!data.settings) data.settings = { darkMode: false };

            data.eventProjectTypes = Array.from(new Set([...state.eventProjectTypes, ...data.eventProjectTypes]));

            data.equipo.forEach(miembro => { if (!miembro.honorarios) miembro.honorarios = []; if (!miembro.desplazamientos) miembro.desplazamientos = []; [...miembro.honorarios, ...miembro.desplazamientos].forEach(pago => { if (pago.fecha && pago.fechaInicio === undefined) { pago.fechaInicio = pago.fecha; pago.fechaFin = pago.fecha; delete pago.fecha; } if (pago.fechaInicio === undefined) pago.fechaInicio = ''; if (pago.fechaFin === undefined) pago.fechaFin = ''; }); });

            data.eventos.forEach((evento, index) => { if (evento.order === undefined) evento.order = index; if (evento.fecha && evento.fechaInicio === undefined) { evento.fechaInicio = evento.fecha; delete evento.fecha; } if (evento.fechaInicio === undefined) evento.fechaInicio = ''; if (evento.fechaFin === undefined) evento.fechaFin = ''; if (evento.category !== undefined && evento.projectType === undefined) { evento.projectType = evento.category; delete evento.category; } if (evento.projectType === undefined) evento.projectType = 'Otros'; if (evento.descripcion === undefined) evento.descripcion = ''; if (!evento.fases) evento.fases = JSON.parse(JSON.stringify(checklistTemplate)); const migrateTask = (tarea) => { if (tarea.responsable && !Array.isArray(tarea.responsables)) { tarea.responsables = tarea.responsable ? [String(tarea.responsable)] : []; delete tarea.responsable; } if (!tarea.responsables) tarea.responsables = []; if (tarea.fecha && !tarea.fechaInicio) { tarea.fechaInicio = tarea.fecha; tarea.fechaFin = ''; delete tarea.fecha; } if (tarea.fechaInicio === undefined) tarea.fechaInicio = ''; if (tarea.fechaFin === undefined) tarea.fechaFin = ''; if (tarea.subtareas === undefined) tarea.subtareas = []; else if (Array.isArray(tarea.subtareas)) tarea.subtareas.forEach(sub => migrateTask(sub)); if (tarea.estado === undefined) tarea.estado = tarea.completado ? 'Completado' : 'En proceso'; if (tarea.observacion === undefined) tarea.observacion = ''; }; if(evento.fases) { Object.values(evento.fases).flat().forEach(task => migrateTask(task)); } });
            data.eventos.sort((a,b) => (a.order || 0) - (b.order || 0)).forEach((e, i) => e.order = i);
            return data;
        };
        
        app.loadState = () => {
            let loadedData = JSON.parse(localStorage.getItem('projectManagementState_v19')) || { 
                equipo: [ { id: Date.now(), nombre: 'Coordinación de Proyecto' }, ...['Andres Felipe Samboni Perez', 'Daniela Alejandra Mera Lopez', 'Daniela Popo Choco', 'Javier Mariano Mera Rivera', 'Jose Sebastian Restrepo Muñoz', 'Juan Diego Aza Arcos', 'José Fernando Ruíz López', 'Luz Elena Laverde Urrea', 'Manuel Vicente Córdoba Martinez', 'María Fernanda Montenegro Mera', 'María Inés Sánchez', 'Sindy Paola Zuñiga Arrechea'].map((nombre, i) => ({ id: Date.now() + i + 1, nombre })) ], 
                eventos: [], 
                eventProjectTypes: state.eventProjectTypes,
                otros: [],
                settings: { darkMode: false }
            };
            const migratedState = app.migrateState(loadedData);
            Object.assign(state, migratedState);
            app.toggleDarkMode(state.settings.darkMode, false); // Aplicar tema al cargar
        };

        app.saveState = () => localStorage.setItem('projectManagementState_v19', JSON.stringify(state)); 

        app.calculateAnalytics = () => { let totalTasks = 0, completedTasks = 0; const progressByEvent = { labels: [], data: [] }; const performanceByPerson = {}; state.equipo.forEach(m => performanceByPerson[m.id] = { name: m.nombre, completed: 0, total: 0 }); state.eventos.forEach(e => { const { total, completadas } = app.getEventProgress(e); totalTasks += total; completedTasks += completadas; progressByEvent.labels.push(e.nombre); progressByEvent.data.push(total > 0 ? (completadas / total) * 100 : 0); app.getAllTasks(e).forEach(t => { t.responsables.forEach(rId => { if (performanceByPerson[rId]) { performanceByPerson[rId].total++; if (t.completado) performanceByPerson[rId].completed++; } }); }); }); return { general: { completado: completedTasks, pendiente: totalTasks - completedTasks }, byEvent: progressByEvent, byPerson: { labels: Object.values(performanceByPerson).map(p => p.name), completadas: Object.values(performanceByPerson).map(p => p.completed), pendientes: Object.values(performanceByPerson).map(p => p.total - p.completed) } }; };


        // --- 4. RENDER FUNCTIONS (VIEWS) ---
        app.render = () => { app.renderCharts(); app.renderProjectTabs(); app.renderEventGrid(currentEventProjectTypeFilter); app.renderEquipoTable(); app.renderCalendar(); app.renderFinanzasTable(); app.renderReportOptions(); app.renderOtrosModule(); };
        
        // ---- FUNCIÓN DE GRÁFICOS CORREGIDA ----
        app.renderCharts = () => {
            const data = app.calculateAnalytics();
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-color');
            const borderColor = getComputedStyle(document.body).getPropertyValue('--border-color');

            // Colores fijos, no cambian con el modo oscuro
            const greenColor = '#28a745';
            const redColor = '#dc3545';
            const blueColor = '#003366';

            if (charts.general) charts.general.destroy();
            charts.general = new Chart(document.getElementById('generalChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Completado', 'Pendiente'],
                    datasets: [{
                        data: [data.general.completado, data.general.pendiente],
                        backgroundColor: [greenColor, redColor]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: textColor } } }
                }
            });

            if (charts.eventos) charts.eventos.destroy();
            const eventData = state.eventos.slice().sort((a, b) => (a.order || 0) - (b.order || 0)).map(e => {
                const { total, completadas } = app.getEventProgress(e);
                return { label: e.nombre, value: total > 0 ? (completadas / total) * 100 : 0 };
            });
            charts.eventos = new Chart(document.getElementById('eventosChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: eventData.map(e => e.label),
                    datasets: [{
                        label: 'Avance (%)',
                        data: eventData.map(e => e.value),
                        backgroundColor: blueColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { color: textColor }, grid: { color: borderColor } },
                        x: { ticks: { color: textColor }, grid: { color: borderColor } }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            if (charts.personas) charts.personas.destroy();
            charts.personas = new Chart(document.getElementById('personasChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.byPerson.labels,
                    datasets: [{
                        label: 'Completadas',
                        data: data.byPerson.completadas,
                        backgroundColor: greenColor
                    }, {
                        label: 'Pendientes',
                        data: data.byPerson.pendientes,
                        backgroundColor: redColor
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true, ticks: { color: textColor }, grid: { color: borderColor } },
                        y: { stacked: true, ticks: { color: textColor }, grid: { color: borderColor } }
                    },
                    plugins: { legend: { position: 'top', labels: { color: textColor } } }
                }
            });
        };
        // ---- FIN DE LA CORRECCIÓN ----

        app.renderProjectTabs = () => { const projectTypeNav = document.getElementById('event-project-type-nav'); const projectTypeListCreate = document.getElementById('proyecto-tipos-list'); const projectTypeListEdit = document.getElementById('proyecto-tipos-list-edit'); projectTypeNav.innerHTML = ''; projectTypeListCreate.innerHTML = ''; projectTypeListEdit.innerHTML = ''; const existingProjectTypes = new Set(state.eventos.map(e => e.projectType).filter(Boolean)); const allProjectTypes = Array.from(new Set([...state.eventProjectTypes, ...existingProjectTypes])).sort(); const allBtn = document.createElement('button'); allBtn.className = `project-type-tab-link ${currentEventProjectTypeFilter === 'all' ? 'active' : ''}`; allBtn.dataset.projectType = 'all'; allBtn.textContent = 'Todos'; allBtn.addEventListener('click', () => { currentEventProjectTypeFilter = 'all'; app.renderEventGrid(currentEventProjectTypeFilter); app.renderProjectTabs(); }); projectTypeNav.appendChild(allBtn); allProjectTypes.forEach(projectType => { const btn = document.createElement('button'); btn.className = `project-type-tab-link ${currentEventProjectTypeFilter === projectType ? 'active' : ''}`; btn.dataset.projectType = projectType; btn.textContent = projectType; btn.addEventListener('click', () => { currentEventProjectTypeFilter = projectType; app.renderEventGrid(currentEventProjectTypeFilter); app.renderProjectTabs(); }); projectTypeNav.appendChild(btn); const optionCreate = document.createElement('option'); optionCreate.value = projectType; projectTypeListCreate.appendChild(optionCreate); const optionEdit = document.createElement('option'); optionEdit.value = projectType; projectTypeListEdit.appendChild(optionEdit); }); };
        app.renderEventGrid = (projectTypeFilter = 'all') => { const container = document.getElementById('event-grid-container'); let filteredEvents = projectTypeFilter === 'all' ? state.eventos : state.eventos.filter(e => e.projectType === projectTypeFilter); filteredEvents.sort((a, b) => (a.order || 0) - (b.order || 0)); if (filteredEvents.length === 0) { let msg = `No hay eventos en el tipo de proyecto "${projectTypeFilter}".`; if (projectTypeFilter === 'all' && state.eventos.length === 0) { msg = "No hay eventos creados. ¡Crea el primero para empezar!"; } container.innerHTML = emptyStateMsg(msg); return; } container.innerHTML = ''; filteredEvents.forEach(evento => { const { total, completadas } = app.getEventProgress(evento); const avance = total > 0 ? Math.round((completadas / total) * 100) : 0; const card = document.createElement('div'); card.className = 'event-card-item'; card.dataset.eventId = evento.id; card.innerHTML = ` <div class="event-card-item-header"> <h4 onclick="app.handleEditEventNameClick(this, '${evento.id}')" title="Haz clic para editar">${evento.nombre}</h4> <button class="btn btn-danger btn-sm" onclick="app.handleDeleteEvento('${evento.id}')"><i class="fas fa-trash"></i></button> </div> <div class="event-card-item-body"> <div class="event-card-progress"> <div class="progress-chart-container"> <canvas id="progress-${evento.id}"></canvas> <div class="progress-chart-text" style="color:${app.getSemaforoColor(avance)};">${avance}%</div> </div> <div class="event-card-info"> <strong>Fecha Inicio:</strong> ${app.formatDate(evento.fechaInicio)}<br> <strong>Fecha Fin:</strong> ${app.formatDate(evento.fechaFin)}<br> <strong>Tipo de Proyecto:</strong> ${evento.projectType || 'N/A'}<br> <strong>Tareas:</strong> ${completadas}/${total} </div> </div> </div> <div class="event-card-item-footer"> <button class="btn btn-secondary" onclick="app.openDescripcionModal('${evento.id}')"><i class="fas fa-file-alt"></i> Descripción</button> <button class="btn btn-edit-details" onclick="app.handleEditEventDetails('${evento.id}')"><i class="fas fa-info-circle"></i> Detalles</button> <button class="btn btn-manage" onclick="app.renderChecklistModal('${evento.id}')"><i class="fas fa-edit"></i> Tareas</button> </div>`; container.appendChild(card); new Chart(document.getElementById(`progress-${evento.id}`), { type: 'doughnut', data: { datasets: [{ data: [avance, 100 - avance], backgroundColor: [app.getSemaforoColor(avance), '#e9ecef'], borderWidth: 0 }] }, options: { cutout: '70%', plugins: { tooltip: { enabled: false } } } }); }); if (sortableInstance) sortableInstance.destroy(); sortableInstance = new Sortable(container, { animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', onEnd: (evt) => { const newIdOrder = Array.from(evt.to.children).map(card => card.dataset.eventId); newIdOrder.forEach((id, index) => { const evento = state.eventos.find(e => e.id === id); if(evento) evento.order = index; }); let maxVisibleOrder = newIdOrder.length; state.eventos .filter(e => !newIdOrder.includes(e.id)) .sort((a,b) => (a.order || 0) - (b.order || 0)) .forEach(e => { e.order = maxVisibleOrder++; }); app.saveState(); app.renderCharts(); } }); };
        app.renderEquipoTable = () => { const container = document.getElementById('equipo-table-container'); const tbody = document.getElementById('tabla-equipo').querySelector('tbody'); if (state.equipo.length === 0) { container.innerHTML = emptyStateMsg("No hay miembros en el equipo. Añade el primero."); tbody.innerHTML = ''; return; } container.querySelector('table').style.display = ''; tbody.innerHTML = ''; state.equipo.forEach(miembro => { const tareasAsignadas = state.eventos.flatMap(e => app.getAllTasks(e)).filter(t => t.responsables.includes(String(miembro.id))).length; tbody.innerHTML += `<tr><td>${miembro.nombre}</td><td>${tareasAsignadas}</td><td class="actions"><button class="btn btn-sm btn-warning" onclick="app.handleEditMiembro(${miembro.id})"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="app.handleDeleteMiembro(${miembro.id})"><i class="fas fa-trash"></i></button></td></tr>`; }); };
        app.renderFinanzasTable = () => { const container = document.getElementById('finanzas-table-container'); const tbody = document.getElementById('tabla-finanzas').querySelector('tbody'); if (state.equipo.length === 0) { container.innerHTML = emptyStateMsg("No hay miembros de equipo para gestionar finanzas."); tbody.innerHTML = ''; return; } container.querySelector('table').style.display = ''; tbody.innerHTML = ''; state.equipo.forEach(miembro => { const totalHonorarios = (miembro.honorarios || []).reduce((sum, p) => sum + (Number(p.valor) || 0), 0); const totalDesplazamientos = (miembro.desplazamientos || []).reduce((sum, p) => sum + (Number(p.valor) || 0), 0); tbody.innerHTML += `<tr><td>${miembro.nombre}</td><td>${app.formatCurrency(totalHonorarios)}</td><td>${app.formatCurrency(totalDesplazamientos)}</td><td class="actions"><button class="btn btn-sm btn-primary" onclick="app.showFinanzasDetailView(${miembro.id})"><i class="fas fa-search-dollar"></i> Gestionar Pagos</button></td></tr>`; }); };
        app.renderChecklistModal = (eventoId) => { const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; document.getElementById('checklist-title').textContent = `Gestionar Tareas de: ${evento.nombre}`; const container = document.getElementById('checklist-container'); container.innerHTML = ''; const statusOptions = ['En proceso', 'Aplazado', 'Atrasado', 'Cancelado']; const createTaskHtml = (tarea, tipo, path) => { const { eId, f, tId, stId } = path; const isSubtask = tipo === 'subtask'; const cardClass = isSubtask ? 'task-card subtask-card' : 'task-card'; const tieneResponsables = tarea.responsables && tarea.responsables.length > 0; const onToggle = isSubtask ? `app.handleToggleSubtask('${eId}', '${f}', '${tId}', '${stId}')` : `app.handleToggleTask('${eId}', '${f}', '${tId}')`; const onEditText = isSubtask ? `app.handleEditSubtaskText(this, '${eId}', '${f}', '${tId}', '${stId}')` : `app.handleEditTaskText(this, '${eId}', '${f}', '${tId}')`; const onEditDate = isSubtask ? `app.handleEditSubtaskDate('${eId}', '${f}', '${tId}', '${stId}', arguments[0], this.value)` : `app.handleEditTaskDate('${eId}', '${f}', '${tId}', arguments[0], this.value)`; const openRespModal = isSubtask ? `app.openResponsablesModalForSubtask('${eId}', '${f}', '${tId}', '${stId}')` : `app.openResponsablesModalForTask('${eId}', '${f}', '${tId}')`; const onDelete = isSubtask ? `app.handleDeleteSubtask('${eId}', '${f}', '${tId}', '${stId}')` : `app.handleDeleteTask('${eId}', '${f}', '${tId}')`; const onUpdateStatus = isSubtask ? `app.handleUpdateSubtaskStatus('${eId}', '${f}', '${tId}', '${stId}', this.value)` : `app.handleUpdateTaskStatus('${eId}', '${f}', '${tId}', this.value)`; const openObsModal = isSubtask ? `app.openObservacionModal('${eId}', '${f}', '${tId}', '${stId}')` : `app.openObservacionModal('${eId}', '${f}', '${tId}')`; const openTransferModal = isSubtask ? `app.openTransferModal('${eId}', '${f}', '${tId}', '${stId}')` : `app.openTransferModal('${eId}', '${f}', '${tId}')`; let estadoElemento; const estadoNormalizado = tarea.estado.replace(/\s+/g, '-'); if (tarea.completado) { estadoElemento = `<span class="status-badge status-Completado">Completado</span>`; } else { estadoElemento = `<div class="status-badge-container"><span class="status-badge status-${estadoNormalizado}" onclick="this.style.display='none'; this.nextElementSibling.style.display='inline-block'; this.nextElementSibling.focus();">${tarea.estado}</span><select class="status-select" style="display:none;" onchange="${onUpdateStatus}" onblur="this.style.display='none'; this.previousElementSibling.style.display='inline-block';">${statusOptions.map(s => `<option value="${s.toLowerCase().replace(/\s+/g, '-')}" ${tarea.estado === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`; } let taskHtml = `<div class="${cardClass} ${tarea.completado ? 'completed' : ''}" data-task-id="${isSubtask ? stId : tId}"><div class="task-main-line"><input type="checkbox" onchange="${onToggle}" ${tarea.completado ? 'checked' : ''}><div class="task-description"><input type="text" value="${tarea.texto.replace(/"/g, '&quot;')}" onchange="${onEditText}" onblur="${onEditText}"></div><div class="task-actions">${!isSubtask ? `<button class="icon-btn" title="Añadir Sub-tarea" onclick="app.handleAddSubtask('${eId}', '${f}', '${tId}')"><i class="fas fa-plus-circle"></i></button>` : ''}<button class="icon-btn" title="Transferir Tarea" onclick="${openTransferModal}"><i class="fas fa-exchange-alt"></i></button><button class="icon-btn" title="Observaciones" onclick="${openObsModal}"><i class="fas fa-comment-dots"></i></button><button class="icon-btn" title="Eliminar Tarea" onclick="${onDelete}"><i class="fas fa-trash-alt" style="color:var(--danger-color)"></i></button></div></div><div class="task-details"><div class="task-detail-item"><label>Estado:</label>${estadoElemento}</div><div class="task-detail-item"><label><i class="fas fa-calendar-alt"></i></label><input type="datetime-local" value="${tarea.fechaInicio || ''}" onchange="${onEditDate.replace('arguments[0]', "'fechaInicio'")}"><span style="margin:0 0.25rem;">-</span><input type="datetime-local" value="${tarea.fechaFin || ''}" onchange="${onEditDate.replace('arguments[0]', "'fechaFin'")}'></div><div class="task-detail-item"><label><i class="fas fa-user"></i></label><div class="responsables-display" title="${app.getMiembrosNombres(tarea.responsables)}">${app.getMiembrosNombres(tarea.responsables) || 'Sin asignar'}</div><button class="btn btn-sm ${tieneResponsables ? 'btn-success' : 'btn-secondary'}" onclick="${openRespModal}">${tieneResponsables ? 'Asignado' : 'Asignar'}</button></div></div></div>`; if (!isSubtask && tarea.subtareas && tarea.subtareas.length > 0) { taskHtml += `<div class="subtasks-container">`; tarea.subtareas.forEach(subtarea => { taskHtml += createTaskHtml(subtarea, 'subtask', {eId, f, tId, stId: subtarea.id}); }); taskHtml += `</div>`; } return taskHtml; }; for (const [fase, tareas] of Object.entries(evento.fases)) { let faseHtml = `<div class="checklist-phase" data-fase-id="${fase}"><h4>${fase.charAt(0).toUpperCase() + fase.slice(1)}</h4><div id="task-list-${fase}">`; if(Array.isArray(tareas)) { tareas.forEach(tarea => { faseHtml += createTaskHtml(tarea, 'task', {eId: evento.id, f: fase, tId: tarea.id}); }); } faseHtml += `</div><div class="add-task-btn-container"><button class="btn btn-add-task btn-sm" onclick="app.handleAddTask('${evento.id}', '${fase}')"><i class="fas fa-plus"></i> Añadir Tarea a ${fase}</button></div></div>`; container.innerHTML += faseHtml; } app.openModal(app.modals.checklist); };
        app.renderCalendar = () => { const grid = document.getElementById('calendar-grid'); const monthYearEl = document.getElementById('calendar-month-year'); grid.innerHTML = ''; const year = currentCalendarDate.getFullYear(); const month = currentCalendarDate.getMonth(); monthYearEl.textContent = `${currentCalendarDate.toLocaleString('es-ES', { month: 'long' })} ${year}`.toUpperCase(); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const tasksByDate = {}; const eventsStartingByDate = {}; state.eventos.forEach(evento => { const eventStartDate = evento.fechaInicio ? new Date(evento.fechaInicio.split('T')[0] + 'T00:00:00') : null; if (eventStartDate && !isNaN(eventStartDate.getTime()) && eventStartDate.getFullYear() === year && eventStartDate.getMonth() === month) { const datePart = eventStartDate.toISOString().split('T')[0]; if (!eventsStartingByDate[datePart]) eventsStartingByDate[datePart] = []; eventsStartingByDate[datePart].push(evento); } app.getAllTasks(evento).forEach(tarea => { const startDate = tarea.fechaInicio ? new Date(tarea.fechaInicio.split('T')[0] + 'T00:00:00') : null; const endDate = tarea.fechaFin ? new Date(tarea.fechaFin.split('T')[0] + 'T00:00:00') : null; if (startDate && !isNaN(startDate.getTime())) { let currentDatePointer = new Date(startDate); const endBoundary = endDate && !isNaN(endDate.getTime()) ? endDate.getTime() : startDate.getTime(); while (currentDatePointer.getTime() <= endBoundary) { if (currentDatePointer.getFullYear() === year && currentDatePointer.getMonth() === month) { const datePart = currentDatePointer.toISOString().split('T')[0]; if (!tasksByDate[datePart]) tasksByDate[datePart] = []; tasksByDate[datePart].push(tarea); } currentDatePointer.setDate(currentDatePointer.getDate() + 1); } } }); }); for (let i = 0; i < firstDay; i++) { grid.innerHTML += `<div class="calendar-day other-month"></div>`; } for (let day = 1; day <= daysInMonth; day++) { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const dayEl = document.createElement('div'); dayEl.className = 'calendar-day'; dayEl.innerHTML = `<div class="day-number">${day}</div>`; const isEventStartDate = eventsStartingByDate[dateStr] && eventsStartingByDate[dateStr].length > 0; const hasTasks = tasksByDate[dateStr] && tasksByDate[dateStr].length > 0; if (isEventStartDate) dayEl.classList.add('event-start-day'); if (hasTasks) { dayEl.classList.add('has-tasks'); dayEl.innerHTML += `<div class="day-tasks-badge">${tasksByDate[dateStr].length}</div>`; } if (hasTasks || isEventStartDate) { dayEl.style.cursor = 'pointer'; dayEl.onclick = () => app.showDayDetails(dateStr, tasksByDate[dateStr] || [], eventsStartingByDate[dateStr] || []); } grid.appendChild(dayEl); } };
        app.renderReportOptions = () => { const select = document.getElementById('select-finanzas-persona'); if (!select) return; select.innerHTML = '<option value="">-- Seleccione una persona --</option>'; state.equipo.forEach(miembro => { select.innerHTML += `<option value="${miembro.id}">${miembro.nombre}</option>`; }); };
        app.renderOtrosModule = () => { const container = document.getElementById('otros-container'); if (!container) return; container.innerHTML = ''; if (state.otros.length === 0) { container.innerHTML = emptyStateMsg("No hay listas de contenido. ¡Añade la primera!"); return; } state.otros.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'otro-item'; itemEl.dataset.id = item.id; itemEl.innerHTML = ` <div class="otro-header" onclick="app.toggleOtroItem(this)"> <h4 onclick="event.stopPropagation(); app.editOtroItemTitle(this, '${item.id}')">${item.title}</h4> <div class="task-actions"> <button class="icon-btn toggle-icon" title="Expandir/Contraer"><i class="fas fa-chevron-down"></i></button> <button class="icon-btn" title="Eliminar lista" onclick="event.stopPropagation(); app.deleteOtroItem('${item.id}')"><i class="fas fa-trash-alt" style="color:var(--danger-color)"></i></button> </div> </div> <div class="otro-content"> <div id="otro-editor-${item.id}"></div> </div> `; container.appendChild(itemEl); }); };
        
        // --- 5. EVENT HANDLERS (CONTROLLERS) ---
        app.toggleDarkMode = (forceDark, save = true) => { const body = document.body; const toggleButton = document.getElementById('dark-mode-toggle'); const isDark = typeof forceDark === 'boolean' ? forceDark : !body.classList.contains('dark-mode'); body.classList.toggle('dark-mode', isDark); toggleButton.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; if (save) { state.settings.darkMode = isDark; app.saveState(); } app.renderCharts(); };
        app.handleTabClick = (e) => { document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active')); e.currentTarget.classList.add('active'); document.getElementById(e.currentTarget.dataset.tab).classList.add('active'); app.render(); };
        app.handleAddTask = (eId, f) => { state.eventos.find(e => e.id === eId).fases[f].push({ ...taskTemplate, id: Date.now() }); app.saveState(); app.renderChecklistModal(eId); };
        app.handleDeleteTask = (eId, f, tId) => { if(confirm('¿Seguro que desea eliminar esta tarea y todas sus sub-tareas?')) { const e = state.eventos.find(x => x.id === eId); e.fases[f] = e.fases[f].filter(t => t.id != tId); app.saveState(); app.render(); app.renderChecklistModal(eId); } };
        app.handleToggleTask = (eId, f, tId) => { const task = state.eventos.find(e => e.id === eId).fases[f].find(x => x.id == tId); task.completado = !task.completado; task.estado = task.completado ? 'Completado' : 'En proceso'; if (task.subtareas && Array.isArray(task.subtareas)) { task.subtareas.forEach(subtask => {subtask.completado = task.completado; subtask.estado = subtask.completado ? 'Completado' : 'En proceso';}); } app.saveState(); app.render(); app.renderChecklistModal(eId); };
        app.handleEditTaskText = (input, eId, f, tId) => { state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).texto = input.value; app.saveState(); };
        app.handleEditTaskDate = (eId, f, tId, tipoFecha, date) => { state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId)[tipoFecha] = date; app.saveState(); app.render(); };
        app.handleAddSubtask = (eId, f, tId) => { const parentTask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId); if (!parentTask.subtareas) parentTask.subtareas = []; parentTask.subtareas.push({ ...taskTemplate, id: Date.now(), texto: 'Nueva Sub-tarea (Editar)' }); app.saveState(); app.renderChecklistModal(eId); };
        app.handleDeleteSubtask = (eId, f, tId, stId) => { if(confirm('¿Seguro que desea eliminar esta sub-tarea?')) { const parentTask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId); parentTask.subtareas = parentTask.subtareas.filter(st => st.id != stId); app.saveState(); app.render(); app.renderChecklistModal(eId); } };
        app.handleToggleSubtask = (eId, f, tId, stId) => { const subtask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId); subtask.completado = !subtask.completado; subtask.estado = subtask.completado ? 'Completado' : 'En proceso'; app.saveState(); app.render(); app.renderChecklistModal(eId); };
        app.handleEditSubtaskText = (input, eId, f, tId, stId) => { state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId).texto = input.value; app.saveState(); };
        app.handleEditSubtaskDate = (eId, f, tId, stId, tipoFecha, date) => { state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId)[tipoFecha] = date; app.saveState(); app.render(); };
        app.openResponsablesModalForTask = (eId, f, tId) => { const tarea = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId); const container = document.getElementById('responsables-checkbox-container'); container.innerHTML = state.equipo.map(m => `<div class="responsable-option"><label><input type="checkbox" value="${m.id}" ${tarea.responsables.includes(String(m.id)) ? 'checked' : ''}>${m.nombre}</label></div>`).join(''); document.getElementById('btn-save-responsables').onclick = () => app.handleSaveResponsablesForTask(eId, f, tId); app.openModal(app.modals.responsables); };
        app.handleSaveResponsablesForTask = (eId, f, tId) => { const nuevosResponsables = []; document.querySelectorAll('#responsables-checkbox-container input:checked').forEach(checkbox => {nuevosResponsables.push(checkbox.value);}); state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).responsables = nuevosResponsables; app.saveState(); app.render(); app.renderChecklistModal(eId); app.closeModal(app.modals.responsables); };
        app.openResponsablesModalForSubtask = (eId, f, tId, stId) => { const subtask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId); const container = document.getElementById('responsables-checkbox-container'); container.innerHTML = state.equipo.map(m => `<div class="responsable-option"><label><input type="checkbox" value="${m.id}" ${subtask.responsables.includes(String(m.id)) ? 'checked' : ''}>${m.nombre}</label></div>`).join(''); document.getElementById('btn-save-responsables').onclick = () => app.handleSaveResponsablesForSubtask(eId, f, tId, stId); app.openModal(app.modals.responsables); };
        app.handleSaveResponsablesForSubtask = (eId, f, tId, stId) => { const nuevosResponsables = []; document.querySelectorAll('#responsables-checkbox-container input:checked').forEach(checkbox => {nuevosResponsables.push(checkbox.value);}); state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId).responsables = nuevosResponsables; app.saveState(); app.render(); app.renderChecklistModal(eId); app.closeModal(app.modals.responsables); };
        app.handleEditEventNameClick = (h4Element, eventoId) => {const originalName = h4Element.textContent.trim();h4Element.innerHTML = ''; const input = document.createElement('input');input.type = 'text';input.value = originalName;input.className = 'inline-edit-input';const save = () => {const newName = input.value.trim();if (newName && newName !== originalName) {app.handleSaveEventName(eventoId, newName);} else {h4Element.textContent = originalName;}};input.addEventListener('blur', save);input.addEventListener('keydown', (e) => {if (e.key === 'Enter') {input.blur();} else if (e.key === 'Escape') {h4Element.textContent = originalName; h4Element.focus();}});h4Element.appendChild(input);input.focus();input.select();};
        app.handleSaveEventName = (eventoId, newName) => {const evento = state.eventos.find(e => e.id === eventoId);if (evento) {evento.nombre = newName;app.saveState();app.render();}};
        app.handleDeleteEvento = (id) => { if(confirm('¿Seguro que desea eliminar este evento?')) { state.eventos = state.eventos.filter(e => e.id !== id); state.eventos.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach((evento, index) => { evento.order = index; }); app.saveState(); app.render(); } };
        app.handleEditMiembro = (id) => { const m = state.equipo.find(x => x.id === id); document.getElementById('miembro-id').value = m.id; document.getElementById('miembro-nombre').value = m.nombre; document.getElementById('modal-miembro-title').innerText = 'Editar Miembro'; app.openModal(app.modals.miembro); };
        app.handleDeleteMiembro = (id) => { if(confirm('¿Está seguro? Las tareas y pagos asignados a esta persona se eliminarán.')) { state.equipo = state.equipo.filter(m => m.id !== id); state.eventos.forEach(e => app.getAllTasks(e).forEach(t => { t.responsables = t.responsables.filter(rId => rId != id); })); app.saveState(); app.render(); } };
        app.showDayDetails = (dateStr, tasks, events) => { const dateObj = new Date(dateStr + 'T00:00:00'); document.getElementById('day-tasks-title').textContent = `Detalle del Día: ${dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`; const listEl = document.getElementById('day-tasks-list'); let contentHtml = ''; if (events && events.length > 0) { contentHtml += `<h4 style="color: var(--danger-color); margin-bottom: 0.5rem;"><i class="fas fa-play-circle"></i> Eventos que inician este día:</h4><ul style="list-style: none; padding: 0;">`; events.forEach(event => { contentHtml += `<li><strong>${event.nombre}</strong><br><small><em>Tipo:</em> ${event.projectType || 'N/A'}</small><br><small><em>Inicio:</em> ${app.formatDate(event.fechaInicio)} | <em>Fin:</em> ${app.formatDate(event.fechaFin)}</small></li>`; }); contentHtml += `</ul>`; if (tasks && tasks.length > 0) { contentHtml += `<hr style="margin: 1.5rem 0; border-top: 1px dashed var(--border-color);">`; } } if (tasks && tasks.length > 0) { contentHtml += `<h4 style="color: var(--primary-color); margin-bottom: 0.5rem;"><i class="fas fa-tasks"></i> Tareas asignadas para este día:</h4><ul style="list-style: none; padding: 0;">`; tasks.forEach(t => { let taskTitle = t.texto; let indentStyle = ''; if (t.nivel === "Sub-tarea") { taskTitle = `&nbsp;&nbsp;&nbsp;<i class="fas fa-indent"></i> ${t.texto}`; indentStyle = 'padding-left: 20px;'; } contentHtml += `<li style="${indentStyle}"><strong>${taskTitle}</strong><br><small><em>Evento:</em> ${t.eventoNombre}</small><br>`; if (t.nivel === "Sub-tarea" && t.tareaPadre) { contentHtml += `<small><em>Tarea Padre:</em> ${t.tareaPadre}</small><br>`; } contentHtml += `<small><em>Fase:</em> ${t.faseNombre}</small><br><small><em>Inicio:</em> ${app.formatDateTime(t.fechaInicio)} | <em>Fin:</em> ${app.formatDateTime(t.fechaFin)}</small><br><small><em>Responsables:</em> ${app.getMiembrosNombres(t.responsables) || 'Sin asignar'}</small></li>`; }); contentHtml += `</ul>`; } else if (!events || events.length === 0) { contentHtml += `<p style="text-align: center; color: var(--light-text-color); padding: 1.5rem 0;">No hay eventos que inicien ni tareas asignadas para este día.</p>`; } listEl.innerHTML = contentHtml; app.openModal(app.modals.dayTasks); };
        
        // --- HANDLERS MEJORADOS PARA FINANZAS ---
        app.showFinanzasMainView = () => { document.getElementById('finanzas-main-view').style.display = 'block'; document.getElementById('finanzas-detail-view').style.display = 'none'; app.renderFinanzasTable(); };
        app.showFinanzasDetailView = (miembroId) => { document.getElementById('finanzas-main-view').style.display = 'none'; const detailView = document.getElementById('finanzas-detail-view'); detailView.style.display = 'block'; app.renderFinanzasDetail(miembroId); };
        app.renderFinanzasDetail = (miembroId) => { const miembro = state.equipo.find(m => m.id === miembroId); const detailView = document.getElementById('finanzas-detail-view'); if (!miembro) { detailView.innerHTML = `<p>Error: Miembro no encontrado.</p>`; return; } const renderPagosListHTML = (tipo) => { const pagos = miembro[tipo] || []; if (pagos.length === 0) return emptyStateMsg(`No hay pagos de ${tipo} registrados.`); return `<div class="finanzas-pagos-list">` + pagos.map(p => `<div class="finanzas-pago-item" data-pago-id="${p.id}"><span>${p.concepto || 'Sin concepto'}</span><span>${app.formatDate(p.fechaInicio)} al ${app.formatDate(p.fechaFin)}</span><span>${app.formatCurrency(p.valor)}</span><div class="finanzas-pago-actions"><button class="btn btn-warning btn-sm" onclick="app.handleEditPago(${miembro.id}, '${tipo}', ${p.id})"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" onclick="app.handleDeletePago(${miembro.id}, '${tipo}', ${p.id})"><i class="fas fa-trash"></i></button></div></div>`).join('') + `</div>`; }; detailView.innerHTML = ` <div class="card"> <div class="card-header"> <h3><i class="fas fa-user-circle"></i> Gestión de Pagos: ${miembro.nombre}</h3> <button class="btn btn-secondary" onclick="app.showFinanzasMainView()"><i class="fas fa-arrow-left"></i> Volver a la lista</button> </div> <div class="card-body"> <div class="finanzas-detail-grid"> <!-- Columna Honorarios --> <div class="card"> <div class="card-header"><h4><i class="fas fa-file-invoice-dollar"></i> Honorarios</h4></div> <div class="card-body"> ${renderPagosListHTML('honorarios')} <form class="finanzas-add-pago-form" onsubmit="event.preventDefault(); app.handleAddPago(${miembro.id}, 'honorarios');"> <div class="form-group"><label>Concepto</label><input type="text" id="honorario-concepto-${miembro.id}" required></div> <div class="form-group"><label>Valor</label><input type="number" id="honorario-valor-${miembro.id}" required></div> <div class="form-group"><label>Fecha Inicio</label><input type="date" id="honorario-fechaInicio-${miembro.id}" required></div> <div class="form-group"><label>Fecha Fin</label><input type="date" id="honorario-fechaFin-${miembro.id}" required></div> <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Añadir Honorario</button> </form> </div> </div> <!-- Columna Desplazamientos --> <div class="card"> <div class="card-header"><h4><i class="fas fa-route"></i> Desplazamientos</h4></div> <div class="card-body"> ${renderPagosListHTML('desplazamientos')} <form class="finanzas-add-pago-form" onsubmit="event.preventDefault(); app.handleAddPago(${miembro.id}, 'desplazamientos');"> <div class="form-group"><label>Concepto</label><input type="text" id="desplazamiento-concepto-${miembro.id}" required></div> <div class="form-group"><label>Valor</label><input type="number" id="desplazamiento-valor-${miembro.id}" required></div> <div class="form-group"><label>Fecha Inicio</label><input type="date" id="desplazamiento-fechaInicio-${miembro.id}" required></div> <div class="form-group"><label>Fecha Fin</label><input type="date" id="desplazamiento-fechaFin-${miembro.id}" required></div> <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Añadir Desplazamiento</button> </form> </div> </div> </div> </div> </div> `; };
        app.handleAddPago = (miembroId, tipo) => { const miembro = state.equipo.find(m => m.id === miembroId); const tipoSingular = tipo.slice(0, -1); const concepto = document.getElementById(`${tipoSingular}-concepto-${miembroId}`).value; const valor = document.getElementById(`${tipoSingular}-valor-${miembroId}`).value; const fechaInicio = document.getElementById(`${tipoSingular}-fechaInicio-${miembroId}`).value; const fechaFin = document.getElementById(`${tipoSingular}-fechaFin-${miembroId}`).value; if (!concepto || !valor || !fechaInicio || !fechaFin) { alert('Todos los campos son obligatorios.'); return; } if (new Date(fechaFin) < new Date(fechaInicio)) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; } if(!miembro[tipo]) miembro[tipo] = []; miembro[tipo].push({ id: Date.now(), concepto, valor: parseFloat(valor), fechaInicio, fechaFin }); app.saveState(); app.renderFinanzasDetail(miembroId); };
        app.handleDeletePago = (miembroId, tipo, pagoId) => { const miembro = state.equipo.find(m => m.id === miembroId); miembro[tipo] = miembro[tipo].filter(p => p.id !== pagoId); app.saveState(); app.renderFinanzasDetail(miembroId); };
        app.handleEditPago = (miembroId, tipo, pagoId) => { const miembro = state.equipo.find(m => m.id === miembroId); const pago = (miembro[tipo] || []).find(p => p.id === pagoId); if (!pago) return; document.getElementById('edit-pago-miembro-id').value = miembroId; document.getElementById('edit-pago-id').value = pago.id; document.getElementById('edit-pago-tipo').value = tipo; document.getElementById('edit-pago-concepto').value = pago.concepto; document.getElementById('edit-pago-valor').value = pago.valor; document.getElementById('edit-pago-fechaInicio').value = pago.fechaInicio; document.getElementById('edit-pago-fechaFin').value = pago.fechaFin; app.openModal(app.modals.editPago); };

        app.handleEditEventDetails = (eventoId) => { const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; document.getElementById('edit-evento-id').value = evento.id; document.getElementById('edit-evento-nombre').value = evento.nombre; document.getElementById('edit-evento-fecha-inicio').value = evento.fechaInicio; document.getElementById('edit-evento-fecha-fin').value = evento.fechaFin; document.getElementById('edit-evento-proyecto-tipo').value = evento.projectType; app.renderProjectTabs(); app.openModal(app.modals.editEvento); };
        app.handleDownloadIndividualReport = (miembroId) => { const miembro = state.equipo.find(m => m.id == miembroId); if (!miembro) { alert('Persona no encontrada.'); return; } const reportData = []; (miembro.honorarios || []).forEach(p => reportData.push({ 'Tipo de Pago': 'Honorario', 'Concepto': p.concepto, 'Valor': p.valor, 'Fecha Inicio': p.fechaInicio, 'Fecha Fin': p.fechaFin })); (miembro.desplazamientos || []).forEach(p => reportData.push({ 'Tipo de Pago': 'Desplazamiento', 'Concepto': p.concepto, 'Valor': p.valor, 'Fecha Inicio': p.fechaInicio, 'Fecha Fin': p.fechaFin })); if (reportData.length === 0) { alert('Este miembro no tiene pagos registrados.'); return; } const ws = XLSX.utils.json_to_sheet(reportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Pagos"); XLSX.writeFile(wb, `Reporte_Financiero_${miembro.nombre.replace(/ /g, '_')}.xlsx`); };
        app.handleBulkAddMiembros = () => { const textarea = document.getElementById('bulk-miembro-names'); const names = textarea.value.split('\n').map(name => name.trim()).filter(Boolean); if (names.length === 0) { alert('Por favor, ingrese al menos un nombre.'); return; } let newMembersAdded = 0; const existingNames = new Set(state.equipo.map(m => m.nombre.toLowerCase())); names.forEach(name => { if (!existingNames.has(name.toLowerCase())) { state.equipo.push({ id: Date.now() + Math.random(), nombre: name, honorarios: [], desplazamientos: [] }); newMembersAdded++; } }); if (newMembersAdded > 0) { app.saveState(); app.render(); alert(`Se añadieron ${newMembersAdded} nuevos miembros.`); textarea.value = ''; app.closeModal(app.modals.bulkMiembro); } else { alert('No se añadieron nuevos miembros. Es posible que ya existan en la lista.'); } };
        app.openDescripcionModal = (eventoId) => { const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; document.getElementById('descripcion-evento-id').value = eventoId; document.getElementById('modal-descripcion-title').textContent = `Descripción de: ${evento.nombre}`; const viewContainer = document.querySelector('#descripcion-view-container .ql-editor'); viewContainer.innerHTML = evento.descripcion || '<p><i>No hay descripción. Haga clic en "Editar" para añadir una.</i></p>'; document.getElementById('descripcion-view-container').style.display = 'block'; document.getElementById('descripcion-editor-container').style.display = 'none'; document.getElementById('btn-enter-edit-mode').style.display = 'inline-block'; document.getElementById('descripcion-actions-container').style.display = 'none'; app.openModal(app.modals.descripcion); };
        app.handleSaveDescripcion = () => { const eventoId = document.getElementById('descripcion-evento-id').value; const evento = state.eventos.find(e => e.id === eventoId); if (!evento || !quillEditor) return; const newDescription = quillEditor.root.innerHTML; evento.descripcion = (newDescription === '<p><br></p>') ? '' : newDescription; app.saveState(); const viewContainer = document.querySelector('#descripcion-view-container .ql-editor'); viewContainer.innerHTML = evento.descripcion || '<p><i>No hay descripción. Haga clic en "Editar" para añadir una.</i></p>'; document.getElementById('descripcion-view-container').style.display = 'block'; document.getElementById('descripcion-editor-container').style.display = 'none'; document.getElementById('btn-enter-edit-mode').style.display = 'inline-block'; document.getElementById('descripcion-actions-container').style.display = 'none'; };
        const updateTaskStatus = (task, newStatusValue) => { const formattedStatus = newStatusValue.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); if (!task.completado) { task.estado = formattedStatus; app.saveState(); } };
        app.handleUpdateTaskStatus = (eId, f, tId, newStatus) => { const task = state.eventos.find(e=>e.id===eId).fases[f].find(t=>t.id==tId); updateTaskStatus(task, newStatus); app.renderChecklistModal(eId);};
        app.handleUpdateSubtaskStatus = (eId, f, tId, stId, newStatus) => { const task = state.eventos.find(e=>e.id===eId).fases[f].find(t=>t.id==tId).subtareas.find(st=>st.id==stId); updateTaskStatus(task, newStatus); app.renderChecklistModal(eId);};
        app.openObservacionModal = (eId, f, tId, stId = null) => { const task = stId ? state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId).subtareas.find(st=>st.id==stId) : state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId); if (!task) return; document.getElementById('observacion-task-path-eid').value = eId; document.getElementById('observacion-task-path-f').value = f; document.getElementById('observacion-task-path-tid').value = tId; document.getElementById('observacion-task-path-stid').value = stId || ''; document.getElementById('modal-observacion-title').textContent = `Observaciones para: ${task.texto}`; const viewContainer = document.querySelector('#observacion-view-container .ql-editor'); viewContainer.innerHTML = task.observacion || '<p><i>No hay observaciones. Haga clic en "Editar" para añadir una.</i></p>'; document.getElementById('observacion-view-container').style.display = 'block'; document.getElementById('observacion-editor-container').style.display = 'none'; document.getElementById('btn-enter-observacion-edit-mode').style.display = 'inline-block'; document.getElementById('observacion-actions-container').style.display = 'none'; app.openModal(app.modals.observacion); };
        app.handleSaveObservacion = () => { const eId = document.getElementById('observacion-task-path-eid').value; const f = document.getElementById('observacion-task-path-f').value; const tId = document.getElementById('observacion-task-path-tid').value; const stId = document.getElementById('observacion-task-path-stid').value; const task = stId ? state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId).subtareas.find(st=>st.id==stId) : state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId); if (!task || !quillObservacionEditor) return; const newObservacion = quillObservacionEditor.root.innerHTML; task.observacion = (newObservacion === '<p><br></p>') ? '' : newObservacion; app.saveState(); const viewContainer = document.querySelector('#observacion-view-container .ql-editor'); viewContainer.innerHTML = task.observacion || '<p><i>No hay observaciones. Haga clic en "Editar" para añadir una.</i></p>'; document.getElementById('observacion-view-container').style.display = 'block'; document.getElementById('observacion-editor-container').style.display = 'none'; document.getElementById('btn-enter-observacion-edit-mode').style.display = 'inline-block'; document.getElementById('observacion-actions-container').style.display = 'none'; };
        app.addOtroItem = () => { state.otros.push({ id: 'otro-' + Date.now(), title: 'Nueva Lista (Haz clic para editar)', content: '' }); app.saveState(); app.renderOtrosModule(); }; app.deleteOtroItem = (id) => { if (confirm('¿Seguro que quieres eliminar esta lista y todo su contenido?')) { state.otros = state.otros.filter(item => item.id !== id); app.saveState(); app.renderOtrosModule(); } }; app.editOtroItemTitle = (h4, id) => { const originalTitle = h4.textContent.trim(); h4.innerHTML = `<input type="text" class="inline-edit-input" value="${originalTitle}">`; const input = h4.querySelector('input'); input.focus(); input.select(); const save = () => { const newTitle = input.value.trim(); const item = state.otros.find(i => i.id === id); if (item && newTitle) { item.title = newTitle; app.saveState(); } h4.textContent = item.title; }; input.addEventListener('blur', save); input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { h4.textContent = originalTitle; } }); }; app.toggleOtroItem = (headerEl) => { const itemEl = headerEl.parentElement; const editorId = `otro-editor-${itemEl.dataset.id}`; const item = state.otros.find(i => i.id === itemEl.dataset.id); itemEl.classList.toggle('open'); if (itemEl.classList.contains('open')) { if (!app.activeQuillEditors[editorId]) { const quill = new Quill(`#${editorId}`, { theme: 'snow', placeholder: 'Escribe aquí...' }); quill.root.innerHTML = item.content || ''; app.activeQuillEditors[editorId] = quill; } } else { if (app.activeQuillEditors[editorId]) { item.content = app.activeQuillEditors[editorId].root.innerHTML; app.saveState(); app.activeQuillEditors[editorId] = null; delete app.activeQuillEditors[editorId]; document.getElementById(editorId).innerHTML = ''; } } };
        
        // --- HANDLERS PARA TRANSFERIR TAREAS ---
        app.openTransferModal = (eId, f, tId, stId = null) => {
            const path = { eId, f, tId, stId };
            const task = stId ? state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId).subtareas.find(st=>st.id==stId) : state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId);
            if (!task) { alert('Error: no se encontró la tarea a transferir.'); return; }
            document.getElementById('transfer-task-name').textContent = task.texto;
            document.getElementById('transfer-task-path').value = JSON.stringify(path);
            const destinationSelect = document.getElementById('transfer-destination-event');
            destinationSelect.innerHTML = state.eventos
                .filter(e => e.id !== eId)
                .map(e => `<option value="${e.id}">${e.nombre}</option>`)
                .join('');
            if(destinationSelect.innerHTML === '') {
                alert('No hay otros eventos a los que transferir la tarea.');
                return;
            }
            app.openModal(app.modals.transferTask);
        };
        app.handleTransferTask = () => {
            const path = JSON.parse(document.getElementById('transfer-task-path').value);
            const destinationEventId = document.getElementById('transfer-destination-event').value;
            const sourceEvent = state.eventos.find(e => e.id === path.eId);
            const destinationEvent = state.eventos.find(e => e.id === destinationEventId);

            if (!sourceEvent || !destinationEvent) { alert('Error: Evento de origen o destino no encontrado.'); return; }

            let taskToMove;
            if (path.stId) { // Es una sub-tarea
                const parentTask = sourceEvent.fases[path.f].find(t => t.id == path.tId);
                const subtaskIndex = parentTask.subtareas.findIndex(st => st.id == path.stId);
                if (subtaskIndex > -1) {
                    taskToMove = parentTask.subtareas.splice(subtaskIndex, 1)[0];
                }
            } else { // Es una tarea principal
                const taskIndex = sourceEvent.fases[path.f].findIndex(t => t.id == path.tId);
                if (taskIndex > -1) {
                    taskToMove = sourceEvent.fases[path.f].splice(taskIndex, 1)[0];
                }
            }

            if (taskToMove) {
                if (!destinationEvent.fases.planeacion) { destinationEvent.fases.planeacion = []; }
                destinationEvent.fases.planeacion.push(taskToMove);
                alert(`Tarea "${taskToMove.texto}" transferida a "${destinationEvent.nombre}" con éxito.`);
                app.saveState();
                app.closeModal(app.modals.transferTask);
                app.renderChecklistModal(path.eId); // Refrescar el modal original
                app.render(); // Refrescar todo por si acaso
            } else {
                alert('Error: No se pudo encontrar y mover la tarea.');
            }
        };

        // --- 6. EVENT LISTENERS BINDING ---
        Object.values(app.modals).forEach(modal => { if (modal) { modal.querySelector('.close-btn').addEventListener('click', () => app.closeModal(modal)); modal.addEventListener('click', (e) => { if (e.target === modal) app.closeModal(modal); }); }});
        document.getElementById('dark-mode-toggle').addEventListener('click', () => app.toggleDarkMode());
        document.querySelectorAll('.tab-link').forEach(link => link.addEventListener('click', app.handleTabClick));
        document.getElementById('btn-add-evento').addEventListener('click', () => { document.getElementById('form-evento').reset(); document.getElementById('evento-proyecto-tipo').value = ""; app.renderProjectTabs(); app.openModal(app.modals.evento); });
        document.getElementById('form-evento').addEventListener('submit', e => { e.preventDefault(); const fechaInicio = document.getElementById('evento-fecha-inicio').value; const fechaFin = document.getElementById('evento-fecha-fin').value; const projectType = document.getElementById('evento-proyecto-tipo').value.trim(); if (new Date(fechaFin) < new Date(fechaInicio)) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; } if (!projectType) { alert('Por favor, ingrese un tipo de proyecto para el evento.'); return; } const newEvent = { id: 'evt-' + Date.now(), nombre: document.getElementById('evento-nombre').value, fechaInicio: fechaInicio, fechaFin: fechaFin, projectType: projectType, descripcion: '', order: state.eventos.length, fases: JSON.parse(JSON.stringify(checklistTemplate)) }; const assignIds = (tasks) => { tasks.forEach(task => { task.id = Date.now() + Math.random(); if (task.subtareas && Array.isArray(task.subtareas)) { assignIds(task.subtareas); } }); }; Object.values(newEvent.fases).forEach(faseTasks => assignIds(faseTasks)); state.eventos.push(newEvent); if (!state.eventProjectTypes.includes(projectType)) { state.eventProjectTypes.push(projectType); } app.saveState(); currentEventProjectTypeFilter = 'all'; app.render(); app.closeModal(app.modals.evento); });
        document.getElementById('form-edit-evento').addEventListener('submit', e => { e.preventDefault(); const eventoId = document.getElementById('edit-evento-id').value; const evento = state.eventos.find(evt => evt.id === eventoId); if (!evento) { alert('Error: Evento no encontrado.'); return; } const newNombre = document.getElementById('edit-evento-nombre').value; const newFechaInicio = document.getElementById('edit-evento-fecha-inicio').value; const newFechaFin = document.getElementById('edit-evento-fecha-fin').value; const newProjectType = document.getElementById('edit-evento-proyecto-tipo').value.trim(); if (new Date(newFechaFin) < new Date(newFechaInicio)) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; } if (!newProjectType) { alert('Por favor, ingrese un tipo de proyecto para el evento.'); return; } evento.nombre = newNombre; evento.fechaInicio = newFechaInicio; evento.fechaFin = newFechaFin; evento.projectType = newProjectType; if (!state.eventProjectTypes.includes(newProjectType)) { state.eventProjectTypes.push(newProjectType); } app.saveState(); app.render(); app.closeModal(app.modals.editEvento); });
        document.getElementById('btn-add-miembro').addEventListener('click', () => { document.getElementById('form-miembro').reset(); document.getElementById('miembro-id').value = ''; document.getElementById('modal-miembro-title').innerText = 'Añadir Miembro'; app.openModal(app.modals.miembro); });
        document.getElementById('form-miembro').addEventListener('submit', e => { e.preventDefault(); const id = document.getElementById('miembro-id').value; const nombre = document.getElementById('miembro-nombre').value; if(id) { state.equipo.find(m => m.id == id).nombre = nombre; } else { state.equipo.push({ id: Date.now(), nombre, honorarios: [], desplazamientos: [] }); } app.saveState(); app.render(); app.closeModal(app.modals.miembro); });
        document.getElementById('btn-bulk-add-miembro').addEventListener('click', () => { document.getElementById('bulk-miembro-names').value = ''; app.openModal(app.modals.bulkMiembro); });
        document.getElementById('btn-save-bulk-miembros').addEventListener('click', app.handleBulkAddMiembros);
        document.getElementById('prev-month-btn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); app.renderCalendar();});
        document.getElementById('next-month-btn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); app.renderCalendar();});
        document.getElementById('form-edit-pago').addEventListener('submit', e => { e.preventDefault(); const miembroId = document.getElementById('edit-pago-miembro-id').value; const pagoId = document.getElementById('edit-pago-id').value; const tipo = document.getElementById('edit-pago-tipo').value; const miembro = state.equipo.find(m => m.id == miembroId); const pago = (miembro[tipo] || []).find(p => p.id == pagoId); if (!pago) return; pago.concepto = document.getElementById('edit-pago-concepto').value; pago.valor = parseFloat(document.getElementById('edit-pago-valor').value); pago.fechaInicio = document.getElementById('edit-pago-fechaInicio').value; pago.fechaFin = document.getElementById('edit-pago-fechaFin').value; if (new Date(pago.fechaFin) < new Date(pago.fechaInicio)) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; } app.saveState(); app.renderFinanzasDetail(miembroId); app.closeModal(app.modals.editPago); });
        document.getElementById('form-transfer-task').addEventListener('submit', e => { e.preventDefault(); app.handleTransferTask(); });
        document.getElementById('btn-download-tareas-persona').addEventListener('click', () => { const data = []; state.eventos.slice().sort((a,b)=>(a.order||0)-(b.order||0)).forEach(e => { app.getAllTasks(e).forEach(t => { data.push({ "Responsables": app.getMiembrosNombres(t.responsables), "Evento": e.nombre, "Tipo de Proyecto": e.projectType || 'N/A', "Fase": t.faseNombre, "Nivel": t.nivel, "Tarea Padre": t.tareaPadre, "Tarea": t.texto, "Fecha Inicio": t.fechaInicio, "Fecha Fin": t.fechaFin, "Estado": t.estado }); }); }); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Tareas por Persona"); XLSX.writeFile(wb, "Reporte_Tareas_por_Persona.xlsx"); });
        document.getElementById('btn-download-avance-evento').addEventListener('click', () => { const data = state.eventos.slice().sort((a,b)=>(a.order||0)-(b.order||0)).map(e => { const { total, completadas } = app.getEventProgress(e); return { "Evento": e.nombre, "Fecha Inicio": e.fechaInicio, "Fecha Fin": e.fechaFin, "Tipo de Proyecto": e.projectType || 'N/A', "Total Tareas": total, "Completadas": completadas, "Avance (%)": total > 0 ? ((completadas / total) * 100).toFixed(2) : 0 }; }); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Avance por Evento"); XLSX.writeFile(wb, "Reporte_Avance_por_Evento.xlsx"); });
        document.getElementById('btn-download-estado-general').addEventListener('click', () => { const wb = XLSX.utils.book_new(); state.eventos.slice().sort((a,b)=>(a.order||0)-(b.order||0)).forEach(e => { const eventTasksData = []; app.getAllTasks(e).forEach(t => { eventTasksData.push({ "Fase": t.faseNombre, "Nivel": t.nivel, "Tarea Padre": t.tareaPadre, "Tarea": t.texto, "Fecha Inicio": t.fechaInicio, "Fecha Fin": t.fechaFin, "Estado": t.estado, "Responsables": app.getMiembrosNombres(t.responsables) }); }); const ws = XLSX.utils.json_to_sheet(eventTasksData); const sheetName = e.nombre.substring(0, 30).replace(/[\\/?*\[\]:]/g, ''); XLSX.utils.book_append_sheet(wb, ws, sheetName); }); XLSX.writeFile(wb, "Reporte_General_Eventos.xlsx"); });
        document.getElementById('btn-download-finanzas-general').addEventListener('click', () => { const reportData = []; state.equipo.forEach(miembro => { (miembro.honorarios || []).forEach(p => reportData.push({ 'Miembro del Equipo': miembro.nombre, 'Tipo de Pago': 'Honorario', 'Concepto': p.concepto, 'Valor': p.valor, 'Fecha Inicio': p.fechaInicio, 'Fecha Fin': p.fechaFin })); (miembro.desplazamientos || []).forEach(p => reportData.push({ 'Miembro del Equipo': miembro.nombre, 'Tipo de Pago': 'Desplazamiento', 'Concepto': p.concepto, 'Valor': p.valor, 'Fecha Inicio': p.fechaInicio, 'Fecha Fin': p.fechaFin })); }); if (reportData.length === 0) { alert('No hay pagos registrados.'); return; } const ws = XLSX.utils.json_to_sheet(reportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Pagos Generales"); XLSX.writeFile(wb, `Reporte_Financiero_General.xlsx`); });
        document.getElementById('btn-download-finanzas-individual').addEventListener('click', () => { const miembroId = document.getElementById('select-finanzas-persona').value; if (miembroId) { app.handleDownloadIndividualReport(miembroId); } else { alert('Por favor, seleccione una persona de la lista.'); } });
        document.getElementById('btn-export-data').addEventListener('click', () => { const dataStr = JSON.stringify(state, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `proyecto_backup_${new Date().toISOString().slice(0,10)}.json`; link.click(); URL.revokeObjectURL(url); });
        document.getElementById('import-file-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file && confirm("¿Importar archivo? Se sobreescribirán todos los datos actuales.")) { const reader = new FileReader(); reader.onload = (e) => { try { let importedState = JSON.parse(e.target.result); if (!importedState || !importedState.eventos || !importedState.equipo) { throw new Error("El archivo de backup no tiene el formato esperado (faltan 'eventos' o 'equipo')."); } importedState = app.migrateState(importedState); Object.keys(state).forEach(key => delete state[key]); Object.assign(state, importedState); app.saveState(); location.reload(); alert("¡Datos importados con éxito! La página se recargará."); } catch (err) { alert("Error al importar el archivo: " + err.message); } }; reader.readAsText(file); } event.target.value = ''; });
        document.getElementById('btn-add-otro-item').addEventListener('click', app.addOtroItem);

        // --- 7. INITIALIZATION ---
        quillEditor = new Quill('#evento-descripcion-editor', { modules: { toolbar: [ [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'image', 'code-block'], ['clean'] ] }, placeholder: 'Escribe la descripción detallada, objetivos, participantes clave, etc.', theme: 'snow' });
        document.getElementById('btn-enter-edit-mode').addEventListener('click', () => { const viewContainer = document.querySelector('#descripcion-view-container .ql-editor'); const currentContent = viewContainer.innerHTML; if (viewContainer.querySelector('i')) { quillEditor.root.innerHTML = ''; } else { quillEditor.root.innerHTML = currentContent; } document.getElementById('descripcion-view-container').style.display = 'none'; document.getElementById('descripcion-editor-container').style.display = 'block'; document.getElementById('btn-enter-edit-mode').style.display = 'none'; document.getElementById('descripcion-actions-container').style.display = 'flex'; });
        document.getElementById('btn-cancel-descripcion').addEventListener('click', () => { document.getElementById('descripcion-view-container').style.display = 'block'; document.getElementById('descripcion-editor-container').style.display = 'none'; document.getElementById('btn-enter-edit-mode').style.display = 'inline-block'; document.getElementById('descripcion-actions-container').style.display = 'none'; });
        document.getElementById('btn-save-descripcion').addEventListener('click', app.handleSaveDescripcion);
        
        quillObservacionEditor = new Quill('#task-observacion-editor', { modules: { toolbar: [ ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean'] ] }, placeholder: 'Escribe las observaciones de la tarea aquí...', theme: 'snow' });
        document.getElementById('btn-enter-observacion-edit-mode').addEventListener('click', () => { const viewContainer = document.querySelector('#observacion-view-container .ql-editor'); const currentContent = viewContainer.innerHTML; if (viewContainer.querySelector('i')) { quillObservacionEditor.root.innerHTML = ''; } else { quillObservacionEditor.root.innerHTML = currentContent; } document.getElementById('observacion-view-container').style.display = 'none'; document.getElementById('observacion-editor-container').style.display = 'block'; document.getElementById('btn-enter-observacion-edit-mode').style.display = 'none'; document.getElementById('observacion-actions-container').style.display = 'flex'; });
        document.getElementById('btn-cancel-observacion').addEventListener('click', () => { document.getElementById('observacion-view-container').style.display = 'block'; document.getElementById('observacion-editor-container').style.display = 'none'; document.getElementById('btn-enter-observacion-edit-mode').style.display = 'inline-block'; document.getElementById('observacion-actions-container').style.display = 'none'; });
        document.getElementById('btn-save-observacion').addEventListener('click', app.handleSaveObservacion);


        app.loadState();
        app.render();

        window.app = app;
        window.resetApp = () => { if (confirm('¿Estás seguro? Se borrarán todos los datos y la aplicación se recargará.')) { localStorage.removeItem('projectManagementState_v19'); location.reload(); } };
        window.verEstado = () => { console.log('Estado actual:', state); };
    });

    const inputs = document.querySelectorAll("input");
    inputs.forEach(function (input) { input.setAttribute("autocomplete", "off"); });
</script>

</body>
</html>
