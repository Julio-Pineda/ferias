<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Proyectos v5.3</title>
    
    <!-- LIBRERÍAS EXTERNAS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Editor de Texto Enriquecido (Quill.js) -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>
    <!-- LIBRERÍA PARA DRAG-AND-DROP (SortableJS) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- LIBRERÍA PARA DIAGRAMA DE GANTT (Frappe Gantt) -->
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.css">


<style>
    /* --- Paleta de Colores y Variables --- */
    :root {
        /* Colores Base */
        --base-primary: #003366;
        --base-secondary: #D4AF37;
        --base-success: #28a745;
        --base-danger: #dc3545;
        --base-warning: #ffc107;
        --base-info: #17a2b8;
        --base-gray: #6c757d;
        --base-full: #0080ff;
        --base-review: #6f42c1; /* Púrpura para "En Revisión" */

        /* Tema Claro (Default) */
        --primary-color: var(--base-primary);
        --secondary-color: var(--base-secondary);
        --success-color: var(--base-success);
        --danger-color: var(--base-danger);
        --warning-color: var(--base-warning);
        --info-color: var(--base-info);
        --gray-color: var(--base-gray);
        --full-color: var(--base-full);
        --review-color: var(--base-review);

        --background-color: #f0f2f5;
        --card-background: #ffffff;
        --text-color: #333;
        --light-text-color: #6c757d;
        --border-color: #e0e0e0;
        --header-bg: #fafafa;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);

        --sidebar-bg: #002244;
        --sidebar-text: #e0e6ec;
        --sidebar-text-hover: #ffffff;
        --sidebar-active-bg: rgba(212, 175, 55, 0.2);
        --sidebar-active-border: var(--base-secondary);
    }
    
    body.dark-mode {
        /* Tema Oscuro */
        --primary-color: #58a6ff;
        --secondary-color: #f7d16f;
        --success-color: #56d364;
        --danger-color: #f85149;
        --warning-color: #e3b341;
        --info-color: #56d4dd;
        --gray-color: #8b949e;
        --review-color: #bf9eee;
        
        --background-color: #0d1117;
        --card-background: #161b22;
        --text-color: #c9d1d9;
        --light-text-color: #8b949e;
        --border-color: #30363d;
        --header-bg: #1f242c;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.2);

        --sidebar-bg: #161b22;
        --sidebar-text: #8b949e;
        --sidebar-text-hover: #c9d1d9;
        --sidebar-active-bg: rgba(88, 166, 255, 0.15);
        --sidebar-active-border: var(--primary-color);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: var(--background-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }

    /* --- NUEVA ESTRUCTURA DE LAYOUT --- */
    .app-container { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background-color: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; transition: width 0.3s ease; position: fixed; top: 0; left: 0; height: 100vh; z-index: 1050; }
    .sidebar-header { padding: 1.5rem; text-align: center; }
    .sidebar-header h2 { font-size: 1.5rem; color: var(--secondary-color); margin-bottom: 0.5rem;}
    .sidebar-header p { font-size: 0.8rem; color: var(--light-text-color); margin: 0; }
    .sidebar-nav { flex-grow: 1; list-style: none; padding: 0; margin-top: 1rem; }
    .nav-link { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; color: var(--sidebar-text); text-decoration: none; font-weight: 600; border-left: 4px solid transparent; transition: all 0.2s ease; cursor: pointer; }
    .nav-link i { width: 20px; text-align: center; font-size: 1.1rem; }
    .nav-link:hover { background-color: var(--sidebar-active-bg); color: var(--sidebar-text-hover); }
    .nav-link.active { background-color: var(--sidebar-active-bg); color: var(--sidebar-text-hover); border-left-color: var(--sidebar-active-border); }
    .sidebar-footer { padding: 1rem; text-align: center; }
    #sidebar-toggle { background: none; border: 1px solid var(--border-color); color: var(--light-text-color); font-size: 1.2rem; cursor: pointer; padding: 0.5rem; border-radius: 8px; }
    
    .main-content { margin-left: 260px; width: calc(100% - 260px); padding: 0; transition: all 0.3s ease; }
    .main-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background-color: var(--card-background); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1001; }
    .header-actions { display: flex; align-items: center; gap: 1.5rem; }
    #user-selector-wrapper { display: flex; align-items: center; gap: 0.5rem; }
    #user-selector { padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-color); }
    .global-search-wrapper { position: relative; width: 400px; }
    .global-search-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--light-text-color); }
    #global-search-input { width: 100%; padding: 0.75rem 0.75rem 0.75rem 2.5rem; border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--background-color); color: var(--text-color); }
    #dark-mode-toggle { font-size: 1.5rem; background: transparent; border: none; cursor: pointer; color: var(--secondary-color); }
    #mobile-menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; color: var(--text-color); cursor: pointer; }

    .container { max-width: 1800px; margin: 0 auto; padding: 2rem; }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ESTADO COLAPSADO SIDEBAR */
    body.sidebar-collapsed .sidebar { width: 80px; }
    body.sidebar-collapsed .sidebar-header h2, body.sidebar-collapsed .sidebar-header p, body.sidebar-collapsed .nav-link span { display: none; }
    body.sidebar-collapsed .sidebar-header { padding: 1.5rem 0; }
    body.sidebar-collapsed .nav-link { justify-content: center; }
    body.sidebar-collapsed .main-content { margin-left: 80px; width: calc(100% - 80px); }
    
    /* --- FIN ESTRUCTURA DE LAYOUT --- */
    
    .project-type-tabs-nav { display: flex; justify-content: center; border-bottom: 2px solid var(--border-color); margin-bottom: 0; flex-wrap: wrap; gap: 0.75rem; }
    .project-type-tab-link { padding: 0.75rem 1.2rem; cursor: pointer; border: 1px solid var(--border-color); border-bottom: none; background-color: var(--card-background); border-radius: 12px; font-size: 0.95rem; font-weight: 600; color: var(--light-text-color); transition: all 0.2s ease; }
    .project-type-tab-link:hover { background-color: var(--header-bg); color: var(--primary-color); }
    .project-type-tab-link.active { background-color: var(--primary-color); color: var(--card-background); border-color: var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

    .card { background: var(--card-background); border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; overflow: hidden; }
    .card-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: var(--header-bg); flex-wrap: wrap; gap: 1rem; }
    .card-header h3 { font-size: 1.5rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.75rem; }
    .card-body { padding: 1.5rem; }

    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
    #analitica .grid-container { grid-template-columns: 1fr 2fr; }
    .event-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 2.2rem;}
    
    .report-card { padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between; background-color: var(--card-background); }
    .empty-state { text-align: center; padding: 3rem; color: var(--light-text-color); font-style: italic; }

    .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .btn:disabled { background-color: var(--gray-color); cursor: not-allowed; opacity: 0.6; }
    .btn-primary { background-color: var(--primary-color); color: var(--card-background); }
    .btn-danger { background-color: var(--danger-color); color: white; }
    .btn-warning { background-color: var(--warning-color); color: black; }
    .btn-success { background-color: var(--success-color); color: white; }
    .btn-secondary { background-color: var(--gray-color); color: white; }
    .btn-info { background-color: var(--info-color); color: white; }
    .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; border-radius: 8px;}
    .icon-btn { background: none; border: none; color: var(--light-text-color); font-size: 1.1rem; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 50%; position: relative; }
    .icon-btn:hover { background-color: var(--header-bg); color: var(--primary-color); }
    .icon-btn:disabled { color: var(--border-color); cursor: not-allowed; }
    .icon-btn:disabled:hover { background-color: transparent; }
    
    .icon-btn.has-observation::after { content: ''; position: absolute; top: 2px; right: 4px; width: 8px; height: 8px; background-color: var(--success-color); border-radius: 50%; border: 1.5px solid var(--card-background); }
    
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
    th { background-color: var(--header-bg); font-weight: 600; }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { background-color: var(--border-color); }
    th .sort-icon { margin-left: 8px; color: var(--light-text-color); }
    td.actions { display: flex; gap: 0.5rem; align-items: center; }
    #tabla-equipo tbody tr { cursor: pointer; }
    #tabla-equipo tbody tr:hover { background-color: var(--header-bg); }

    .event-card-item { background: var(--card-background); border-radius: 22px; box-shadow: 5px 5px 12px 0px rgba(0,0,0,0.61); display: flex; flex-direction: column; border: 1px solid var(--border-color); cursor: grab;}
    .event-card-item:active { cursor: grabbing; }
    .event-card-item.sortable-ghost { opacity: 0.4; background: #c8ebfb; }
    .event-card-item.sortable-chosen { box-shadow: 0 8px 20px rgba(0, 51, 102, 0.2); transform: scale(1.02); }
    .event-card-item-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .event-card-item-header h4 { color: var(--primary-color); cursor: pointer; transition: background-color 0.2s; padding: 5px; border-radius: 4px; width: 100%; }
    .event-card-item-header h4:hover { background-color: var(--header-bg); }
    .inline-edit-input { width: 100%; font-size: 1.1rem; font-weight: bold; color: var(--primary-color); border: 2px solid var(--secondary-color); border-radius: 4px; padding: 4px; font-family: inherit; background-color: var(--card-background); }
    .event-card-item-body { padding: 1rem; display: flex; flex-direction: column; gap: 1rem; flex-grow: 1; }
    .event-card-progress { display: flex; align-items: center; gap: 1rem; }
    .progress-chart-container { width: 80px; height: 80px; position: relative; flex-shrink: 0;}
    .progress-chart-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; font-weight: 700; }
    .event-card-info { font-size: 0.9rem; color: var(--light-text-color); }
    .event-card-item-footer { padding: 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;}
    .btn-manage { background-color: var(--success-color); color: white; flex-grow: 1; }
    
    .actions-menu-wrapper { position: relative; }
    .actions-dropdown { display: none; position: absolute; bottom: 100%; right: 0; background-color: var(--card-background); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: var(--shadow); z-index: 10; min-width: 200px; padding: 0.5rem 0; margin-bottom: 0.5rem; list-style: none; }
    .actions-menu-wrapper.show .actions-dropdown { display: block; }
    .actions-dropdown-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; cursor: pointer; color: var(--text-color); }
    .actions-dropdown-item:hover { background-color: var(--header-bg); }
    .actions-dropdown-item i { width: 16px; text-align: center; color: var(--light-text-color); }
    .actions-dropdown-item.danger { color: var(--danger-color); }
    .actions-dropdown-item.danger:hover { background-color: color-mix(in srgb, var(--danger-color) 15%, transparent); }

    .modal { display: none; position: fixed; z-index: 1300; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
    .modal-content { background-color: var(--card-background); margin: 5% auto; padding: 2rem; border-radius: 12px; max-width: 90%; width: 900px; position: relative; animation: slideIn 0.3s; border: 1px solid var(--border-color); transition: width 0.3s, height 0.3s; }
    @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .close-btn { color: var(--light-text-color); position: absolute; top: 1rem; right: 1.5rem; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    .modal-content h3 { margin-bottom: 1.5rem; color: var(--primary-color); }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background-color: var(--background-color); color: var(--text-color); }
    input[type="search"] { -webkit-appearance: none; }
    input:read-only { background-color: var(--header-bg); cursor: not-allowed; }
    .modal-filter-bar { padding-bottom: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap; }
    .modal-filter-bar .form-group { margin-bottom: 0; flex-grow: 1; min-width: 200px; }

    #modal-checklist .modal-content { width: 1200px; }
    #modal-all-tasks .modal-content, #modal-miembro-tareas .modal-content, #modal-evento-finanzas .modal-content { width: 1200px; }
    #modal-descripcion .modal-content, #modal-observacion .modal-content, #modal-edit-evento .modal-content, #modal-global-search .modal-content, #modal-activity-log .modal-content, #modal-miembro-perfil .modal-content { width: 800px; }
    #modal-miembro .modal-content, #modal-evento .modal-content, #modal-bulk-miembro .modal-content, #modal-edit-pago .modal-content, #modal-transfer-task .modal-content, #modal-edit-gasto-general .modal-content, #modal-dependencies .modal-content, #modal-hito .modal-content, #modal-ausencia .modal-content { width: 500px; }
    #modal-responsables .modal-content, #modal-responsables-evento .modal-content, #modal-save-template .modal-content { width: 400px; }
    #modal-day-tasks .modal-content { width: 800px; }

    #checklist-container { max-height: 70vh; overflow-y: auto; padding-right: 1rem; }
    .checklist-header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
    .checklist-view-toggle button { background: var(--header-bg); border: 1px solid var(--border-color); color: var(--text-color); }
    .checklist-view-toggle button.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    .task-card { background-color: var(--card-background); border: 3px solid var(--border-color); border-radius: 22px; margin-bottom: 1rem; padding: 1rem; transition: box-shadow 0.2s ease; }
    .task-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .task-main-line { display: flex; align-items: center; gap: 1rem; }
    .task-main-line input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--success-color); flex-shrink: 0; cursor: pointer;}
    .task-description { flex-grow: 1; }
    .task-description input[type="text"] { width: 100%; border: none; font-size: 1.05rem; padding: 0.25rem; border-radius: 4px; transition: background-color 0.2s; background-color: transparent; color: var(--text-color); }
    .task-description input[type="text"]:focus { background-color: var(--header-bg); outline: 1px solid var(--primary-color); }
    .task-card.completed .task-description input[type="text"] { text-decoration: line-through; color: var(--light-text-color); }
    .task-actions { display: flex; align-items: center; gap: 0.25rem; }
    .task-details { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-top: 0.75rem; padding-left: 2.2rem; font-size: 0.9rem; }
    .task-detail-item { display: flex; align-items: center; gap: 0.5rem; }
    .task-detail-item label { font-weight: 600; color: #555; }
    .task-detail-item input[type="datetime-local"] { padding: 0.25rem 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.85rem; background-color: var(--background-color); color: var(--text-color); }
    .responsables-display { font-size: 0.85rem; color: var(--light-text-color); max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .status-badge { padding: 0.2rem 0.6rem; border-radius: 12px; font-weight: 600; color: white; font-size: 0.8rem; cursor: pointer; text-align: center; min-width: 80px;}
    .status-badge.status-Completado { background-color: var(--success-color); }
    .status-badge.status-En-proceso { background-color: var(--info-color); }
    .status-badge.status-Aplazado { background-color: var(--warning-color); color: black; }
    .status-badge.status-Atrasado { background-color: var(--danger-color); }
    .status-badge.status-Cancelado { background-color: var(--gray-color); }
    .status-badge.status-En-Revisión { background-color: var(--review-color); }
    .status-select { padding: 0.2rem 0.4rem; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.8rem; background-color: var(--background-color); color: var(--text-color); }
    .add-task-btn-container { text-align: left; margin-top: 1.5rem; }
    .btn-add-task { background: var(--secondary-color); color: var(--base-primary); }
    .subtasks-container { margin-left: 2.2rem; border-left: 2px solid var(--border-color); padding-left: 1rem; margin-top: 1rem; }
    .subtask-card { background-color: var(--header-bg); transform: scale(0.98); }
    .add-subtask-btn { background: #e0f7fa; color: #00796b; padding: 0.3rem 0.8rem; border-radius: 8px; font-size: 0.85rem; }
    
    /* --- ESTILOS KANBAN MEJORADOS --- */
    #modal-checklist.kanban-active .modal-content {
        width: 95vw !important;
        max-width: 1800px;
        height: 95vh;
        display: flex;
        flex-direction: column;
    }
    #checklist-kanban-container {
        display: flex; /* Horizontal layout for columns */
        flex-grow: 1; /* Take up all available vertical space */
        gap: 1rem;
        overflow-x: auto; /* Enable horizontal scrolling */
        padding: 1rem;
        background-color: var(--background-color);
        border-radius: 8px;
        min-height: 0; /* Fix for flex-grow in some contexts */
    }
    .kanban-column {
        flex: 0 0 320px; /* Base width, don't grow or shrink */
        display: flex;
        flex-direction: column;
        background-color: var(--header-bg);
        border-radius: 8px;
        max-height: 100%;
        border: 1px solid var(--border-color);
    }
    .kanban-column-header {
        padding: 1rem;
        font-weight: 600;
        color: var(--primary-color);
        border-bottom: 2px solid var(--border-color);
        flex-shrink: 0;
    }
    .kanban-tasks {
        padding: 0.75rem;
        flex-grow: 1;
        overflow-y: auto;
        min-height: 50px;
    }
    .kanban-card {
        background-color: var(--card-background);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.07);
        cursor: grab;
        border-left: 4px solid var(--secondary-color);
        transition: box-shadow 0.2s;
    }
    .kanban-card:hover {
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .kanban-card:active { cursor: grabbing; }
    .kanban-card.sortable-ghost { opacity: 0.4; background: var(--primary-color); }
    .kanban-card h5 { margin-bottom: 0.75rem; font-size: 1rem; }
    .kanban-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
        color: var(--light-text-color);
    }
    .kanban-filters {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    /* --- FIN ESTILOS KANBAN --- */

    #responsables-checkbox-container, #responsables-evento-checkbox-container, #dependencies-checkbox-container { max-height: 420px; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 6px; }
    .responsable-option, .dependency-option { display: block; margin-bottom: 0.5rem; }
    .responsable-option label, .dependency-option label { margin-left: 0.5rem; }
    
    .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;}
    .calendar-nav { display: flex; justify-content: space-between; align-items: center; }
    .calendar-nav h2 { color: var(--primary-color); margin: 0 1rem;}
    .calendar-layers { display: flex; gap: 1rem; align-items: center;}
    .calendar-layers label { font-weight: 600; cursor: pointer; }
    .calendar-header { font-weight: bold; text-align: center; color: var(--primary-color); padding: 1rem 1rem 0 1rem; display:grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
    #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; padding: 1rem;}
    .calendar-day { border: 1px solid var(--border-color); min-height: 120px; padding: 0.5rem; background-color: var(--card-background); position: relative; border-radius: 8px; transition: background-color 0.2s; }
    .calendar-day.other-month { background-color: var(--header-bg); color: var(--light-text-color); opacity: 0.5; }
    .day-number { font-weight: bold; }
    .calendar-day-indicators { position: absolute; top: 5px; right: 5px; display: flex; flex-direction: column; gap: 4px; font-size: 0.9rem; }
    .day-tasks-badge { background-color: var(--secondary-color); color: var(--base-primary); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; position: absolute; bottom: 8px; right: 8px; }
    .calendar-day.has-tasks { cursor: pointer; background-color: color-mix(in srgb, var(--secondary-color) 10%, transparent); }
    .calendar-day.is-absence { background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, color-mix(in srgb, var(--warning-color) 20%, transparent) 10px, color-mix(in srgb, var(--warning-color) 20%, transparent) 20px); cursor: pointer; }
    #day-tasks-list-container { max-height: 60vh; overflow-y: auto; }
    #day-tasks-list { list-style: none; padding: 0; }
    
    .day-task-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-bottom: 1px solid var(--border-color); background-color: var(--card-background); border-radius: 8px; margin-bottom: 0.75rem; }
    .day-task-item:last-child { border-bottom: none; }
    .day-task-status { font-size: 1.5rem; flex-shrink: 0; margin-top: 2px; }
    .day-task-info { flex-grow: 1; }
    .day-task-info strong { font-size: 1.1rem; color: var(--text-color); }
    .day-task-info small { display: block; color: var(--light-text-color); font-size: 0.85rem; margin-top: 4px; }
    .day-task-info .task-meta { display: inline-block; margin-right: 1rem; }
    .day-task-actions { display: flex; gap: 0.25rem; }
    .modal-day-section-title { color: var(--primary-color); margin-top: 1.5rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--secondary-color); font-size: 1.2rem; }
    
    p { margin-bottom: 1.2rem; }

    #equipo-finanzas-view h3 { color: var(--primary-color); margin-bottom: 1.5rem; }
    #equipo-finanzas-view h4 { color: var(--secondary-color); margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;}
    .finanzas-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    .finanzas-pagos-list { max-height: 300px; overflow-y: auto; margin-bottom: 1rem; padding-right: 10px; }
    .finanzas-pago-item { display: grid; grid-template-columns: 2fr 1.5fr 1fr auto; gap: 1rem; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
    .finanzas-pago-item:last-child { border-bottom: none; }
    .finanzas-pago-actions { display: flex; gap: 0.5rem; }
    .finanzas-add-pago-form { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; }
    .finanzas-add-pago-form .form-group { margin-bottom: 0; }
    .finanzas-add-pago-form input, .finanzas-add-pago-form select { padding: 0.5rem; }
    .finanzas-add-pago-form button { grid-column: 1 / -1; }
    
    /* --- Estilos Finanzas Evento (NUEVO) --- */
    .finance-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .summary-card {
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        color: white;
        box-shadow: var(--shadow);
    }
    .summary-card h4 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
        font-weight: 600;
        opacity: 0.9;
        color: inherit; /* Hereda el color del padre (.summary-card) */
        border: none; /* Elimina bordes si los hubiera */
    }
    .summary-card .amount {
        font-size: 2rem;
        font-weight: 700;
    }
    .summary-card.budget { background-color: var(--info-color); }
    .summary-card.spent { background-color: var(--warning-color); color: black; }
    .summary-card.balance { background-color: var(--success-color); }
    .summary-card.balance.negative { background-color: var(--danger-color); }

    .evento-finanzas-body {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    #otros-container { display: flex; flex-direction: column; gap: 1.5rem; }
    .otro-item { border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden; background-color: var(--card-background); }
    .otro-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: var(--header-bg); cursor: pointer; }
    .otro-header h4 { color: var(--primary-color); flex-grow: 1; cursor: text; }
    .otro-header .inline-edit-input { font-size: 1.15rem; }
    .otro-content { padding: 1.5rem; border-top: 1px solid var(--border-color); display: none; }
    .ql-toolbar, .ql-container { border-color: var(--border-color) !important; }
    .ql-editor { color: var(--text-color); }
    .otro-content .ql-editor { min-height: 200px; }
    .otro-item.open .otro-content { display: block; }
    .otro-item.open .toggle-icon { transform: rotate(180deg); }
    .toggle-icon { transition: transform 0.3s ease; }
    
    /* Perfil de Miembro */
    #equipo-profile-view { display: none; }
    #equipo-finanzas-view { display: none; }
    .profile-header { display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border-color); }
    .profile-avatar { width: 100px; height: 100px; border-radius: 50%; background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: bold; flex-shrink: 0; }
    .profile-info h2 { font-size: 2.2rem; margin-bottom: 0.5rem; }
    .profile-info p { color: var(--light-text-color); margin-bottom: 0.2rem; }
    .profile-info p i { margin-right: 0.5rem; width: 16px; }
    .profile-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
    
    #gantt-chart-container { font-size: 14px; }
    .gantt .bar-label { font-weight: 600; }
    .gantt .bar-progress { fill: var(--primary-color); }
    body.dark-mode .gantt-container { --gantt-text-color: var(--text-color); --gantt-bar-color: var(--primary-color); --gantt-bar-progress-color: var(--success-color); --gantt-line-color: var(--border-color); --gantt-background-color: var(--card-background); }
    body.dark-mode .gantt .bar-label { fill: #fff; }
    body.dark-mode .grid-header, body.dark-mode .grid-row { fill: var(--card-background); }
    body.dark-mode .gantt .grid-body .grid-row:nth-child(even) { fill: var(--header-bg); }

    /* ESTILOS DEPENDENCIAS */
    .task-dependencies { font-size: 0.8rem; margin-top: 0.5rem; padding-left: 2.2rem; }
    .task-dependencies strong { color: var(--text-color); }
    .dependency-link { color: var(--primary-color); cursor: pointer; text-decoration: underline; }
    .dependency-link:hover { color: var(--secondary-color); }

    /* --- RESPONSIVE DESIGN --- */
    @media (max-width: 992px) { .global-search-wrapper, #sidebar-toggle, .sidebar-footer, #user-selector-wrapper { display: none; } .sidebar { transform: translateX(-100%); position: fixed; z-index: 1200; } .sidebar.open { transform: translateX(0); } .main-content, body.sidebar-collapsed .main-content { margin-left: 0; width: 100%; } body.sidebar-collapsed .sidebar { width: 260px; } body.sidebar-collapsed .sidebar-header h2, body.sidebar-collapsed .sidebar-header p, body.sidebar-collapsed .nav-link span { display: block; } body.sidebar-collapsed .sidebar-header { padding: 1.5rem; } body.sidebar-collapsed .nav-link { justify-content: flex-start; } #mobile-menu-toggle { display: block; } .main-header { padding: 1rem; } }
    @media (max-width: 768px) { .container { padding: 1rem; } .grid-container, #analitica .grid-container, .event-grid, .finanzas-detail-grid, .evento-finanzas-body, .profile-stats { grid-template-columns: 1fr; } .card-header h3 { font-size: 1.25rem; } .card-body { padding: 1rem; } .modal-content, #modal-checklist .modal-content, #modal-descripcion .modal-content, #modal-observacion .modal-content, #modal-miembro .modal-content, #modal-evento .modal-content, #modal-edit-evento .modal-content, #modal-bulk-miembro .modal-content, #modal-responsables .modal-content, #modal-day-tasks .modal-content, #modal-edit-pago .modal-content, #modal-transfer-task .modal-content, #modal-all-tasks .modal-content, #modal-miembro-tareas .modal-content, #modal-responsables-evento .modal-content, #modal-global-search .modal-content, #modal-evento-finanzas .modal-content, #modal-activity-log .modal-content, #modal-save-template .modal-content, #modal-edit-gasto-general .modal-content, #modal-dependencies .modal-content, #modal-hito .modal-content, #modal-ausencia .modal-content { width: 95% !important; padding: 1.5rem 1rem; margin-top: 10%; } #checklist-container { max-height: 65vh; padding-right: 0.5rem; } .task-main-line, .calendar-nav, .profile-header { flex-direction: column; align-items: flex-start; gap: 0.75rem; } .task-details { padding-left: 0; flex-direction: column; align-items: flex-start; gap: 0.75rem; } #calendar-grid, .calendar-header { gap: 5px; padding: 0.5rem; } .calendar-day { min-height: 60px; padding: 0.25rem; font-size: 0.8rem; } .finanzas-add-pago-form { grid-template-columns: 1fr; } }
    @media (max-width: 480px) { .btn { padding: 0.5rem 1rem; font-size: 0.9rem; } }
</style>
</head>
<body>

<div class="app-container">
    <!-- BARRA LATERAL DE NAVEGACIÓN -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>PROYECTO</h2>
            <p>Comercialización Cauca</p>
        </div>
        <ul class="sidebar-nav">
            <li><a class="nav-link active" data-tab="mis-tareas"><i class="fas fa-user-clock fa-fw"></i> <span>Mis Tareas</span></a></li>
            <li><a class="nav-link" data-tab="analitica"><i class="fas fa-chart-pie fa-fw"></i> <span>Analítica</span></a></li>
            <li><a class="nav-link" data-tab="gestion"><i class="fas fa-tasks fa-fw"></i> <span>Gestión de Eventos</span></a></li>
            <li><a class="nav-link" data-tab="cronograma"><i class="fas fa-calendar-alt fa-fw"></i> <span>Cronograma</span></a></li>
            <li><a class="nav-link" data-tab="equipo"><i class="fas fa-users fa-fw"></i> <span>Gestión de Equipo</span></a></li>
            <li><a class="nav-link" data-tab="otros"><i class="fas fa-cogs fa-fw"></i> <span>Ajustes y Otros</span></a></li>
            <li><a class="nav-link" data-tab="reportes"><i class="fas fa-download fa-fw"></i> <span>Reportes</span></a></li>
        </ul>
        <div class="sidebar-footer">
            <button id="sidebar-toggle" title="Contraer/Expandir Menú"><i class="fas fa-exchange-alt"></i></button>
        </div>
    </nav>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="main-content">
        <header class="main-header">
            <button id="mobile-menu-toggle"><i class="fas fa-bars"></i></button>
            <div class="global-search-wrapper">
                <i class="fas fa-search"></i>
                <input type="search" id="global-search-input" placeholder="Búsqueda global (eventos, tareas, equipo)...">
            </div>
            <div class="header-actions">
                 <div id="user-selector-wrapper">
                    <i class="fas fa-user"></i>
                    <select id="user-selector"></select>
                </div>
                <button id="dark-mode-toggle" title="Alternar Modo Oscuro"><i class="fas fa-moon"></i></button>
            </div>
        </header>

        <div class="container">
            <!-- MÓDULO 0: MIS TAREAS -->
            <div id="mis-tareas" class="tab-content active">
                 <div class="card-header" style="background: transparent; border:none; padding-left: 0;">
                    <h1 style="font-size: 2.5rem; color: var(--primary-color);">Mi Dashboard</h1>
                 </div>
                 <div id="my-tasks-container"></div>
            </div>

            <!-- MÓDULO 1: ANALÍTICA -->
            <div id="analitica" class="tab-content">
                 <div class="card-header" style="background: transparent; border:none; padding-left: 0;">
                    <h1 style="font-size: 2.5rem; color: var(--primary-color);">Analítica</h1>
                 </div>
                <div class="grid-container">
                    <div class="card"><div class="card-header"><h3><i class="fas fa-tachometer-alt"></i> Avance general</h3></div><div class="card-body" style="height: 350px;"><canvas id="generalChart"></canvas></div></div>
                    <div class="card"><div class="card-header"><h3><i class="fas fa-calendar-check"></i> Avance por evento</h3></div><div class="card-body" style="height: 350px;"><canvas id="eventosChart"></canvas></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3><i class="fas fa-user-check"></i> Desempeño por persona</h3></div>
                    <div class="card-body" style="height: 400px;"><canvas id="personasChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><h3><i class="fas fa-wallet"></i> Resumen de Gastos</h3></div>
                    <div class="card-body" style="height: 400px;"><canvas id="gastosChart"></canvas></div>
                </div>
            </div>
            
            <!-- MÓDULO 2: GESTIÓN DE EVENTOS -->
            <div id="gestion" class="tab-content">
                 <div class="card-header" style="background: transparent; border:none; padding-left: 0;">
                    <h1 style="font-size: 2.5rem; color: var(--primary-color);">Gestión de Eventos</h1>
                 </div>
                <div class="project-type-tabs-nav" id="event-project-type-nav"></div>
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-clipboard-list"></i> Eventos del proyecto</h3>
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button class="btn btn-secondary" id="btn-view-all-tasks"><i class="fas fa-list-alt"></i> Ver todas las tareas</button>
                            <button class="btn btn-primary" id="btn-add-evento"><i class="fas fa-plus"></i> Crear nuevo</button>
                        </div>
                    </div>
                    <div class="card-body"><div id="event-grid-container" class="event-grid"></div></div>
                </div>
            </div>
            
            <!-- MÓDULO 3: CRONOGRAMA -->
            <div id="cronograma" class="tab-content">
                <div class="card-header" style="background: transparent; border:none; padding-left: 0;">
                    <h1 style="font-size: 2.5rem; color: var(--primary-color);">Cronograma</h1>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-calendar-alt"></i> Cronograma de Tareas</h3>
                         <div class="checklist-view-toggle cronograma-view-toggle">
                            <button class="btn btn-sm" id="cronograma-view-calendar-btn"><i class="fas fa-calendar-day"></i> Calendario</button>
                            <button class="btn btn-sm" id="cronograma-view-gantt-btn"><i class="fas fa-stream"></i> Gantt</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="calendar-view-container">
                            <div class="calendar-controls">
                                <div class="calendar-nav">
                                    <button class="btn btn-primary" id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                                    <h2 id="calendar-month-year"></h2>
                                    <button class="btn btn-primary" id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-secondary" onclick="app.openHitoModal()"><i class="fas fa-flag"></i> Añadir Hito</button>
                                    <button class="btn btn-sm btn-secondary" onclick="app.openAusenciaModal()"><i class="fas fa-user-clock"></i> Registrar Ausencia</button>
                                </div>
                            </div>
                            <div class="calendar-layers" style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);">
                                <strong>Capas:</strong>
                                <label title="Muestra/oculta los hitos del proyecto (banderas azules)"><input type="checkbox" class="layer-toggle" data-layer="hitos" onchange="app.renderCalendar()" checked> Hitos</label>
                                <label title="Muestra/oculta los días de ausencia del personal (fondo rayado)"><input type="checkbox" class="layer-toggle" data-layer="ausencias" onchange="app.renderCalendar()" checked> Disponibilidad</label>
                                <label title="Muestra/oculta los días con periodos de pago activos (monedas doradas)"><input type="checkbox" class="layer-toggle" data-layer="finanzas" onchange="app.renderCalendar()" checked> Finanzas</label>
                            </div>
                            <div class="calendar-header">
                                <div>Dom</div><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div>
                            </div>
                            <div id="calendar-grid"></div>
                        </div>
                        <div id="gantt-view-container" style="display: none;">
                            <svg id="gantt-chart-container"></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MÓDULO 4: GESTIÓN DE EQUIPO -->
            <div id="equipo" class="tab-content">
                <div id="equipo-list-view">
                    <div class="card-header" style="background: transparent; border:none; padding-left: 0;">
                       <h1 style="font-size: 2.5rem; color: var(--primary-color);">Gestión de Equipo</h1>
                   </div>
                   <div class="card">
                       <div class="card-header">
                           <h3><i class="fas fa-users-cog"></i> Miembros del equipo</h3>
                           <div>
                               <button class="btn btn-primary" id="btn-add-miembro"><i class="fas fa-user-plus"></i> Añadir miembro</button>
                               <button class="btn btn-primary" id="btn-bulk-add-miembro"><i class="fas fa-users"></i> Carga masiva</button>
                           </div>
                       </div>
                       <div class="card-body">
                           <div class="form-group" style="max-width: 400px; margin-bottom: 1.5rem;">
                               <label for="equipo-search-input">Buscar miembro del equipo</label>
                               <input type="search" id="equipo-search-input" placeholder="Escriba un nombre para filtrar...">
                           </div>
                           <div class="table-responsive" id="equipo-table-container">
                               <table id="tabla-equipo">
                                   <thead>
                                       <tr>
                                           <th class="sortable" onclick="app.handleTableSort('equipo', 'nombre')">Nombre <i id="sort-icon-equipo-nombre" class="fas fa-sort sort-icon"></i></th>
                                           <th>Rol / Cargo</th>
                                           <th>Tareas asignadas</th>
                                           <th>Acciones</th>
                                       </tr>
                                   </thead>
                                   <tbody></tbody>
                               </table>
                           </div>
                       </div>
                   </div>
                </div>
                <div id="equipo-profile-view" style="display: none;">
                    <!-- Contenido del perfil se generará dinámicamente aquí -->
                </div>
                <div id="equipo-finanzas-view" style="display: none;">
                    <!-- Contenido de finanzas del miembro se generará aquí -->
                </div>
            </div>

            <!-- MÓDULO 5: OTROS Y PLANTILLAS -->
            <div id="otros" class="tab-content">
                <div class="card-header" style="background: transparent; border:none; padding-left: 0;">
                    <h1 style="font-size: 2.5rem; color: var(--primary-color);">Ajustes y Otros</h1>
                </div>
                 <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-clone"></i> Gestión de Plantillas de Eventos</h3>
                    </div>
                    <div class="card-body">
                        <div id="template-manager-container"></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-box-open"></i> Listas de Contenido Personalizado</h3>
                        <button class="btn btn-primary" id="btn-add-otro-item"><i class="fas fa-plus"></i> Añadir nueva lista</button>
                    </div>
                    <div class="card-body">
                        <div id="otros-container"></div>
                    </div>
                </div>
            </div>

            <!-- MÓDULO 6: REPORTES -->
            <div id="reportes" class="tab-content">
                <div class="card-header" style="background: transparent; border:none; padding-left: 0;">
                    <h1 style="font-size: 2.5rem; color: var(--primary-color);">Reportes</h1>
                </div>
                <div class="card">
                     <div class="card-header"><h3><i class="fas fa-file-excel"></i> Reportes en Excel</h3></div>
                     <div class="card-body grid-container" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                        <div class="report-card"><h4><i class="fas fa-calendar-week"></i> Cronograma de Eventos</h4><p>Descarga un reporte detallado con fechas, líderes y responsables de cada día de evento, ideal para cronogramas operativos.</p><button class="btn btn-primary" id="btn-download-cronograma-eventos"><i class="fas fa-file-excel"></i> Descargar</button></div>
                         <div class="report-card"><h4><i class="fas fa-tasks"></i> Tareas por Persona</h4><p>Genera un archivo con el detalle de tareas asignadas a cada miembro del equipo.</p><button class="btn btn-primary" id="btn-download-tareas-persona"><i class="fas fa-file-excel"></i> Descargar</button></div>
                         <div class="report-card"><h4><i class="fas fa-chart-line"></i> Avance por Evento</h4><p>Genera un archivo con el resumen de avance (total de tareas, completadas, %) de cada evento.</p><button class="btn btn-primary" id="btn-download-avance-evento"><i class="fas fa-file-excel"></i> Descargar</button></div>
                         <div class="report-card"><h4><i class="fas fa-clipboard-list"></i> Estado General de Eventos</h4><p>Genera un archivo con una hoja por cada evento, detallando todas sus tareas, fases y responsables.</p><button class="btn btn-primary" id="btn-download-estado-general"><i class="fas fa-file-excel"></i> Descargar</button></div>
                         <div class="report-card"><h4><i class="fas fa-wallet"></i> Finanzas (General)</h4><p>Genera un archivo con todos los pagos y un resumen financiero por evento.</p><button class="btn btn-primary" id="btn-download-finanzas-general"><i class="fas fa-file-excel"></i> Descargar</button></div>
                         <div class="report-card"><h4><i class="fas fa-user-tag"></i> Finanzas (Individual)</h4><p>Seleccione una persona para generar un reporte detallado de sus pagos.</p><div><select id="select-finanzas-persona"></select><button class="btn btn-primary" id="btn-download-finanzas-individual" style="width: 100%; margin-top: 1rem;"><i class="fas fa-file-excel"></i> Descargar</button></div></div>
                     </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3><i class="fas fa-database"></i> Gestión de Datos de la App</h3></div>
                    <div class="card-body grid-container">
                        <div class="report-card">
                            <h4>Exportar Datos (Backup)</h4>
                            <p>Guarda todo el estado de la aplicación (eventos, equipo, tareas, finanzas) en un archivo .json.</p>
                            <button class="btn btn-primary" id="btn-export-data"><i class="fas fa-file-export"></i> Exportar Backup</button>
                        </div>
                        <div class="report-card">
                            <h4>Importar Datos (Restaurar)</h4>
                            <p>Carga un archivo de backup (.json) para restaurar el estado de la aplicación. ¡Sobrescribirá los datos actuales!</p>
                            <input type="file" id="import-file-input" accept=".json" style="display: none;">
                            <button class="btn btn-success" onclick="document.getElementById('import-file-input').click();"><i class="fas fa-file-import"></i> Importar Backup</button>
                        </div>
                        <div class="report-card">
                            <h4>Eliminar Datos (Definitivamente)</h4>
                            <p>Elimina todo el estado de la aplicación (eventos, equipo, tareas, finanzas).</p>
                            <button class="btn btn-danger" onclick="resetApp()"><i class="fas fa fa-trash"></i> Eliminar Backup</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- MODALES -->
<div id="modal-checklist" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="checklist-title"></h3><div class="checklist-header-controls"><div class="checklist-view-toggle"><button class="btn btn-sm" id="checklist-view-list-btn"><i class="fas fa-list"></i> Lista</button><button class="btn btn-sm" id="checklist-view-board-btn"><i class="fas fa-columns"></i> Tablero</button></div><div class="kanban-filters" style="display:none;"><input type="search" id="kanban-search-filter" placeholder="Buscar tareas..." class="form-group" style="padding: 0.5rem;"><select id="kanban-user-filter" class="form-group" style="padding: 0.5rem;"></select></div></div><div id="checklist-list-container"></div><div id="checklist-kanban-container" style="display:none;"></div></div></div>
<div id="modal-miembro" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="modal-miembro-title"></h3><form id="form-miembro"><input type="hidden" id="miembro-id"><div class="form-group"><label for="miembro-nombre">Nombre del Miembro</label><input type="text" id="miembro-nombre" required></div><div class="form-group"><label for="miembro-rol">Rol / Cargo</label><input type="text" id="miembro-rol" placeholder="Ej: Gestor, Coordinador"></div><div class="form-group"><label for="miembro-contacto">Email / Contacto</label><input type="text" id="miembro-contacto" placeholder="Ej: email@example.com"></div><button type="submit" class="btn btn-primary">Guardar</button></form></div></div>
<div id="modal-evento" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3>Crear Nuevo Evento</h3><form id="form-evento"><div class="form-group"><label for="evento-nombre">Nombre del Evento</label><input type="text" id="evento-nombre" placeholder="Ej: Feria Subregional Popayán" required></div><div class="form-group"><label for="evento-template">Crear desde Plantilla (Opcional)</label><select id="evento-template"><option value="">Empezar desde cero</option></select></div><div class="form-group"><label for="evento-fecha-inicio">Fecha y Hora de Inicio</label><input type="datetime-local" id="evento-fecha-inicio" required></div><div class="form-group"><label for="evento-fecha-fin">Fecha de Fin</label><input type="date" id="evento-fecha-fin" required></div><div class="form-group"><label for="evento-proyecto-tipo">Tipo de Proyecto</label><input type="text" id="evento-proyecto-tipo" list="proyecto-tipos-list" placeholder="Ej: Ferias, Talleres, Internos" required><datalist id="proyecto-tipos-list"></datalist></div><div class="form-group"><label for="evento-municipio">Municipio</label><input type="text" id="evento-municipio" placeholder="Ej: Popayán"></div><div class="form-group"><label for="evento-modalidad">Modalidad</label><select id="evento-modalidad"><option value="Presencial">Presencial</option><option value="Virtual">Virtual</option></select></div><button type="submit" class="btn btn-primary">Crear Evento</button></form></div></div>
<div id="modal-edit-evento" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="edit-evento-title">Editar Evento</h3><form id="form-edit-evento"><input type="hidden" id="edit-evento-id"><div class="form-group"><label for="edit-evento-nombre">Nombre del Evento</label><input type="text" id="edit-evento-nombre" required></div><div class="form-group"><label for="edit-evento-fecha-inicio">Fecha y Hora de Inicio</label><input type="datetime-local" id="edit-evento-fecha-inicio" required></div><div class="form-group"><label for="edit-evento-fecha-fin">Fecha de Fin</label><input type="date" id="edit-evento-fecha-fin" required></div><div class="form-group"><label for="edit-evento-proyecto-tipo">Tipo de Proyecto</label><input type="text" id="edit-evento-proyecto-tipo" list="proyecto-tipos-list-edit" required><datalist id="proyecto-tipos-list-edit"></datalist></div><hr style="margin: 2rem 0;"><h4 style="color: var(--secondary-color); margin-bottom: 1rem;">Detalles para Reporte y Finanzas</h4><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;"><div class="form-group"><label for="edit-evento-municipio">Municipio</label><input type="text" id="edit-evento-municipio"></div><div class="form-group"><label for="edit-evento-modalidad">Modalidad</label><select id="edit-evento-modalidad"><option value="Presencial">Presencial</option><option value="Virtual">Virtual</option></select></div></div><div class="form-group"><label for="edit-evento-presupuesto">Presupuesto Asignado (COP)</label><input type="number" id="edit-evento-presupuesto" placeholder="Ej: 5000000"></div><div class="form-group"><label for="edit-evento-lider">Líder de la Jornada</label><select id="edit-evento-lider"></select></div><div class="form-group" style="margin-bottom: 2rem;"><label>Responsables que Acompañan</label><button type="button" class="btn btn-secondary" onclick="app.openResponsablesEventoModal()"><i class="fas fa-users-cog"></i> Asignar Responsables del Evento</button></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;"><div class="form-group"><label for="edit-evento-orden-salida">Necesita Orden de Salida</label><select id="edit-evento-orden-salida"><option value="true">Sí</option><option value="false">No</option></select></div><div class="form-group"><label for="edit-evento-requiere-ma">¿Se debe hacer M.A.?</label><select id="edit-evento-requiere-ma"><option value="true">Sí</option><option value="false">No</option></select></div></div><div class="form-group"><label for="edit-evento-link-ma">Link Memoria de la Actividad</label><input type="url" id="edit-evento-link-ma"></div><button type="submit" class="btn btn-primary">Guardar Cambios</button></form></div></div>
<div id="modal-responsables" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3>Asignar Responsables de Tarea</h3><div id="responsables-checkbox-container"></div><div style="text-align: right; margin-top: 1rem;"><button id="btn-save-responsables" class="btn btn-primary">Guardar</button></div></div></div>
<div id="modal-day-tasks" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="day-tasks-title"></h3><div id="day-tasks-content"></div></div></div>
<div id="modal-edit-pago" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="edit-pago-title">Editar Pago</h3><form id="form-edit-pago"><input type="hidden" id="edit-pago-miembro-id"><input type="hidden" id="edit-pago-id"><input type="hidden" id="edit-pago-tipo"><div class="form-group"><label for="edit-pago-concepto">Concepto</label><input type="text" id="edit-pago-concepto" required></div><div class="form-group"><label for="edit-pago-valor">Valor</label><input type="number" id="edit-pago-valor" required></div><div class="form-group"><label for="edit-pago-fechaInicio">Fecha Inicio</label><input type="date" id="edit-pago-fechaInicio" required></div><div class="form-group"><label for="edit-pago-fechaFin">Fecha Fin</label><input type="date" id="edit-pago-fechaFin" required></div><div class="form-group"><label for="edit-pago-evento-asociado">Asociar a Evento (Opcional)</label><select id="edit-pago-evento-asociado"></select></div><button type="submit" class="btn btn-primary">Guardar Cambios</button></form></div></div>
<div id="modal-bulk-miembro" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3>Carga Masiva de Miembros de Equipo</h3><p>Introduce un nombre por línea. Cada línea se convertirá en un nuevo miembro del equipo.</p><div class="form-group"><label for="bulk-miembro-names">Nombres de Miembros</label><textarea id="bulk-miembro-names" rows="10" placeholder="Ejemplo:&#10;Juan Pérez&#10;María García&#10;Carlos Ruiz"></textarea></div><button type="submit" class="btn btn-primary" id="btn-save-bulk-miembros">Añadir Miembros</button></div></div>
<div id="modal-descripcion" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="modal-descripcion-title">Descripción del Evento</h3><input type="hidden" id="descripcion-evento-id"><button id="btn-enter-edit-mode" class="btn btn-warning btn-sm" style="position: absolute; top: 1.5rem; right: 4rem;"><i class="fas fa-pencil-alt"></i> Editar</button><div id="descripcion-view-container" class="ql-snow"><div class="ql-editor" style="height: auto; min-height: 300px; max-height: 60vh; overflow-y: auto; background-color: var(--header-bg); border-radius: 5px; padding: 1rem; border: 1px solid var(--border-color);"></div></div><div id="descripcion-editor-container" style="display: none;"><div id="evento-descripcion-editor" style="height: 300px;"></div></div><div id="descripcion-actions-container" style="text-align: right; margin-top: 1.5rem; display: none; gap: 0.5rem;"><button class="btn btn-secondary" id="btn-cancel-descripcion">Cancelar</button><button class="btn btn-primary" id="btn-save-descripcion">Guardar Cambios</button></div></div></div>
<div id="modal-observacion" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="modal-observacion-title">Observaciones de la Tarea</h3><input type="hidden" id="observacion-task-path-eid"><input type="hidden" id="observacion-task-path-f"><input type="hidden" id="observacion-task-path-tid"><input type="hidden" id="observacion-task-path-stid"><button id="btn-enter-observacion-edit-mode" class="btn btn-warning btn-sm" style="position: absolute; top: 1.5rem; right: 4rem;"><i class="fas fa-pencil-alt"></i> Editar</button><div id="observacion-view-container" class="ql-snow"><div class="ql-editor" style="height: auto; min-height: 300px; max-height: 60vh; overflow-y: auto; background-color: var(--header-bg); border-radius: 5px; padding: 1rem; border: 1px solid var(--border-color);"></div></div><div id="observacion-editor-container" style="display: none;"><div id="task-observacion-editor" style="height: 300px;"></div></div><div id="observacion-actions-container" style="text-align: right; margin-top: 1.5rem; display: none; gap: 0.5rem;"><button class="btn btn-secondary" id="btn-cancel-observacion">Cancelar</button><button class="btn btn-primary" id="btn-save-observacion">Guardar Cambios</button></div></div></div>
<div id="modal-transfer-task" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3>Transferir Tarea</h3><p>Mover la tarea: <strong id="transfer-task-name"></strong></p><form id="form-transfer-task"><input type="hidden" id="transfer-task-path"><div class="form-group"><label for="transfer-destination-event">Seleccione el evento de destino:</label><select id="transfer-destination-event" required></select></div><button type="submit" class="btn btn-primary"><i class="fas fa-exchange-alt"></i> Transferir Tarea</button></form></div></div>
<div id="modal-all-tasks" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="all-tasks-title">Listado General de Tareas</h3><div class="modal-filter-bar"><div class="form-group"><label for="all-tasks-event-filter">Filtrar por Evento</label><select id="all-tasks-event-filter"></select></div><div class="form-group"><label for="all-tasks-status-filter">Filtrar por Estado</label><select id="all-tasks-status-filter"></select></div></div><div id="all-tasks-container" style="max-height: 65vh; overflow-y: auto; padding-right: 1rem;"></div></div></div>
<div id="modal-miembro-tareas" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="miembro-tareas-title">Tareas Asignadas</h3><div class="modal-filter-bar"><div class="form-group"><label for="miembro-tareas-event-filter">Filtrar por Evento</label><select id="miembro-tareas-event-filter"></select></div><div class="form-group"><label for="miembro-tareas-status-filter">Filtrar por Estado</label><select id="miembro-tareas-status-filter"></select></div></div><div id="miembro-tareas-container" style="max-height: 65vh; overflow-y: auto; padding-right: 1rem;"></div></div></div>
<div id="modal-responsables-evento" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3>Asignar Responsables del Evento</h3><div id="responsables-evento-checkbox-container"></div><div style="text-align: right; margin-top: 1rem;"><button id="btn-save-responsables-evento" class="btn btn-primary">Guardar</button></div></div></div>
<div id="modal-global-search" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="global-search-title">Resultados de la Búsqueda</h3><div id="global-search-results-container"></div></div></div>
<div id="modal-evento-finanzas" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="evento-finanzas-title">Finanzas del Evento</h3><div id="evento-finanzas-container"></div></div></div>
<div id="modal-activity-log" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="activity-log-title">Historial de Actividad del Evento</h3><div id="activity-log-container"></div></div></div>
<div id="modal-save-template" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3>Guardar como Plantilla</h3><form id="form-save-template"><input type="hidden" id="template-source-event-id"><div class="form-group"><label for="template-name">Nombre de la Plantilla</label><input type="text" id="template-name" required placeholder="Ej: Plantilla para Ferias"></div><p style="font-size: 0.9rem; color: var(--light-text-color);">Se guardará la estructura de fases y tareas de este evento. No se incluirán fechas, responsables ni observaciones.</p><button type="submit" class="btn btn-primary">Guardar Plantilla</button></form></div></div>
<div id="modal-edit-gasto-general" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3>Editar Gasto General</h3><form id="form-edit-gasto-general"><input type="hidden" id="edit-gasto-evento-id"><input type="hidden" id="edit-gasto-id"><div class="form-group"><label for="edit-gasto-concepto">Concepto</label><input type="text" id="edit-gasto-concepto" required></div><div class="form-group"><label for="edit-gasto-valor">Valor</label><input type="number" id="edit-gasto-valor" required></div><div class="form-group"><label for="edit-gasto-fecha">Fecha</label><input type="date" id="edit-gasto-fecha" required></div><button type="submit" class="btn btn-primary">Guardar Cambios</button></form></div></div>
<div id="modal-dependencies" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="dependencies-title">Gestionar Dependencias</h3><p>Seleccione las tareas que deben completarse <strong>antes</strong> de iniciar <strong id="dependency-task-name"></strong>.</p><div id="dependencies-checkbox-container"></div><div style="text-align: right; margin-top: 1rem;"><button id="btn-save-dependencies" class="btn btn-primary">Guardar Dependencias</button></div></div></div>
<div id="modal-hito" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="modal-hito-title">Gestionar Hito</h3><form id="form-hito"><input type="hidden" id="hito-id"><div class="form-group"><label for="hito-nombre">Nombre del Hito</label><input type="text" id="hito-nombre" required></div><div class="form-group"><label for="hito-fecha">Fecha</label><input type="date" id="hito-fecha" required></div><button type="submit" class="btn btn-primary">Guardar Hito</button></form></div></div>
<div id="modal-ausencia" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="modal-ausencia-title">Registrar Ausencia</h3><form id="form-ausencia"><input type="hidden" id="ausencia-id"><div class="form-group"><label for="ausencia-miembro">Miembro del Equipo</label><select id="ausencia-miembro" required></select></div><div class="form-group"><label for="ausencia-motivo">Motivo</label><input type="text" id="ausencia-motivo" placeholder="Ej: Vacaciones, Incapacidad" required></div><div class="form-group"><label for="ausencia-fecha-inicio">Fecha de Inicio</label><input type="date" id="ausencia-fecha-inicio" required></div><div class="form-group"><label for="ausencia-fecha-fin">Fecha de Fin</label><input type="date" id="ausencia-fecha-fin" required></div><button type="submit" class="btn btn-primary">Guardar Ausencia</button></form></div></div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- SCRIPT RESTRUCTURED FOR RELIABILITY ---
        // 1. STATE & CONFIG
        // 2. CORE APPLICATION FUNCTIONS (definitions)
        // 3. EVENT LISTENER BINDING
        // 4. INITIALIZATION

        // --- 1. STATE & CONFIG ---
        const state = {
            eventos: [],
            equipo: [],
            gastosGenerales: [],
            hitos: [],
            ausencias: [],
            eventProjectTypes: ['Ferias locales', 'Ferias subregionles', 'Ferias especializadas', 'Rutas', 'Misiones'],
            otros: [],
            eventTemplates: [],
            settings: { 
                darkMode: false, 
                sidebarCollapsed: false,
                currentUser: null,
             }
        };
        const charts = {};
        const app = {};
        app.tableSortState = {
            equipo: { key: 'nombre', direction: 'asc' },
        };
        app.taskStates = ['En proceso', 'Aplazado', 'Atrasado', 'En Revisión', 'Cancelado', 'Completado'];
        app.kanbanSortableInstances = {};


        let quillEditor = null;
        let quillObservacionEditor = null;
        let sortableInstance = null;
        let currentCalendarDate = new Date();
        let currentEventProjectTypeFilter = 'all'; 
        app.activeQuillEditors = {};
        const emptyStateMsg = (msg) => `<div class="empty-state">${msg}</div>`;

        // --- 2. CORE APPLICATION FUNCTIONS ---

        const createTaskObject = (texto = 'Nueva Tarea (Editar)') => ({
            id: 'task-' + Date.now() + Math.random(),
            texto: texto,
            completado: false, 
            responsables: [],
            fechaInicio: '',
            fechaFin: '',
            subtareas: [],
            estado: 'En proceso',
            observacion: '',
            dependencies: [],
        });

        const createChecklistTemplate = () => ({
            planeacion: [ createTaskObject('Definir objetivos y alcance del evento'), createTaskObject('Elaborar presupuesto detallado'), createTaskObject('Seleccionar y reservar lugar del evento'), createTaskObject('Convocar unidades productivas/empresas participantes'), ],
            ejecucion: [ createTaskObject('Montaje de stands y logística'), createTaskObject('Registro y atención de participantes'), createTaskObject('Desarrollo de agenda (charlas, ruedas de negocio)'), createTaskObject('Seguimiento y soporte durante el evento'), ],
            cierre: [ createTaskObject('Desmontaje y limpieza del lugar'), createTaskObject('Recopilar encuestas de satisfacción'), createTaskObject('Consolidar base de datos de asistentes/contactos'), ],
            legalizacion: [ createTaskObject('Elaborar informe final del evento'), createTaskObject('Gestionar pagos a proveedores y personal'), createTaskObject('Archivar toda la documentación y soportes'), ]
        });

        app.modals = { 
            checklist: document.getElementById('modal-checklist'), 
            miembro: document.getElementById('modal-miembro'), 
            evento: document.getElementById('modal-evento'), 
            editEvento: document.getElementById('modal-edit-evento'), 
            responsables: document.getElementById('modal-responsables'), 
            dayTasks: document.getElementById('modal-day-tasks'), 
            editPago: document.getElementById('modal-edit-pago'), 
            bulkMiembro: document.getElementById('modal-bulk-miembro'), 
            descripcion: document.getElementById('modal-descripcion'),
            observacion: document.getElementById('modal-observacion'),
            transferTask: document.getElementById('modal-transfer-task'),
            allTasks: document.getElementById('modal-all-tasks'),
            miembroTareas: document.getElementById('modal-miembro-tareas'),
            responsablesEvento: document.getElementById('modal-responsables-evento'),
            globalSearch: document.getElementById('modal-global-search'),
            eventoFinanzas: document.getElementById('modal-evento-finanzas'),
            activityLog: document.getElementById('modal-activity-log'),
            saveTemplate: document.getElementById('modal-save-template'),
            editGastoGeneral: document.getElementById('modal-edit-gasto-general'),
            dependencies: document.getElementById('modal-dependencies'),
            hito: document.getElementById('modal-hito'),
            ausencia: document.getElementById('modal-ausencia'),
        };
        app.openModal = (modal) => modal.style.display = 'block';
        app.closeModal = (modal) => modal.style.display = 'none';
        app.getMiembroNombre = (id) => state.equipo.find(m => m.id == id)?.nombre || '';
        app.getMiembrosNombres = (ids) => (ids || []).map(id => app.getMiembroNombre(id)).join(', ');
        app.getAllTasksForEvent = (evento) => { const allTasks = []; if (!evento || !evento.fases) return allTasks; for (const faseName of Object.keys(evento.fases)) { if(Array.isArray(evento.fases[faseName])) { evento.fases[faseName].forEach(task => { allTasks.push({ ...task, eventoId: evento.id, eventoNombre: evento.nombre, faseNombre: faseName, nivel: "Tarea Principal", parentTaskId: null }); if (task.subtareas && Array.isArray(task.subtareas)) { task.subtareas.forEach(subtask => { allTasks.push({ ...subtask, eventoId: evento.id, eventoNombre: evento.nombre, faseNombre: faseName, nivel: "Sub-tarea", parentTaskId: task.id }); }); } }); } } return allTasks; };
        app.getAllTasksFlat = () => state.eventos.flatMap(e => app.getAllTasksForEvent(e));
        
        app.getTaskById = (taskId) => {
            if (!taskId) return null;
            for (const evento of state.eventos) {
                if (!evento.fases) continue;
                for (const faseName in evento.fases) {
                    if (!Array.isArray(evento.fases[faseName])) continue;
                    for (const task of evento.fases[faseName]) {
                        if (task.id === taskId) {
                            return { ...task, eventoId: evento.id, eventoNombre: evento.nombre };
                        }
                        if (task.subtareas && Array.isArray(task.subtareas)) {
                            for (const subtask of task.subtareas) {
                                if (subtask.id === taskId) {
                                    return { ...subtask, eventoId: evento.id, eventoNombre: evento.nombre };
                                }
                            }
                        }
                    }
                }
            }
            return null;
        };
        
        const cleanupDependencies = (deletedTaskId) => {
            if (!deletedTaskId) return;
            state.eventos.forEach(evento => {
                if (!evento.fases) return;
                Object.values(evento.fases).forEach(fase => {
                    if (!Array.isArray(fase)) return;
                    fase.forEach(task => {
                        if (task.dependencies && task.dependencies.includes(deletedTaskId)) {
                            task.dependencies = task.dependencies.filter(id => id !== deletedTaskId);
                        }
                        (task.subtareas || []).forEach(subtask => {
                            if (subtask.dependencies && subtask.dependencies.includes(deletedTaskId)) {
                                subtask.dependencies = subtask.dependencies.filter(id => id !== deletedTaskId);
                            }
                        });
                    });
                });
            });
        };

        app.getEventProgress = (evento) => { const t = app.getAllTasksForEvent(evento); return { total: t.length, completadas: t.filter(x => x.completado).length }; };
        app.getSemaforoColor = (v) => v === 100 ? 'var(--full-color)' : v >= 67 ? 'var(--success-color)' : v >= 34 ? 'var(--warning-color)' : 'var(--danger-color)';
        app.formatCurrency = (value) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value || 0);
        app.formatDateTime = (dt) => dt ? new Date(dt).toLocaleString('es-CO', {hour12: true, year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'}) : 'N/A';
        app.formatDate = (d) => d ? new Date(d.split('T')[0] + 'T00:00:00').toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';
        app.stripHtml = (html) => { if (!html) return ""; const doc = new DOMParser().parseFromString(html, 'text/html'); return doc.body.textContent || ""; }
        app.logActivity = (eventoId, message) => { const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; if (!Array.isArray(evento.activityLog)) evento.activityLog = []; const user = app.getMiembroNombre(state.settings.currentUser) || 'Sistema'; evento.activityLog.unshift({ timestamp: new Date().toISOString(), user, message }); };
        
        app.migrateState = (data) => {
            if (!data.eventos) data.eventos = [];
            if (!data.equipo) data.equipo = [];
            if (!data.gastosGenerales) data.gastosGenerales = [];
            if (!data.hitos) data.hitos = [];
            if (!data.ausencias) data.ausencias = [];
            if (!data.eventProjectTypes) data.eventProjectTypes = state.eventProjectTypes;
            if (!data.otros) data.otros = [];
            if (!data.eventTemplates) data.eventTemplates = [];
            if (!data.settings) data.settings = { darkMode: false, sidebarCollapsed: false, currentUser: null };
            if (data.settings.currentUser === undefined) data.settings.currentUser = null;

            data.eventProjectTypes = Array.from(new Set([...state.eventProjectTypes, ...data.eventProjectTypes]));
            data.equipo.forEach(miembro => { 
                if (!miembro.honorarios) miembro.honorarios = []; 
                if (!miembro.desplazamientos) miembro.desplazamientos = [];
                if (miembro.rol === undefined) miembro.rol = '';
                if (miembro.contacto === undefined) miembro.contacto = '';
                [...miembro.honorarios, ...miembro.desplazamientos].forEach(pago => { 
                    if (pago.fecha && pago.fechaInicio === undefined) { pago.fechaInicio = pago.fecha; pago.fechaFin = pago.fecha; delete pago.fecha; } 
                    if (pago.fechaInicio === undefined) pago.fechaInicio = ''; 
                    if (pago.fechaFin === undefined) pago.fechaFin = ''; 
                    if (pago.eventoId === undefined) pago.eventoId = null;
                }); 
            });

            const migrateTask = (tarea) => { if (tarea.responsable && !Array.isArray(tarea.responsables)) { tarea.responsables = tarea.responsable ? [String(tarea.responsable)] : []; delete tarea.responsable; } if (!tarea.responsables) tarea.responsables = []; if (tarea.fecha && !tarea.fechaInicio) { tarea.fechaInicio = tarea.fecha; tarea.fechaFin = ''; delete tarea.fecha; } if (tarea.fechaInicio === undefined) tarea.fechaInicio = ''; if (tarea.fechaFin === undefined) tarea.fechaFin = ''; if (tarea.subtareas === undefined) tarea.subtareas = []; else if (Array.isArray(tarea.subtareas)) tarea.subtareas.forEach(sub => migrateTask(sub)); if (tarea.estado === undefined) tarea.estado = tarea.completado ? 'Completado' : 'En proceso'; if (tarea.observacion === undefined) tarea.observacion = ''; if (tarea.dependencies === undefined) tarea.dependencies = []; };

            data.eventos.forEach((evento, index) => {
                if (evento.order === undefined) evento.order = index;
                if (!evento.fechaInicio) evento.fechaInicio = '';
                if (!evento.fechaFin) evento.fechaFin = '';
                if (!evento.projectType) evento.projectType = 'Otros';
                if (evento.descripcion === undefined) evento.descripcion = '';
                if (!evento.fases) evento.fases = createChecklistTemplate();
                if (evento.activityLog === undefined) evento.activityLog = [];
                
                if (evento.municipio === undefined) evento.municipio = '';
                if (evento.modalidad === undefined) evento.modalidad = 'Presencial';
                if (evento.liderId === undefined) evento.liderId = '';
                if (evento.responsablesEvento === undefined) evento.responsablesEvento = [];
                if (evento.necesitaOrdenSalida === undefined) evento.necesitaOrdenSalida = false;
                if (evento.requiereMA === undefined) evento.requiereMA = false;
                if (evento.linkMA === undefined) evento.linkMA = '';
                if (evento.presupuesto === undefined) evento.presupuesto = 0;

                if(evento.fases) { Object.values(evento.fases).flat().forEach(task => migrateTask(task)); }
            });
            data.eventos.sort((a,b) => (a.order || 0) - (b.order || 0)).forEach((e, i) => e.order = i);
            return data;
        };
        app.loadState = () => {
            let loadedData = JSON.parse(localStorage.getItem('projectManagementState_v22')) || { 
                equipo: [ { id: 'user-coord', nombre: 'Coordinación de Proyecto', rol: 'Coordinador', contacto: '' }, ...['Andres Felipe Samboni Perez', 'Daniela Alejandra Mera Lopez', 'Daniela Popo Choco', 'Javier Mariano Mera Rivera', 'Jose Sebastian Restrepo Muñoz', 'Juan Diego Aza Arcos', 'José Fernando Ruíz López', 'Luz Elena Laverde Urrea', 'Manuel Vicente Córdoba Martinez', 'María Fernanda Montenegro Mera', 'María Inés Sánchez', 'Sindy Paola Zuñiga Arrechea'].map((nombre, i) => ({ id: 'user-' + (Date.now() + i + 1), nombre, rol: 'Gestor', contacto:'' })) ], 
                eventos: [], 
                gastosGenerales: [],
                hitos: [],
                ausencias: [],
                eventProjectTypes: state.eventProjectTypes,
                otros: [],
                eventTemplates: [],
                settings: { darkMode: false, sidebarCollapsed: false, currentUser: null }
            };
            const migratedState = app.migrateState(loadedData);
            Object.assign(state, migratedState);

            if (!state.settings.currentUser && state.equipo.length > 0) {
                state.settings.currentUser = state.equipo[0].id; // Default to first user
            }

            app.toggleDarkMode(state.settings.darkMode, false);
            app.toggleSidebar(state.settings.sidebarCollapsed, false);
        };
        app.saveState = () => localStorage.setItem('projectManagementState_v22', JSON.stringify(state)); 
        app.calculateAnalytics = () => { let totalTasks = 0, completedTasks = 0; const progressByEvent = { labels: [], data: [] }; const performanceByPerson = {}; state.equipo.forEach(m => performanceByPerson[m.id] = { name: m.nombre, completed: 0, total: 0 }); state.eventos.forEach(e => { const { total, completadas } = app.getEventProgress(e); totalTasks += total; completedTasks += completadas; progressByEvent.labels.push(e.nombre); progressByEvent.data.push(total > 0 ? (completadas / total) * 100 : 0); app.getAllTasksForEvent(e).forEach(t => { t.responsables.forEach(rId => { if (performanceByPerson[rId]) { performanceByPerson[rId].total++; if (t.completado) performanceByPerson[rId].completed++; } }); }); }); return { general: { completado: completedTasks, pendiente: totalTasks - completedTasks }, byEvent: progressByEvent, byPerson: { labels: Object.values(performanceByPerson).map(p => p.name), completadas: Object.values(performanceByPerson).map(p => p.completed), pendientes: Object.values(performanceByPerson).map(p => p.total - p.completed) } }; };
        
        app.calculateFinanceAnalytics = () => {
            const byEvent = {};
            const byPerson = {};
            let grandTotal = 0;

            state.eventos.forEach(e => byEvent[e.nombre] = 0);
            state.equipo.forEach(p => byPerson[p.nombre] = 0);

            // Sum personal expenses (honorarios, desplazamientos)
            state.equipo.forEach(miembro => {
                const pagosMiembro = [...(miembro.honorarios || []), ...(miembro.desplazamientos || [])];
                const totalPagosMiembro = pagosMiembro.reduce((sum, pago) => sum + (Number(pago.valor) || 0), 0);
                
                byPerson[miembro.nombre] += totalPagosMiembro;
                grandTotal += totalPagosMiembro;

                // Attribute payments to events if associated
                pagosMiembro.forEach(pago => {
                    if (pago.eventoId) {
                        const evento = state.eventos.find(e => e.id === pago.eventoId);
                        if (evento && byEvent[evento.nombre] !== undefined) {
                            byEvent[evento.nombre] += (Number(pago.valor) || 0);
                        }
                    }
                });
            });

            // Sum general expenses
            (state.gastosGenerales || []).forEach(gasto => {
                const gastoValor = Number(gasto.valor) || 0;
                grandTotal += gastoValor;
                if (gasto.eventoId) {
                    const evento = state.eventos.find(e => e.id === gasto.eventoId);
                    if (evento && byEvent[evento.nombre] !== undefined) {
                        byEvent[evento.nombre] += gastoValor;
                    }
                }
            });

            return {
                byEvent: {
                    labels: Object.keys(byEvent),
                    data: Object.values(byEvent)
                },
                byPerson: {
                    labels: Object.keys(byPerson),
                    data: Object.values(byPerson)
                },
                grandTotal
            };
        };

        app.render = () => { app.applyPermissions(); app.renderMyTasksTab(); app.renderCharts(); app.renderProjectTabs(); app.renderEventGrid(currentEventProjectTypeFilter); app.renderEquipoTable(document.getElementById('equipo-search-input').value); app.renderCalendar(); app.renderReportOptions(); app.renderOtrosModule(); };
        app.renderCharts = () => { const data = app.calculateAnalytics(); const textColor = getComputedStyle(document.body).getPropertyValue('--text-color'); const borderColor = getComputedStyle(document.body).getPropertyValue('--border-color'); const greenColor = '#28a745'; const redColor = '#dc3545'; const blueColor = '#003366'; if (charts.general) charts.general.destroy(); charts.general = new Chart(document.getElementById('generalChart').getContext('2d'), { type: 'doughnut', data: { labels: ['Completado', 'Pendiente'], datasets: [{ data: [data.general.completado, data.general.pendiente], backgroundColor: [greenColor, redColor] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor } } } } }); if (charts.eventos) charts.eventos.destroy(); const eventData = state.eventos.slice().sort((a, b) => (a.order || 0) - (b.order || 0)).map(e => { const { total, completadas } = app.getEventProgress(e); return { label: e.nombre, value: total > 0 ? (completadas / total) * 100 : 0 }; }); charts.eventos = new Chart(document.getElementById('eventosChart').getContext('2d'), { type: 'bar', data: { labels: eventData.map(e => e.label), datasets: [{ label: 'Avance (%)', data: eventData.map(e => e.value), backgroundColor: blueColor }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100, ticks: { color: textColor }, grid: { color: borderColor } }, x: { ticks: { color: textColor }, grid: { color: borderColor } } }, plugins: { legend: { display: false } } } }); if (charts.personas) charts.personas.destroy(); charts.personas = new Chart(document.getElementById('personasChart').getContext('2d'), { type: 'bar', data: { labels: data.byPerson.labels, datasets: [{ label: 'Completadas', data: data.byPerson.completadas, backgroundColor: greenColor }, { label: 'Pendientes', data: data.byPerson.pendientes, backgroundColor: redColor }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, ticks: { color: textColor }, grid: { color: borderColor } }, y: { stacked: true, ticks: { color: textColor }, grid: { color: borderColor } } }, plugins: { legend: { position: 'top', labels: { color: textColor } } } } });
        
            const financeData = app.calculateFinanceAnalytics();
            const financeLabels = [...financeData.byEvent.labels, ...financeData.byPerson.labels];
            const financeValues = [...financeData.byEvent.data, ...financeData.byPerson.data];
            const eventColor = getComputedStyle(document.documentElement).getPropertyValue('--base-primary');
            const personColor = getComputedStyle(document.documentElement).getPropertyValue('--base-secondary');
            const backgroundColors = [ ...Array(financeData.byEvent.labels.length).fill(eventColor), ...Array(financeData.byPerson.labels.length).fill(personColor) ];
            if (charts.gastos) charts.gastos.destroy();
            charts.gastos = new Chart(document.getElementById('gastosChart').getContext('2d'), { type: 'bar', data: { labels: financeLabels, datasets: [{ label: 'Gasto (COP)', data: financeValues, backgroundColor: backgroundColors }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: textColor }, grid: { color: borderColor } }, x: { beginAtZero: true, ticks: { color: textColor, callback: function(value) { return 'COP ' + (value/1000) + 'k'; } }, grid: { color: borderColor } } }, plugins: { legend: { display: false }, title: { display: true, text: `Gasto Total: ${app.formatCurrency(financeData.grandTotal)} (Azul: Eventos, Dorado: Personas)`, color: textColor, font: { size: 16 } }, tooltip: { callbacks: { label: function(context) { return app.formatCurrency(context.parsed.x); } } } } } });
        };
        app.renderProjectTabs = () => { const projectTypeNav = document.getElementById('event-project-type-nav'); const projectTypeListCreate = document.getElementById('proyecto-tipos-list'); const projectTypeListEdit = document.getElementById('proyecto-tipos-list-edit'); projectTypeNav.innerHTML = ''; projectTypeListCreate.innerHTML = ''; projectTypeListEdit.innerHTML = ''; const existingProjectTypes = new Set(state.eventos.map(e => e.projectType).filter(Boolean)); const allProjectTypes = Array.from(new Set([...state.eventProjectTypes, ...existingProjectTypes])).sort(); const allBtn = document.createElement('button'); allBtn.className = `project-type-tab-link ${currentEventProjectTypeFilter === 'all' ? 'active' : ''}`; allBtn.dataset.projectType = 'all'; allBtn.textContent = 'Todos'; allBtn.addEventListener('click', () => { currentEventProjectTypeFilter = 'all'; app.renderEventGrid(currentEventProjectTypeFilter); app.renderProjectTabs(); }); projectTypeNav.appendChild(allBtn); allProjectTypes.forEach(projectType => { const btn = document.createElement('button'); btn.className = `project-type-tab-link ${currentEventProjectTypeFilter === projectType ? 'active' : ''}`; btn.dataset.projectType = projectType; btn.textContent = projectType; btn.addEventListener('click', () => { currentEventProjectTypeFilter = projectType; app.renderEventGrid(currentEventProjectTypeFilter); app.renderProjectTabs(); }); projectTypeNav.appendChild(btn); const optionCreate = document.createElement('option'); optionCreate.value = projectType; projectTypeListCreate.appendChild(optionCreate); const optionEdit = document.createElement('option'); optionEdit.value = projectType; projectTypeListEdit.appendChild(optionEdit); }); };
        app.renderEventGrid = (projectTypeFilter = 'all') => { const container = document.getElementById('event-grid-container'); let filteredEvents = projectTypeFilter === 'all' ? state.eventos : state.eventos.filter(e => e.projectType === projectTypeFilter); filteredEvents.sort((a, b) => (a.order || 0) - (b.order || 0)); if (filteredEvents.length === 0) { let msg = `No hay eventos en el tipo de proyecto "${projectTypeFilter}".`; if (projectTypeFilter === 'all' && state.eventos.length === 0) { msg = "No hay eventos creados. ¡Crea el primero para empezar!"; } container.innerHTML = emptyStateMsg(msg); return; } container.innerHTML = ''; filteredEvents.forEach(evento => { const { total, completadas } = app.getEventProgress(evento); const avance = total > 0 ? Math.round((completadas / total) * 100) : 0; const card = document.createElement('div'); card.className = 'event-card-item'; card.dataset.eventId = evento.id; card.innerHTML = ` <div class="event-card-item-header"> <h4 onclick="app.handleEditEventNameClick(this, '${evento.id}')" title="Haz clic para editar">${evento.nombre}</h4> </div> <div class="event-card-item-body"> <div class="event-card-progress"> <div class="progress-chart-container"> <canvas id="progress-${evento.id}"></canvas> <div class="progress-chart-text" style="color:${app.getSemaforoColor(avance)};">${avance}%</div> </div> <div class="event-card-info"> <strong>Fecha Inicio:</strong> ${app.formatDate(evento.fechaInicio)}<br> <strong>Fecha Fin:</strong> ${app.formatDate(evento.fechaFin)}<br> <strong>Tipo de Proyecto:</strong> ${evento.projectType || 'N/A'}<br> <strong>Tareas:</strong> ${completadas}/${total} </div> </div> </div> <div class="event-card-item-footer"> <button class="btn btn-manage" onclick="app.openChecklistModal('${evento.id}')"><i class="fas fa-edit"></i> Tareas</button> <div class="actions-menu-wrapper"> <button class="btn icon-btn" onclick="app.toggleEventActionsMenu(this)"><i class="fas fa-ellipsis-v"></i></button> <ul class="actions-dropdown"> <li class="actions-dropdown-item" onclick="app.handleEditEventDetails('${evento.id}')"><i class="fas fa-info-circle fa-fw"></i> Editar Detalles</li> <li class="actions-dropdown-item" onclick="app.openEventoFinanzasModal('${evento.id}')"><i class="fas fa-coins fa-fw"></i> Ver Finanzas</li> <li class="actions-dropdown-item" onclick="app.showActivityLogModal('${evento.id}')"><i class="fas fa-timeline fa-fw"></i> Ver Historial</li> <li class="actions-dropdown-item" data-permission="coordinator" onclick="app.openSaveTemplateModal('${evento.id}')"><i class="fas fa-save fa-fw"></i> Guardar como Plantilla</li> <li class="actions-dropdown-item danger" data-permission="coordinator" onclick="app.handleDeleteEvento('${evento.id}')"><i class="fas fa-trash fa-fw"></i> Eliminar Evento</li> </ul> </div> </div>`; container.appendChild(card); new Chart(document.getElementById(`progress-${evento.id}`), { type: 'doughnut', data: { datasets: [{ data: [avance, 100 - avance], backgroundColor: [app.getSemaforoColor(avance), '#e9ecef'], borderWidth: 0 }] }, options: { cutout: '70%', plugins: { tooltip: { enabled: false } } } }); }); if (sortableInstance) sortableInstance.destroy(); sortableInstance = new Sortable(container, { animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', disabled: !app.isCoordinator(), onEnd: (evt) => { const newIdOrder = Array.from(evt.to.children).map(card => card.dataset.eventId); newIdOrder.forEach((id, index) => { const evento = state.eventos.find(e => e.id === id); if(evento) evento.order = index; }); let maxVisibleOrder = newIdOrder.length; state.eventos.filter(e => !newIdOrder.includes(e.id)).sort((a,b) => (a.order || 0) - (b.order || 0)).forEach(e => { e.order = maxVisibleOrder++; }); app.saveState(); app.renderCharts(); } }); };
        app.toggleEventActionsMenu = (button) => { event.stopPropagation(); const wrapper = button.parentElement; const allMenus = document.querySelectorAll('.actions-menu-wrapper.show'); allMenus.forEach(menu => { if(menu !== wrapper) menu.classList.remove('show'); }); wrapper.classList.toggle('show'); };
        app.renderEquipoTable = (filterText = '') => { const container = document.getElementById('equipo-table-container'); const tbody = document.getElementById('tabla-equipo').querySelector('tbody'); const sortConfig = app.tableSortState.equipo; const lowerCaseFilter = filterText.toLowerCase(); let processedData = state.equipo.filter(m => m.nombre.toLowerCase().includes(lowerCaseFilter)); processedData.sort((a, b) => { const valA = a[sortConfig.key]; const valB = b[sortConfig.key]; const comparison = valA.localeCompare(valB, 'es', { sensitivity: 'base' }); return sortConfig.direction === 'asc' ? comparison : -comparison; }); if (state.equipo.length === 0) { container.innerHTML = emptyStateMsg("No hay miembros en el equipo. Añade el primero."); tbody.innerHTML = ''; return; } if (processedData.length === 0) { tbody.innerHTML = `<tr><td colspan="4" class="empty-state">No se encontraron miembros.</td></tr>`; return; } container.querySelector('table').style.display = ''; tbody.innerHTML = ''; processedData.forEach(miembro => { const tareasAsignadas = state.eventos.flatMap(e => app.getAllTasksForEvent(e)).filter(t => t.responsables.includes(String(miembro.id))).length; const row = document.createElement('tr'); row.innerHTML = `<td onclick="app.showMemberProfile('${miembro.id}')">${miembro.nombre}</td><td onclick="app.showMemberProfile('${miembro.id}')">${miembro.rol || 'N/A'}</td><td onclick="app.showMemberProfile('${miembro.id}')">${tareasAsignadas}</td><td class="actions"><button class="btn btn-sm btn-warning" data-permission="coordinator" onclick="event.stopPropagation(); app.handleEditMiembro('${miembro.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" data-permission="coordinator" onclick="event.stopPropagation(); app.handleDeleteMiembro('${miembro.id}')"><i class="fas fa-trash"></i></button></td>`; tbody.appendChild(row); }); };
        app.openChecklistModal = (eventoId, view = 'list') => { const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; document.getElementById('checklist-title').textContent = `Gestionar Tareas de: ${evento.nombre}`; document.getElementById('checklist-title').dataset.eventId = eventoId; app.switchChecklistView(view); app.openModal(app.modals.checklist); };
        app.switchChecklistView = (view) => {
            const eventoId = document.getElementById('checklist-title').dataset.eventId;
            const modal = app.modals.checklist;
            const listContainer = document.getElementById('checklist-list-container');
            const boardContainer = document.getElementById('checklist-kanban-container');
            const listBtn = document.getElementById('checklist-view-list-btn');
            const boardBtn = document.getElementById('checklist-view-board-btn');
            const kanbanFilters = document.querySelector('.kanban-filters');

            if (view === 'list') {
                modal.classList.remove('kanban-active');
                listContainer.style.display = 'block';
                boardContainer.style.display = 'none';
                kanbanFilters.style.display = 'none';
                listBtn.classList.add('active');
                boardBtn.classList.remove('active');
                app.renderChecklistListView(eventoId);
            } else { // 'board' view
                modal.classList.add('kanban-active');
                listContainer.style.display = 'none';
                boardContainer.style.display = 'flex'; // Usar flex para layout horizontal
                kanbanFilters.style.display = 'flex';
                listBtn.classList.remove('active');
                boardBtn.classList.add('active');
                app.renderKanbanView(eventoId);
            }
            app.applyPermissions();
        };
        app.renderChecklistListView = (eventoId) => { const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; const container = document.getElementById('checklist-list-container'); container.innerHTML = ''; const statusOptions = app.taskStates.filter(s => s !== 'Completado'); const createTaskHtml = (tarea, tipo, path) => { const { eId, f, tId, stId } = path; const isSubtask = tipo === 'subtask'; const cardClass = isSubtask ? 'task-card subtask-card' : 'task-card'; const tieneResponsables = tarea.responsables && tarea.responsables.length > 0; const hasObservation = tarea.observacion && app.stripHtml(tarea.observacion).trim() !== ''; const onToggle = isSubtask ? `app.handleToggleSubtask('${eId}', '${f}', '${tId}', '${stId}')` : `app.handleToggleTask('${eId}', '${f}', '${tId}')`; const onEditText = isSubtask ? `app.handleEditSubtaskText(this, '${eId}', '${f}', '${tId}', '${stId}')` : `app.handleEditTaskText(this, '${eId}', '${f}', '${tId}')`; const onEditDate = isSubtask ? `app.handleEditSubtaskDate('${eId}', '${f}', '${tId}', '${stId}', arguments[0], this.value)` : `app.handleEditTaskDate('${eId}', '${f}', '${tId}', arguments[0], this.value)`; const openRespModal = isSubtask ? `app.openResponsablesModalForSubtask('${eId}', '${f}', '${tId}', '${stId}')` : `app.openResponsablesModalForTask('${eId}', '${f}', '${tId}')`; const onDelete = isSubtask ? `app.handleDeleteSubtask('${eId}', '${f}', '${tId}', '${stId}')` : `app.handleDeleteTask('${eId}', '${f}', '${tId}')`; const onUpdateStatus = isSubtask ? `app.handleUpdateSubtaskStatus('${eId}', '${f}', '${tId}', '${stId}', this.value)` : `app.handleUpdateTaskStatus('${eId}', '${f}', '${tId}', this.value)`; const openObsModal = isSubtask ? `app.openObservacionModal('${eId}', '${f}', '${tId}', '${stId}')` : `app.openObservacionModal('${eId}', '${f}', '${tId}')`; const openTransferModal = isSubtask ? `app.openTransferModal('${eId}', '${f}', '${tId}', '${stId}')` : `app.openTransferModal('${eId}', '${f}', '${tId}')`; const openDependenciesModal = isSubtask ? `app.openDependenciesModal('${eId}', '${f}', '${tId}', '${stId}')` : `app.openDependenciesModal('${eId}', '${f}', '${tId}')`; let estadoElemento; const estadoNormalizado = tarea.estado.replace(/\s+/g, '-'); if (tarea.completado) { estadoElemento = `<span class="status-badge status-Completado">Completado</span>`; } else { estadoElemento = `<div class="status-badge-container"><span class="status-badge status-${estadoNormalizado}" onclick="this.style.display='none'; this.nextElementSibling.style.display='inline-block'; this.nextElementSibling.focus();">${tarea.estado}</span><select class="status-select" style="display:none;" onchange="${onUpdateStatus}" onblur="this.style.display='none'; this.previousElementSibling.style.display='inline-block';">${statusOptions.map(s => `<option value="${s}" ${tarea.estado === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>`; } const fechaFinOnChange = onEditDate.replace('arguments[0]', "'fechaFin'"); let dependenciesHTML = ''; if(tarea.dependencies && tarea.dependencies.length > 0) { const depLinks = tarea.dependencies.map(depId => { const depTask = app.getTaskById(depId); return depTask ? `<span class="dependency-link" onclick="app.highlightTask('${depTask.id}')">${depTask.texto}</span>` : '<span style="color:var(--danger-color)">Tarea eliminada</span>'; }).join(', '); dependenciesHTML = `<div class="task-dependencies"><strong>Depende de:</strong> ${depLinks}</div>`; } let taskHtml = `<div class="${cardClass} ${tarea.completado ? 'completed' : ''}" data-task-id="${isSubtask ? stId : tId}"><div class="task-main-line"><input type="checkbox" onchange="${onToggle}" ${tarea.completado ? 'checked' : ''}><div class="task-description"><input type="text" value="${tarea.texto.replace(/"/g, '&quot;')}" onchange="${onEditText}" onblur="${onEditText}"></div><div class="task-actions">${!isSubtask ? `<button class="icon-btn" title="Añadir Sub-tarea" onclick="app.handleAddSubtask('${eId}', '${f}', '${tId}')"><i class="fas fa-plus-circle"></i></button>` : ''}<button class="icon-btn" title="Gestionar Dependencias" onclick="${openDependenciesModal}"><i class="fas fa-link"></i></button><button class="icon-btn" title="Transferir Tarea" onclick="${openTransferModal}"><i class="fas fa-exchange-alt"></i></button><button class="icon-btn ${hasObservation ? 'has-observation' : ''}" title="Observaciones" onclick="${openObsModal}"><i class="fas fa-comment-dots"></i></button><button class="icon-btn" title="Eliminar Tarea" onclick="${onDelete}"><i class="fas fa-trash-alt" style="color:var(--danger-color)"></i></button></div></div><div class="task-details"><div class="task-detail-item"><label>Estado:</label>${estadoElemento}</div><div class="task-detail-item"><label><i class="fas fa-calendar-alt"></i></label><input type="datetime-local" value="${tarea.fechaInicio || ''}" onchange="${onEditDate.replace('arguments[0]', "'fechaInicio'")}" /><span style="margin:0 0.25rem;">-</span><input type="datetime-local" value="${tarea.fechaFin || ''}" onchange="${fechaFinOnChange}" /></div><div class="task-detail-item"><label><i class="fas fa-user"></i></label><div class="responsables-display" title="${app.getMiembrosNombres(tarea.responsables)}">${app.getMiembrosNombres(tarea.responsables) || 'Sin asignar'}</div><button class="btn btn-sm ${tieneResponsables ? 'btn-success' : 'btn-secondary'}" onclick="${openRespModal}">${tieneResponsables ? 'Asignado' : 'Asignar'}</button></div></div>${dependenciesHTML}</div>`; if (!isSubtask && tarea.subtareas && tarea.subtareas.length > 0) { taskHtml += `<div class="subtasks-container">${tarea.subtareas.map(subtarea => createTaskHtml(subtarea, 'subtask', {eId, f, tId, stId: subtarea.id})).join('')}</div>`; } return taskHtml; }; for (const [fase, tareas] of Object.entries(evento.fases)) { let faseHtml = `<div class="checklist-phase" data-fase-id="${fase}"><h4>${fase.charAt(0).toUpperCase() + fase.slice(1)}</h4><div id="task-list-${fase}">`; if(Array.isArray(tareas)) { tareas.forEach(tarea => { faseHtml += createTaskHtml(tarea, 'task', {eId: evento.id, f: fase, tId: tarea.id}); }); } faseHtml += `</div><div class="add-task-btn-container"><button class="btn btn-add-task btn-sm" onclick="app.handleAddTask('${evento.id}', '${fase}')"><i class="fas fa-plus"></i> Añadir Tarea a ${fase}</button></div></div>`; container.innerHTML += faseHtml; } };
        app.renderCalendar = () => { const grid = document.getElementById('calendar-grid'); const monthYearEl = document.getElementById('calendar-month-year'); grid.innerHTML = ''; const year = currentCalendarDate.getFullYear(); const month = currentCalendarDate.getMonth(); monthYearEl.textContent = `${currentCalendarDate.toLocaleString('es-ES', { month: 'long' })} ${year}`.toUpperCase(); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const dateToISO = (d) => d.toISOString().split('T')[0]; const layers = { hitos: document.querySelector('.layer-toggle[data-layer="hitos"]').checked, ausencias: document.querySelector('.layer-toggle[data-layer="ausencias"]').checked, finanzas: document.querySelector('.layer-toggle[data-layer="finanzas"]').checked, }; const dataByDate = {}; const processDateRange = (start, end, dataObj, key) => { let currentDate = new Date(start.split('T')[0] + 'T00:00:00'); let endDate = new Date(end.split('T')[0] + 'T00:00:00'); while (currentDate <= endDate) { if (currentDate.getFullYear() === year && currentDate.getMonth() === month) { const dateStr = dateToISO(currentDate); if (!dataByDate[dateStr]) dataByDate[dateStr] = {}; if (!dataByDate[dateStr][key]) dataByDate[dateStr][key] = []; dataByDate[dateStr][key].push(dataObj); } currentDate.setDate(currentDate.getDate() + 1); } }; state.eventos.forEach(e => { if(e.fechaInicio) processDateRange(e.fechaInicio, e.fechaInicio, e, 'eventos'); app.getAllTasksForEvent(e).forEach(t => { if(t.fechaInicio) processDateRange(t.fechaInicio, t.fechaFin || t.fechaInicio, t, 'tareas'); }); }); if (layers.hitos) state.hitos.forEach(h => { if(h.fecha) processDateRange(h.fecha, h.fecha, h, 'hitos'); }); if (layers.ausencias) state.ausencias.forEach(a => { if(a.fechaInicio && a.fechaFin) processDateRange(a.fechaInicio, a.fechaFin, a, 'ausencias'); }); if (layers.finanzas) state.equipo.forEach(m => [...(m.honorarios || []), ...(m.desplazamientos || [])].forEach(p => { if(p.fechaInicio && p.fechaFin) processDateRange(p.fechaInicio, p.fechaFin, p, 'finanzas'); })); for (let i = 0; i < firstDay; i++) { grid.innerHTML += `<div class="calendar-day other-month"></div>`; } for (let day = 1; day <= daysInMonth; day++) { const date = new Date(year, month, day); const dateStr = dateToISO(date); const dayData = dataByDate[dateStr] || {}; const dayEl = document.createElement('div'); dayEl.className = 'calendar-day'; dayEl.innerHTML = `<div class="day-number">${day}</div><div class="calendar-day-indicators"></div>`; if (Object.keys(dayData).length > 0) { dayEl.style.cursor = 'pointer'; dayEl.onclick = () => app.showDayDetails(dateStr, dayData); dayEl.classList.add('has-tasks'); const indicators = dayEl.querySelector('.calendar-day-indicators'); if (dayData.eventos) indicators.innerHTML += `<i class="fas fa-play-circle" title="Inicio de evento: ${dayData.eventos.map(e => e.nombre).join(', ')}" style="color:var(--base-danger);"></i>`; if (dayData.hitos) indicators.innerHTML += `<i class="fas fa-flag" title="${dayData.hitos.map(h => h.nombre).join(', ')}" style="color:var(--base-primary);"></i>`; if (dayData.ausencias) { dayEl.classList.add('is-absence'); dayEl.title = `Ausentes: ${[...new Set(dayData.ausencias.map(a => app.getMiembroNombre(a.miembroId)))].join(', ')}`; } if (dayData.finanzas) indicators.innerHTML += `<i class="fas fa-coins" title="Períodos de pago activos" style="color:var(--base-secondary);"></i>`; if (dayData.tareas) dayEl.innerHTML += `<div class="day-tasks-badge">${dayData.tareas.length}</div>`; } grid.appendChild(dayEl); } };
        app.renderReportOptions = () => { const select = document.getElementById('select-finanzas-persona'); if (!select) return; select.innerHTML = '<option value="">-- Seleccione una persona --</option>'; state.equipo.forEach(miembro => { select.innerHTML += `<option value="${miembro.id}">${miembro.nombre}</option>`; }); };
        app.renderOtrosModule = () => { const container = document.getElementById('otros-container'); if (!container) return; container.innerHTML = ''; if (state.otros.length === 0) { container.innerHTML = emptyStateMsg("No hay listas de contenido. ¡Añade la primera!"); return; } state.otros.forEach(item => { const itemEl = document.createElement('div'); itemEl.className = 'otro-item'; itemEl.dataset.id = item.id; itemEl.innerHTML = ` <div class="otro-header" onclick="app.toggleOtroItem(this)"> <h4 onclick="event.stopPropagation(); app.editOtroItemTitle(this, '${item.id}')">${item.title}</h4> <div class="task-actions"> <button class="icon-btn toggle-icon" title="Expandir/Contraer"><i class="fas fa-chevron-down"></i></button> <button class="icon-btn" title="Eliminar lista" onclick="event.stopPropagation(); app.deleteOtroItem('${item.id}')"><i class="fas fa-trash-alt" style="color:var(--danger-color)"></i></button> </div> </div> <div class="otro-content"> <div id="otro-editor-${item.id}"></div> </div> `; container.appendChild(itemEl); }); app.renderTemplateManager(); };
        
        app.renderAllTasksModal = (eventIdFilter = 'all', statusFilter = 'all') => {
            const container = document.getElementById('all-tasks-container');
            const eventFilterSelect = document.getElementById('all-tasks-event-filter');
            const statusFilterSelect = document.getElementById('all-tasks-status-filter');
            
            eventFilterSelect.innerHTML = `<option value="all">Todos los Eventos</option>` + 
                state.eventos.map(e => `<option value="${e.id}" ${eventIdFilter === e.id ? 'selected' : ''}>${e.nombre}</option>`).join('');
            
            statusFilterSelect.innerHTML = `<option value="all">Todos los Estados</option>` +
                app.taskStates.map(s => `<option value="${s}" ${statusFilter === s ? 'selected' : ''}>${s}</option>`).join('');

            const sortedEvents = state.eventos.slice().sort((a,b)=>(a.order||0)-(b.order||0));
            const eventsToRender = (eventIdFilter === 'all')
                ? sortedEvents
                : sortedEvents.filter(e => e.id === eventIdFilter);

            let contentHtml = '';
            eventsToRender.forEach(evento => {
                let allTasks = app.getAllTasksForEvent(evento);
                if (statusFilter !== 'all') {
                    allTasks = allTasks.filter(t => (t.completado ? 'Completado' : t.estado) === statusFilter);
                }

                if (allTasks.length > 0) {
                    if (eventIdFilter === 'all') { contentHtml += `<h4 class="modal-day-section-title" style="margin-top: 2rem;">${evento.nombre}</h4>`; }
                    contentHtml += '<ul style="list-style: none; padding: 0;">';
                    allTasks.forEach(t => {
                        const icon = t.completado ? `<i class="fas fa-check-circle" style="color: var(--success-color);"></i>` : `<i class="fas fa-times-circle" style="color: var(--danger-color);"></i>`;
                        let taskTitle = t.nivel === "Sub-tarea" ? `&nbsp;&nbsp;&nbsp;↳ ${t.texto}` : t.texto;
                        contentHtml += `<li class="day-task-item"><div class="day-task-status">${icon}</div><div class="day-task-info"><strong>${taskTitle}</strong><small><span class="task-meta"><strong>Fase:</strong> ${t.faseNombre}</span><span class="task-meta"><strong>Estado:</strong> ${t.estado}</span><br><strong>Responsables:</strong> ${app.getMiembrosNombres(t.responsables)}</small></div></li>`;
                    });
                    contentHtml += '</ul>';
                }
            });
            container.innerHTML = contentHtml || emptyStateMsg('No hay tareas para mostrar con los filtros actuales.');
        };

        app.openMiembroTareasModal = (miembroId) => {
            const miembro = state.equipo.find(m => m.id == miembroId);
            if (!miembro) return;
            document.getElementById('miembro-tareas-title').textContent = `Tareas Asignadas a: ${miembro.nombre}`;
            const allAssignedTasks = state.eventos.flatMap(e => app.getAllTasksForEvent(e)).filter(t => t.responsables.includes(String(miembroId)));
            
            const eventFilterSelect = document.getElementById('miembro-tareas-event-filter');
            const statusFilterSelect = document.getElementById('miembro-tareas-status-filter');
            
            const renderAndFilter = () => {
                app.renderMiembroTareasModal(allAssignedTasks, eventFilterSelect.value, statusFilterSelect.value);
            };

            eventFilterSelect.onchange = renderAndFilter;
            statusFilterSelect.onchange = renderAndFilter;
            
            app.renderMiembroTareasModal(allAssignedTasks, 'all', 'all');
            app.openModal(app.modals.miembroTareas);
        };
        
        app.renderMiembroTareasModal = (tasks, eventIdFilter = 'all', statusFilter = 'all') => {
            const container = document.getElementById('miembro-tareas-container');
            const eventFilterSelect = document.getElementById('miembro-tareas-event-filter');
            const statusFilterSelect = document.getElementById('miembro-tareas-status-filter');

            const relevantEvents = [...new Set(tasks.map(t => t.eventoId))].map(id => state.eventos.find(e => e.id === id)).filter(Boolean);
            
            eventFilterSelect.innerHTML = `<option value="all">Todos los Eventos</option>` + relevantEvents.map(e => `<option value="${e.id}" ${eventIdFilter === e.id ? 'selected' : ''}>${e.nombre}</option>`).join('');
            statusFilterSelect.innerHTML = `<option value="all">Todos los Estados</option>` + app.taskStates.map(s => `<option value="${s}" ${statusFilter === s ? 'selected' : ''}>${s}</option>`).join('');

            let filteredTasks = tasks;
            if (eventIdFilter !== 'all') {
                filteredTasks = filteredTasks.filter(t => t.eventoId === eventIdFilter);
            }
            if (statusFilter !== 'all') {
                filteredTasks = filteredTasks.filter(t => (t.completado ? 'Completado' : t.estado) === statusFilter);
            }

            if (filteredTasks.length === 0) {
                container.innerHTML = emptyStateMsg('No hay tareas asignadas para los filtros seleccionados.');
                return;
            }
            
            let contentHtml = '<ul style="list-style: none; padding: 0;">';
            filteredTasks.forEach(t => {
                const icon = t.completado ? `<i class="fas fa-check-circle" style="color: var(--success-color);"></i>` : `<i class="fas fa-times-circle" style="color: var(--danger-color);"></i>`;
                let taskTitle = t.nivel === "Sub-tarea" ? `&nbsp;&nbsp;&nbsp;↳ ${t.texto}` : t.texto;
                contentHtml += `<li class="day-task-item"><div class="day-task-status">${icon}</div><div class="day-task-info"><strong>${taskTitle}</strong><small><span class="task-meta"><strong>Evento:</strong> ${t.eventoNombre}</span><span class="task-meta"><strong>Fase:</strong> ${t.faseNombre}</span><br><strong>Estado:</strong> ${t.estado}</small></div></li>`;
            });
            contentHtml += '</ul>';
            container.innerHTML = contentHtml;
        };
        
        app.toggleDarkMode = (forceDark, save = true) => { const body = document.body; const toggleButton = document.getElementById('dark-mode-toggle'); const isDark = typeof forceDark === 'boolean' ? forceDark : !body.classList.contains('dark-mode'); body.classList.toggle('dark-mode', isDark); toggleButton.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; if (save) { state.settings.darkMode = isDark; app.saveState(); } const activeTabId = document.querySelector('.tab-content.active')?.id; if (activeTabId === 'analitica') app.renderCharts(); else if (activeTabId === 'cronograma' && document.getElementById('gantt-view-container').style.display !== 'none') { app.renderGanttChart(); } };
        app.toggleSidebar = (forceCollapse, save = true) => { const isCollapsed = typeof forceCollapse === 'boolean' ? forceCollapse : !document.body.classList.contains('sidebar-collapsed'); document.body.classList.toggle('sidebar-collapsed', isCollapsed); if(save) { state.settings.sidebarCollapsed = isCollapsed; app.saveState(); } };
        app.handleTabClick = (e) => { document.querySelectorAll('.nav-link, .tab-content').forEach(el => el.classList.remove('active')); const link = e.currentTarget; link.classList.add('active'); const tabId = link.dataset.tab; document.getElementById(tabId).classList.add('active'); if(tabId === 'analitica') app.renderCharts(); else if (tabId === 'gestion') app.renderEventGrid(currentEventProjectTypeFilter); else if(tabId === 'otros') app.renderOtrosModule(); else if (tabId === 'cronograma') app.switchCronogramaView('calendar'); else if (tabId === 'mis-tareas') app.renderMyTasksTab(); else if (tabId === 'equipo') app.showEquipoListView(); const sidebar = document.getElementById('sidebar'); if(sidebar.classList.contains('open')) sidebar.classList.remove('open'); };
        app.handleAddTask = (eId, f) => { const evento = state.eventos.find(e => e.id === eId); if (evento) { const newTask = createTaskObject(); evento.fases[f].push(newTask); app.logActivity(eId, `creó la tarea: "${newTask.texto}" en la fase ${f}.`); app.saveState(); app.switchChecklistView('list'); } };
        app.handleDeleteTask = (eId, f, tId) => { if(confirm('¿Seguro que desea eliminar esta tarea y todas sus sub-tareas?')) { const e = state.eventos.find(x => x.id === eId); const taskIndex = e.fases[f].findIndex(t => t.id == tId); if(taskIndex > -1) { const deletedTask = e.fases[f].splice(taskIndex, 1)[0]; cleanupDependencies(deletedTask.id); (deletedTask.subtareas || []).forEach(st => cleanupDependencies(st.id)); app.logActivity(eId, `eliminó la tarea: "${deletedTask.texto}" de la fase ${f}.`); app.saveState(); app.render(); app.switchChecklistView('list'); } } };
        app.handleToggleTask = (eId, f, tId) => { const task = state.eventos.find(e => e.id === eId).fases[f].find(x => x.id == tId); if (!app.checkDependencies(task)) return; task.completado = !task.completado; task.estado = task.completado ? 'Completado' : 'En proceso'; app.logActivity(eId, `marcó como ${task.completado ? 'completada' : 'no completada'} la tarea: "${task.texto}".`); if (task.subtareas && Array.isArray(task.subtareas)) { task.subtareas.forEach(subtask => {subtask.completado = task.completado; subtask.estado = subtask.completado ? 'Completado' : 'En proceso';}); } app.saveState(); app.render(); app.switchChecklistView(document.getElementById('checklist-kanban-container').style.display === 'flex' ? 'board' : 'list'); };
        app.handleEditTaskText = (input, eId, f, tId) => { const task = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId); const oldText = task.texto; if (oldText !== input.value) { task.texto = input.value; app.logActivity(eId, `cambió el nombre de la tarea de "${oldText}" a "${task.texto}".`); app.saveState(); } };
        app.handleEditTaskDate = (eId, f, tId, tipoFecha, date) => { const task = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId); const oldDate = task[tipoFecha]; if(oldDate !== date) { task[tipoFecha] = date; app.logActivity(eId, `cambió la ${tipoFecha === 'fechaInicio' ? 'fecha de inicio' : 'fecha de fin'} de la tarea "${task.texto}" a ${app.formatDateTime(date)}.`); app.saveState(); app.render(); } };
        app.handleAddSubtask = (eId, f, tId) => { const parentTask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId); if (!parentTask.subtareas) parentTask.subtareas = []; const newSubtask = createTaskObject('Nueva Sub-tarea (Editar)'); parentTask.subtareas.push(newSubtask); app.logActivity(eId, `añadió la sub-tarea "${newSubtask.texto}" a la tarea "${parentTask.texto}".`); app.saveState(); app.switchChecklistView('list'); };
        app.handleDeleteSubtask = (eId, f, tId, stId) => { if(confirm('¿Seguro que desea eliminar esta sub-tarea?')) { const parentTask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId); const subtaskIndex = parentTask.subtareas.findIndex(st => st.id == stId); if(subtaskIndex > -1) { const deletedSubtask = parentTask.subtareas.splice(subtaskIndex, 1)[0]; cleanupDependencies(deletedSubtask.id); app.logActivity(eId, `eliminó la sub-tarea "${deletedSubtask.texto}" de la tarea "${parentTask.texto}".`); app.saveState(); app.render(); app.switchChecklistView('list'); } } };
        app.handleToggleSubtask = (eId, f, tId, stId) => { const subtask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId); if (!app.checkDependencies(subtask)) return; subtask.completado = !subtask.completado; subtask.estado = subtask.completado ? 'Completado' : 'En proceso'; app.logActivity(eId, `marcó como ${subtask.completado ? 'completada' : 'no completada'} la sub-tarea: "${subtask.texto}".`); app.saveState(); app.render(); app.switchChecklistView(document.getElementById('checklist-kanban-container').style.display === 'flex' ? 'board' : 'list'); };
        app.handleEditSubtaskText = (input, eId, f, tId, stId) => { const subtask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId); const oldText = subtask.texto; if(oldText !== input.value) { subtask.texto = input.value; app.logActivity(eId, `cambió el nombre de una sub-tarea a "${subtask.texto}".`); app.saveState(); } };
        app.handleEditSubtaskDate = (eId, f, tId, stId, tipoFecha, date) => { const subtask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId); const oldDate = subtask[tipoFecha]; if(oldDate !== date) { subtask[tipoFecha] = date; app.logActivity(eId, `cambió la fecha de una sub-tarea a ${app.formatDateTime(date)}.`); app.saveState(); app.render(); } };
        app.openResponsablesModalForTask = (eId, f, tId) => { const tarea = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId); const container = document.getElementById('responsables-checkbox-container'); container.innerHTML = state.equipo.map(m => `<div class="responsable-option"><label><input type="checkbox" value="${m.id}" ${tarea.responsables.includes(String(m.id)) ? 'checked' : ''}>${m.nombre}</label></div>`).join(''); document.getElementById('btn-save-responsables').onclick = () => app.handleSaveResponsablesForTask(eId, f, tId); app.openModal(app.modals.responsables); };
        app.handleSaveResponsablesForTask = (eId, f, tId) => { const task = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId); const oldResponsables = app.getMiembrosNombres(task.responsables); const nuevosResponsables = []; document.querySelectorAll('#responsables-checkbox-container input:checked').forEach(checkbox => {nuevosResponsables.push(checkbox.value);}); task.responsables = nuevosResponsables; const newResponsables = app.getMiembrosNombres(nuevosResponsables); if (oldResponsables !== newResponsables) { app.logActivity(eId, `cambió los responsables de la tarea "${task.texto}" a: ${newResponsables || 'Ninguno'}.`); } app.saveState(); app.render(); app.switchChecklistView(document.getElementById('checklist-kanban-container').style.display === 'flex' ? 'board' : 'list'); app.closeModal(app.modals.responsables); };
        app.openResponsablesModalForSubtask = (eId, f, tId, stId) => { const subtask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId); const container = document.getElementById('responsables-checkbox-container'); container.innerHTML = state.equipo.map(m => `<div class="responsable-option"><label><input type="checkbox" value="${m.id}" ${subtask.responsables.includes(String(m.id)) ? 'checked' : ''}>${m.nombre}</label></div>`).join(''); document.getElementById('btn-save-responsables').onclick = () => app.handleSaveResponsablesForSubtask(eId, f, tId, stId); app.openModal(app.modals.responsables); };
        app.handleSaveResponsablesForSubtask = (eId, f, tId, stId) => { const subtask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId); const oldResponsables = app.getMiembrosNombres(subtask.responsables); const nuevosResponsables = []; document.querySelectorAll('#responsables-checkbox-container input:checked').forEach(checkbox => {nuevosResponsables.push(checkbox.value);}); subtask.responsables = nuevosResponsables; const newResponsables = app.getMiembrosNombres(nuevosResponsables); if (oldResponsables !== newResponsables) { app.logActivity(eId, `cambió los responsables de la sub-tarea "${subtask.texto}" a: ${newResponsables || 'Ninguno'}.`); } app.saveState(); app.render(); app.switchChecklistView('list'); app.closeModal(app.modals.responsables); };
        app.handleEditEventNameClick = (h4Element, eventoId) => {if (!app.isCoordinator()) return; const originalName = h4Element.textContent.trim();h4Element.innerHTML = ''; const input = document.createElement('input');input.type = 'text';input.value = originalName;input.className = 'inline-edit-input';const save = () => {const newName = input.value.trim();if (newName && newName !== originalName) {app.handleSaveEventName(eventoId, newName);} else {h4Element.textContent = originalName;}};input.addEventListener('blur', save);input.addEventListener('keydown', (e) => {if (e.key === 'Enter') {input.blur();} else if (e.key === 'Escape') {h4Element.textContent = originalName; h4Element.focus();}});h4Element.appendChild(input);input.focus();input.select();};
        app.handleSaveEventName = (eventoId, newName) => {const evento = state.eventos.find(e => e.id === eventoId);if (evento) {const oldName = evento.nombre; evento.nombre = newName; app.logActivity(eventoId, `cambió el nombre del evento de "${oldName}" a "${newName}".`);app.saveState();app.render();}};
        app.handleDeleteEvento = (id) => { if(confirm('¿Seguro que desea eliminar este evento?')) { state.eventos = state.eventos.filter(e => e.id !== id); state.eventos.sort((a, b) => (a.order || 0) - (b.order || 0)).forEach((evento, index) => { evento.order = index; }); app.saveState(); app.render(); } };
        app.handleEditMiembro = (id) => { event.stopPropagation(); const m = state.equipo.find(x => x.id == id); document.getElementById('miembro-id').value = m.id; document.getElementById('miembro-nombre').value = m.nombre; document.getElementById('miembro-rol').value = m.rol || ''; document.getElementById('miembro-contacto').value = m.contacto || ''; document.getElementById('modal-miembro-title').innerText = 'Editar Miembro'; app.openModal(app.modals.miembro); };
        app.handleDeleteMiembro = (id) => { event.stopPropagation(); if(confirm('¿Está seguro? Las tareas y pagos asignados a esta persona se eliminarán.')) { state.equipo = state.equipo.filter(m => m.id != id); state.eventos.forEach(e => app.getAllTasksForEvent(e).forEach(t => { t.responsables = t.responsables.filter(rId => rId != id); })); app.saveState(); app.render(); } };
        app.handleTableSort = (table, key) => { const sortConfig = app.tableSortState[table]; if (sortConfig.key === key) { sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc'; } else { sortConfig.key = key; sortConfig.direction = 'asc'; } document.querySelectorAll(`#tabla-${table} .sort-icon`).forEach(icon => { icon.className = 'fas fa-sort sort-icon'; }); const iconEl = document.getElementById(`sort-icon-${table}-${key}`); if(iconEl) iconEl.className = `fas fa-sort-${sortConfig.direction === 'asc' ? 'up' : 'down'} sort-icon`; if (table === 'equipo') { app.renderEquipoTable(document.getElementById('equipo-search-input').value); } };
        app.showDayDetails = (dateStr, dayData) => {
            const dateObj = new Date(dateStr + 'T00:00:00');
            document.getElementById('day-tasks-title').textContent = `Detalle del Día: ${dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            const contentContainer = document.getElementById('day-tasks-content');
            let listHtml = '<div id="day-tasks-list-container"><ul id="day-tasks-list" style="padding:0;">';
        
            const renderItem = (icon, color, title, details, actions = '') =>
                `<li class="day-task-item">
                    <div class="day-task-status" style="color:${color};">${icon}</div>
                    <div class="day-task-info"><strong>${title}</strong><small>${details}</small></div>
                    <div class="day-task-actions">${actions}</div>
                 </li>`;
        
            if (dayData.hitos && dayData.hitos.length > 0) {
                listHtml += `<h4 class="modal-day-section-title"><i class="fas fa-flag"></i> Hitos</h4>`;
                dayData.hitos.forEach(h => {
                    const actions = `<button class="icon-btn" title="Editar Hito" onclick="app.openHitoModal('${h.id}')"><i class="fas fa-edit"></i></button><button class="icon-btn" title="Eliminar Hito" onclick="app.deleteHito('${h.id}')"><i class="fas fa-trash" style="color:var(--danger-color)"></i></button>`;
                    listHtml += renderItem('<i class="fas fa-flag"></i>', 'var(--primary-color)', h.nombre, `Hito del proyecto`, actions);
                });
            }
            if (dayData.eventos && dayData.eventos.length > 0) {
                listHtml += `<h4 class="modal-day-section-title"><i class="fas fa-play-circle"></i> Eventos que inician</h4>`;
                dayData.eventos.forEach(e => listHtml += renderItem('<i class="fas fa-flag-checkered"></i>', 'var(--danger-color)', e.nombre, `Tipo: ${e.projectType || 'N/A'}`));
            }
            if (dayData.tareas && dayData.tareas.length > 0) {
                listHtml += `<h4 class="modal-day-section-title"><i class="fas fa-tasks"></i> Tareas activas</h4>`;
                dayData.tareas.forEach(t => {
                    const icon = t.completado ? `<i class="fas fa-check-circle" style="color: var(--success-color);"></i>` : `<i class="fas fa-spinner fa-spin"></i>`;
                    listHtml += renderItem(icon, '', t.texto, `Evento: ${t.eventoNombre} | Responsables: ${app.getMiembrosNombres(t.responsables) || 'N/A'}`);
                });
            }
            if (dayData.ausencias && dayData.ausencias.length > 0) {
                listHtml += `<h4 class="modal-day-section-title"><i class="fas fa-user-clock"></i> Personal Ausente</h4>`;
                dayData.ausencias.forEach(a => {
                    const actions = `<button class="icon-btn" title="Editar Ausencia" onclick="app.openAusenciaModal('${a.id}')"><i class="fas fa-edit"></i></button><button class="icon-btn" title="Eliminar Ausencia" onclick="app.deleteAusencia('${a.id}')"><i class="fas fa-trash" style="color:var(--danger-color)"></i></button>`;
                    listHtml += renderItem('<i class="fas fa-user-slash"></i>', 'var(--warning-color)', app.getMiembroNombre(a.miembroId), `Motivo: ${a.motivo}`, actions);
                });
            }
            if (dayData.finanzas && dayData.finanzas.length > 0) {
                listHtml += `<h4 class="modal-day-section-title"><i class="fas fa-coins"></i> Períodos de Pago Activos</h4>`;
                [...new Set(dayData.finanzas.map(f => f.concepto))].forEach(concepto => listHtml += renderItem('<i class="fas fa-file-invoice-dollar"></i>', 'var(--secondary-color)', concepto, `Pagos activos para uno o más miembros`));
            }
            listHtml += '</ul></div>';
            contentContainer.innerHTML = listHtml;
            app.openModal(app.modals.dayTasks);
        };
        app.renderMemberFinanceView = (miembroId) => { const miembro = state.equipo.find(m => m.id == miembroId); const detailView = document.getElementById('equipo-finanzas-view'); if (!miembro) { detailView.innerHTML = `<p>Error: Miembro no encontrado.</p>`; return; } const renderPagosListHTML = (tipo) => { const pagos = miembro[tipo] || []; if (pagos.length === 0) return emptyStateMsg(`No hay pagos de ${tipo} registrados.`); return `<div class="finanzas-pagos-list">` + pagos.map(p => `<div class="finanzas-pago-item" data-pago-id="${p.id}"><span>${p.concepto || 'Sin concepto'}</span><span>${app.formatDate(p.fechaInicio)} al ${app.formatDate(p.fechaFin)}</span><span>${app.formatCurrency(p.valor)}</span><div class="finanzas-pago-actions"><button class="btn btn-warning btn-sm" onclick="app.handleEditPago('${miembro.id}', '${tipo}', '${p.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" onclick="app.handleDeletePago('${miembro.id}', '${tipo}', '${p.id}')"><i class="fas fa-trash"></i></button></div></div>`).join('') + `</div>`; }; const eventoOptions = `<option value="">No asociar / Gasto General</option>${state.eventos.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('')}`; detailView.innerHTML = ` <div class="card"> <div class="card-header"> <h3><i class="fas fa-user-circle"></i> Gestión de Pagos: ${miembro.nombre}</h3> <button class="btn btn-secondary" onclick="app.showMemberProfile('${miembroId}')"><i class="fas fa-arrow-left"></i> Volver al Perfil</button> </div> <div class="card-body"> <div class="finanzas-detail-grid"> <div class="card"> <div class="card-header"><h4><i class="fas fa-file-invoice-dollar"></i> Honorarios</h4></div> <div class="card-body"> ${renderPagosListHTML('honorarios')} <form class="finanzas-add-pago-form" onsubmit="event.preventDefault(); app.handleAddPago('${miembro.id}', 'honorarios');"> <div class="form-group" style="grid-column: 1 / -1;"><label>Asociar a Evento (Opcional)</label><select id="honorario-evento-asociado-${miembro.id}">${eventoOptions}</select></div> <div class="form-group"><label>Concepto</label><input type="text" id="honorario-concepto-${miembro.id}" required></div> <div class="form-group"><label>Valor</label><input type="number" id="honorario-valor-${miembro.id}" required></div> <div class="form-group"><label>Fecha Inicio</label><input type="date" id="honorario-fechaInicio-${miembro.id}" required></div> <div class="form-group"><label>Fecha Fin</label><input type="date" id="honorario-fechaFin-${miembro.id}" required></div> <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Añadir Honorario</button> </form> </div> </div> <div class="card"> <div class="card-header"><h4><i class="fas fa-route"></i> Desplazamientos</h4></div> <div class="card-body"> ${renderPagosListHTML('desplazamientos')} <form class="finanzas-add-pago-form" onsubmit="event.preventDefault(); app.handleAddPago('${miembro.id}', 'desplazamientos');"> <div class="form-group" style="grid-column: 1 / -1;"><label>Asociar a Evento (Opcional)</label><select id="desplazamiento-evento-asociado-${miembro.id}">${eventoOptions}</select></div> <div class="form-group"><label>Concepto</label><input type="text" id="desplazamiento-concepto-${miembro.id}" required></div> <div class="form-group"><label>Valor</label><input type="number" id="desplazamiento-valor-${miembro.id}" required></div> <div class="form-group"><label>Fecha Inicio</label><input type="date" id="desplazamiento-fechaInicio-${miembro.id}" required></div> <div class="form-group"><label>Fecha Fin</label><input type="date" id="desplazamiento-fechaFin-${miembro.id}" required></div> <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Añadir Desplazamiento</button> </form> </div> </div> </div> </div> </div> `; };
        app.handleAddPago = (miembroId, tipo) => { const miembro = state.equipo.find(m => m.id == miembroId); const tipoSingular = tipo.slice(0, -1); const concepto = document.getElementById(`${tipoSingular}-concepto-${miembroId}`).value; const valor = document.getElementById(`${tipoSingular}-valor-${miembroId}`).value; const fechaInicio = document.getElementById(`${tipoSingular}-fechaInicio-${miembroId}`).value; const fechaFin = document.getElementById(`${tipoSingular}-fechaFin-${miembroId}`).value; const eventoId = document.getElementById(`${tipoSingular}-evento-asociado-${miembroId}`).value || null; if (!concepto || !valor || !fechaInicio || !fechaFin) { alert('Todos los campos son obligatorios.'); return; } if (new Date(fechaFin) < new Date(fechaInicio)) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; } if(!miembro[tipo]) miembro[tipo] = []; miembro[tipo].push({ id: Date.now(), concepto, valor: parseFloat(valor), fechaInicio, fechaFin, eventoId }); app.saveState(); app.renderMemberFinanceView(miembroId); };
        app.handleDeletePago = (miembroId, tipo, pagoId) => { const miembro = state.equipo.find(m => m.id == miembroId); miembro[tipo] = miembro[tipo].filter(p => p.id != pagoId); app.saveState(); app.renderMemberFinanceView(miembroId); };
        app.handleEditPago = (miembroId, tipo, pagoId) => { const miembro = state.equipo.find(m => m.id == miembroId); const pago = (miembro[tipo] || []).find(p => p.id == pagoId); if (!pago) return; document.getElementById('edit-pago-miembro-id').value = miembroId; document.getElementById('edit-pago-id').value = pago.id; document.getElementById('edit-pago-tipo').value = tipo; document.getElementById('edit-pago-concepto').value = pago.concepto; document.getElementById('edit-pago-valor').value = pago.valor; document.getElementById('edit-pago-fechaInicio').value = pago.fechaInicio; document.getElementById('edit-pago-fechaFin').value = pago.fechaFin; const eventoSelect = document.getElementById('edit-pago-evento-asociado'); eventoSelect.innerHTML = `<option value="">No asociar / Gasto General</option>${state.eventos.map(e => `<option value="${e.id}" ${pago.eventoId === e.id ? 'selected' : ''}>${e.nombre}</option>`).join('')}`; app.openModal(app.modals.editPago); };
        app.handleBulkAddMiembros = () => { const textarea = document.getElementById('bulk-miembro-names'); const names = textarea.value.split('\n').map(name => name.trim()).filter(Boolean); if (names.length === 0) { alert('Por favor, ingrese al menos un nombre.'); return; } let newMembersAdded = 0; const existingNames = new Set(state.equipo.map(m => m.nombre.toLowerCase())); names.forEach(name => { if (!existingNames.has(name.toLowerCase())) { state.equipo.push({ id: 'user-' + (Date.now() + Math.random()), nombre: name, rol: 'Gestor', contacto: '', honorarios: [], desplazamientos: [] }); newMembersAdded++; } }); if (newMembersAdded > 0) { app.saveState(); app.render(); app.setupUserSelector(); alert(`Se añadieron ${newMembersAdded} nuevos miembros.`); textarea.value = ''; app.closeModal(app.modals.bulkMiembro); } else { alert('No se añadieron nuevos miembros. Es posible que ya existan en la lista.'); } };
        app.openDescripcionModal = (eventoId) => { const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; document.getElementById('descripcion-evento-id').value = eventoId; document.getElementById('modal-descripcion-title').textContent = `Descripción de: ${evento.nombre}`; const viewContainer = document.querySelector('#descripcion-view-container .ql-editor'); viewContainer.innerHTML = evento.descripcion || '<p><i>No hay descripción. Haga clic en "Editar" para añadir una.</i></p>'; document.getElementById('descripcion-view-container').style.display = 'block'; document.getElementById('descripcion-editor-container').style.display = 'none'; document.getElementById('btn-enter-edit-mode').style.display = 'inline-block'; document.getElementById('descripcion-actions-container').style.display = 'none'; app.openModal(app.modals.descripcion); };
        app.handleSaveDescripcion = () => { const eventoId = document.getElementById('descripcion-evento-id').value; const evento = state.eventos.find(e => e.id === eventoId); if (!evento || !quillEditor) return; const oldDescription = evento.descripcion; const newDescription = quillEditor.root.innerHTML; evento.descripcion = (newDescription === '<p><br></p>') ? '' : newDescription; if (oldDescription !== newDescription) { app.logActivity(eventoId, 'actualizó la descripción del evento.'); } app.saveState(); const viewContainer = document.querySelector('#descripcion-view-container .ql-editor'); viewContainer.innerHTML = evento.descripcion || '<p><i>No hay descripción. Haga clic en "Editar" para añadir una.</i></p>'; document.getElementById('descripcion-view-container').style.display = 'block'; document.getElementById('descripcion-editor-container').style.display = 'none'; document.getElementById('btn-enter-edit-mode').style.display = 'inline-block'; document.getElementById('descripcion-actions-container').style.display = 'none'; };
        
        // ------------------------------------------------------------------
        // --- INICIO DE LA SECCIÓN CORREGIDA PARA EL DRAG-AND-DROP DEL KANBAN ---
        // ------------------------------------------------------------------

        /**
         * Encuentra la referencia directa a un objeto de tarea (o subtarea) dentro del estado de la aplicación.
         * Esto es crucial para asegurar que las modificaciones se hagan en el objeto original y no en una copia.
         * @param {string} eventoId - El ID del evento que contiene la tarea.
         * @param {string} taskId - El ID de la tarea o subtarea a encontrar.
         * @returns {object|null} La referencia directa al objeto de la tarea, o null si no se encuentra.
         */
        const findTaskReferenceInState = (eventoId, taskId) => {
            const evento = state.eventos.find(e => e.id === eventoId);
            if (!evento || !evento.fases) return null;

            for (const fase of Object.values(evento.fases)) {
                if (!Array.isArray(fase)) continue;
                
                // Buscar en tareas principales
                for (const taskRef of fase) {
                    if (taskRef.id === taskId) return taskRef;

                    // Si no se encuentra, buscar en subtareas
                    if (taskRef.subtareas && Array.isArray(taskRef.subtareas)) {
                        const subtaskRef = taskRef.subtareas.find(st => st.id === taskId);
                        if (subtaskRef) return subtaskRef;
                    }
                }
            }
            return null; // No se encontró en ninguna parte
        };
        
        /**
         * Actualiza el estado de una tarea. Esta es la función central para cambios de estado,
         * ya sea desde la lista, el menú desplegable o el drag-and-drop del Kanban.
         * @param {string} eventoId - El ID del evento.
         * @param {string} taskId - El ID de la tarea a modificar.
         * @param {string} newStatusValue - El nuevo valor del estado (ej. 'En Revisión').
         * @returns {boolean} - true si la actualización fue exitosa, false en caso contrario.
         */
        const updateTaskStatus = (eventoId, taskId, newStatusValue) => {
            const taskInState = findTaskReferenceInState(eventoId, taskId);

            if (!taskInState) {
                console.error("Error Crítico: No se pudo encontrar la referencia de la tarea en el estado para el ID:", taskId);
                return false;
            }

            const formattedStatus = newStatusValue.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const currentStatus = taskInState.completado ? 'Completado' : taskInState.estado;

            if (currentStatus === formattedStatus) {
                return true; // No hay cambio, operación exitosa.
            }

            // La comprobación de dependencias debe ocurrir antes de cambiar el estado
            if (!app.checkDependencies(taskInState)) {
                return false; // Falló la comprobación de dependencias. La acción debe ser revertida.
            }

            const oldStatus = taskInState.estado;
            taskInState.estado = formattedStatus;
            taskInState.completado = (formattedStatus === 'Completado');
            
            // Si la tarea principal se marca como completada, completar también las subtareas.
            if (taskInState.completado && taskInState.subtareas && taskInState.subtareas.length > 0) {
                taskInState.subtareas.forEach(st => {
                    st.completado = true;
                    st.estado = 'Completado';
                });
            }

            app.logActivity(eventoId, `cambió el estado de la tarea "${taskInState.texto}" de "${oldStatus}" a "${formattedStatus}".`);
            app.saveState();
            return true;
        };
        
        // ----------------------------------------------------------------
        // --- FIN DE LA SECCIÓN CORREGIDA ---
        // ----------------------------------------------------------------

        app.handleUpdateTaskStatus = (eId, f, tId, newStatus) => { 
            if(updateTaskStatus(eId, tId, newStatus)) {
                // El renderizado es manejado por la función que llama a esta.
                // Aquí, la llamada viene de la vista de lista, que ya se encarga de re-renderizar.
                app.switchChecklistView('list');
            }
        };
        app.handleUpdateSubtaskStatus = (eId, f, tId, stId, newStatus) => {
            if(updateTaskStatus(eId, stId, newStatus)) {
                app.switchChecklistView('list');
            }
        };
        app.openObservacionModal = (eId, f, tId, stId = null) => { const task = stId ? state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId).subtareas.find(st=>st.id==stId) : state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId); if (!task) return; document.getElementById('observacion-task-path-eid').value = eId; document.getElementById('observacion-task-path-f').value = f; document.getElementById('observacion-task-path-tid').value = tId; document.getElementById('observacion-task-path-stid').value = stId || ''; document.getElementById('modal-observacion-title').textContent = `Observaciones para: ${task.texto}`; const viewContainer = document.querySelector('#observacion-view-container .ql-editor'); viewContainer.innerHTML = task.observacion || '<p><i>No hay observaciones. Haga clic en "Editar" para añadir una.</i></p>'; document.getElementById('observacion-view-container').style.display = 'block'; document.getElementById('observacion-editor-container').style.display = 'none'; document.getElementById('btn-enter-observacion-edit-mode').style.display = 'inline-block'; document.getElementById('observacion-actions-container').style.display = 'none'; document.getElementById('btn-enter-observacion-edit-mode').disabled = !app.canEditTask(task); app.openModal(app.modals.observacion); };
        app.handleSaveObservacion = () => { const eId = document.getElementById('observacion-task-path-eid').value; const f = document.getElementById('observacion-task-path-f').value; const tId = document.getElementById('observacion-task-path-tid').value; const stId = document.getElementById('observacion-task-path-stid').value; const task = stId ? state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId).subtareas.find(st=>st.id==stId) : state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId); if (!task || !quillObservacionEditor) return; const newObservacion = quillObservacionEditor.root.innerHTML; const oldObservacion = task.observacion; task.observacion = (newObservacion === '<p><br></p>') ? '' : newObservacion; if (oldObservacion !== newObservacion) { app.logActivity(eId, `actualizó las observaciones de la tarea "${task.texto}".`); } app.saveState(); const viewContainer = document.querySelector('#observacion-view-container .ql-editor'); viewContainer.innerHTML = task.observacion || '<p><i>No hay observaciones. Haga clic en "Editar" para añadir una.</i></p>'; document.getElementById('observacion-view-container').style.display = 'block'; document.getElementById('observacion-editor-container').style.display = 'none'; document.getElementById('btn-enter-observacion-edit-mode').style.display = 'inline-block'; document.getElementById('observacion-actions-container').style.display = 'none'; app.switchChecklistView(document.getElementById('checklist-kanban-container').style.display === 'flex' ? 'board' : 'list'); };
        app.addOtroItem = () => { state.otros.push({ id: 'otro-' + Date.now(), title: 'Nueva Lista (Haz clic para editar)', content: '' }); app.saveState(); app.renderOtrosModule(); }; app.deleteOtroItem = (id) => { if (confirm('¿Seguro que quieres eliminar esta lista y todo su contenido?')) { state.otros = state.otros.filter(item => item.id !== id); app.saveState(); app.renderOtrosModule(); } }; app.editOtroItemTitle = (h4, id) => { const originalTitle = h4.textContent.trim(); h4.innerHTML = `<input type="text" class="inline-edit-input" value="${originalTitle}">`; const input = h4.querySelector('input'); input.focus(); input.select(); const save = () => { const newTitle = input.value.trim(); const item = state.otros.find(i => i.id === id); if (item && newTitle) { item.title = newTitle; app.saveState(); } h4.textContent = item.title; }; input.addEventListener('blur', save); input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); if (e.key === 'Escape') { h4.textContent = originalTitle; } }); }; app.toggleOtroItem = (headerEl) => { const itemEl = headerEl.parentElement; const editorId = `otro-editor-${itemEl.dataset.id}`; const item = state.otros.find(i => i.id === itemEl.dataset.id); itemEl.classList.toggle('open'); if (itemEl.classList.contains('open')) { if (!app.activeQuillEditors[editorId]) { const quill = new Quill(`#${editorId}`, { theme: 'snow', placeholder: 'Escribe aquí...' }); quill.root.innerHTML = item.content || ''; app.activeQuillEditors[editorId] = quill; } } else { if (app.activeQuillEditors[editorId]) { item.content = app.activeQuillEditors[editorId].root.innerHTML; app.saveState(); app.activeQuillEditors[editorId] = null; delete app.activeQuillEditors[editorId]; document.getElementById(editorId).innerHTML = ''; } } };
        app.openTransferModal = (eId, f, tId, stId = null) => { const path = { eId, f, tId, stId }; const task = stId ? state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId).subtareas.find(st=>st.id==stId) : state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId); if (!task) { alert('Error: no se encontró la tarea a transferir.'); return; } document.getElementById('transfer-task-name').textContent = task.texto; document.getElementById('transfer-task-path').value = JSON.stringify(path); const destinationSelect = document.getElementById('transfer-destination-event'); destinationSelect.innerHTML = state.eventos.filter(e => e.id !== eId).map(e => `<option value="${e.id}">${e.nombre}</option>`).join(''); if(destinationSelect.innerHTML === '') { alert('No hay otros eventos a los que transferir la tarea.'); return; } app.openModal(app.modals.transferTask); };
        app.handleTransferTask = () => { const path = JSON.parse(document.getElementById('transfer-task-path').value); const destinationEventId = document.getElementById('transfer-destination-event').value; const sourceEvent = state.eventos.find(e => e.id === path.eId); const destinationEvent = state.eventos.find(e => e.id === destinationEventId); if (!sourceEvent || !destinationEvent) { alert('Error: Evento de origen o destino no encontrado.'); return; } let taskToMove; if (path.stId) { const parentTask = sourceEvent.fases[path.f].find(t => t.id == path.tId); const subtaskIndex = parentTask.subtareas.findIndex(st => st.id == path.stId); if (subtaskIndex > -1) { taskToMove = parentTask.subtareas.splice(subtaskIndex, 1)[0]; } } else { const taskIndex = sourceEvent.fases[path.f].findIndex(t => t.id == path.tId); if (taskIndex > -1) { taskToMove = sourceEvent.fases[path.f].splice(taskIndex, 1)[0]; } } if (taskToMove) { if (!destinationEvent.fases.planeacion) { destinationEvent.fases.planeacion = []; } destinationEvent.fases.planeacion.push(taskToMove); app.logActivity(sourceEvent.id, `transfirió la tarea "${taskToMove.texto}" al evento "${destinationEvent.nombre}".`); app.logActivity(destinationEvent.id, `recibió la tarea "${taskToMove.texto}" desde el evento "${sourceEvent.nombre}".`); app.saveState(); app.closeModal(app.modals.transferTask); app.switchChecklistView('list'); app.render(); } else { alert('Error: No se pudo encontrar y mover la tarea.'); } };
        app.openResponsablesEventoModal = () => { const eventoId = document.getElementById('edit-evento-id').value; const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; const container = document.getElementById('responsables-evento-checkbox-container'); container.innerHTML = state.equipo.map(m => `<div class="responsable-option"><label><input type="checkbox" value="${m.id}" ${(evento.responsablesEvento || []).includes(m.id) ? 'checked' : ''}>${m.nombre}</label></div>`).join(''); document.getElementById('btn-save-responsables-evento').onclick = () => app.handleSaveResponsablesEvento(eventoId); app.openModal(app.modals.responsablesEvento); };
        app.handleSaveResponsablesEvento = (eventoId) => { const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; const nuevosResponsables = []; document.querySelectorAll('#responsables-evento-checkbox-container input:checked').forEach(checkbox => { nuevosResponsables.push(checkbox.value); }); evento.responsablesEvento = nuevosResponsables; app.logActivity(eventoId, `actualizó los responsables generales del evento.`); app.saveState(); app.closeModal(app.modals.responsablesEvento); alert('Responsables del evento guardados.'); };
        app.handleDownloadCronogramaReport = () => { const reportData = []; const monthNames = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"]; state.eventos.forEach(evento => { if (!evento.fechaInicio) return; const startDate = new Date(evento.fechaInicio); const row = { 'Nombre del evento': evento.nombre, 'Proyecto': 'Comercialización', 'Día': startDate.getDate(), 'Mes': monthNames[startDate.getMonth()], 'Hora de inicio': '', 'Municipio': evento.municipio || '', 'Presencial / Virtual': evento.modalidad || '', 'Líder jornada': app.getMiembroNombre(evento.liderId), 'Responsables que acompañan': app.getMiembrosNombres(evento.responsablesEvento), 'Necesita Orden de salida': evento.necesitaOrdenSalida ? 'Si' : 'No', 'Objeto de salida': app.stripHtml(evento.descripcion), '¿Se debe hacer M.A.?': evento.requiereMA ? 'Si' : 'No', 'Link Memoria de la Actividad': evento.linkMA || '' }; reportData.push(row); }); if (reportData.length === 0) { alert("No hay eventos con fechas definidas para generar el reporte."); return; } const headers = [ "Nombre del evento", "Proyecto", "Día", "Mes", "Hora de inicio", "Municipio", "Presencial / Virtual", "Líder jornada", "Responsables que acompañan", "Necesita Orden de salida", "Objeto de salida", "¿Se debe hacer M.A.?", "Link Memoria de la Actividad" ]; const ws = XLSX.utils.json_to_sheet(reportData, { header: headers }); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Cronograma Eventos"); XLSX.writeFile(wb, "Reporte_Cronograma_Eventos.xlsx"); };
        app.performGlobalSearch = (query) => { if (!query || query.length < 3) { document.getElementById('global-search-results-container').innerHTML = emptyStateMsg('Escribe al menos 3 caracteres para buscar.'); return; } const lowerQuery = query.toLowerCase(); const results = []; const regex = new RegExp(lowerQuery.replace(/ /g, '|'), 'gi'); const highlight = (text) => text.replace(regex, match => `<span class="highlight">${match}</span>`); state.eventos.forEach(e => { if (e.nombre.toLowerCase().includes(lowerQuery)) { results.push({ type: 'Evento', icon: 'fa-calendar-check', name: e.nombre, context: `Tipo: ${e.projectType}`, highlightedName: highlight(e.nombre), action: () => { app.handleTabClick({ currentTarget: document.querySelector('.nav-link[data-tab="gestion"]') }); setTimeout(() => app.handleEditEventDetails(e.id), 100); } }); } if (e.descripcion && app.stripHtml(e.descripcion).toLowerCase().includes(lowerQuery)) { results.push({ type: 'Evento (Descripción)', icon: 'fa-file-alt', name: e.nombre, context: app.stripHtml(e.descripcion).substring(0, 100) + '...', highlightedName: highlight(e.nombre), action: () => { app.handleTabClick({ currentTarget: document.querySelector('.nav-link[data-tab="gestion"]') }); setTimeout(() => app.openDescripcionModal(e.id), 100); } }); } app.getAllTasksForEvent(e).forEach(t => { if (t.texto.toLowerCase().includes(lowerQuery)) { results.push({ type: 'Tarea', icon: 'fa-check-square', name: t.texto, context: `En evento: ${e.nombre}`, highlightedName: highlight(t.texto), action: () => { app.handleTabClick({ currentTarget: document.querySelector('.nav-link[data-tab="gestion"]') }); setTimeout(() => app.openChecklistModal(e.id), 100); } }); } }); }); state.equipo.forEach(m => { if (m.nombre.toLowerCase().includes(lowerQuery)) { results.push({ type: 'Miembro de Equipo', icon: 'fa-user', name: m.nombre, context: `Gestión de Equipo`, highlightedName: highlight(m.nombre), action: () => { app.handleTabClick({ currentTarget: document.querySelector('.nav-link[data-tab="equipo"]') }); document.getElementById('equipo-search-input').value = m.nombre; app.renderEquipoTable(m.nombre); } }); } [...(m.honorarios || []), ...(m.desplazamientos || [])].forEach(p => { if (p.concepto.toLowerCase().includes(lowerQuery)) { results.push({ type: 'Pago', icon: 'fa-money-bill-wave', name: p.concepto, context: `Pago a ${m.nombre}`, highlightedName: highlight(p.concepto), action: () => { app.handleTabClick({ currentTarget: document.querySelector('.nav-link[data-tab="equipo"]') }); setTimeout(() => app.showMemberFinanceView(m.id), 100); } }); } }); }); state.otros.forEach(o => { if (o.title.toLowerCase().includes(lowerQuery)) { results.push({ type: 'Lista Personalizada', icon: 'fa-stream', name: o.title, context: `Sección "Otros"`, highlightedName: highlight(o.title), action: () => { app.handleTabClick({ currentTarget: document.querySelector('.nav-link[data-tab="otros"]') }); } }); } if (app.stripHtml(o.content).toLowerCase().includes(lowerQuery)) { results.push({ type: 'Contenido de Lista', icon: 'fa-file-alt', name: o.title, context: `En lista "${o.title}"`, highlightedName: highlight(o.title), action: () => { app.handleTabClick({ currentTarget: document.querySelector('.nav-link[data-tab="otros"]') }); } }); } }); app.renderGlobalSearchResults(results, query); };
        app.renderGlobalSearchResults = (results, query) => { const container = document.getElementById('global-search-results-container'); document.getElementById('global-search-title').textContent = `Resultados para "${query}"`; if (results.length === 0) { container.innerHTML = emptyStateMsg('No se encontraron resultados.'); return; } const groupedResults = results.reduce((acc, r) => { (acc[r.type] = acc[r.type] || []).push(r); return acc; }, {}); container.innerHTML = Object.entries(groupedResults).map(([type, items]) => { return `<div class="search-result-group"><h4>${type} (${items.length})</h4>` + items.map(r => `<div class="search-result-item" data-action-index="${results.indexOf(r)}"> <i class="fas ${r.icon} search-result-icon"></i> <div class="search-result-info"> <strong>${r.highlightedName}</strong> <span>${r.context}</span> </div> </div>`).join('') + '</div>'; }).join(''); container.querySelectorAll('.search-result-item').forEach(item => { item.onclick = () => { const index = parseInt(item.dataset.actionIndex, 10); results[index].action(); app.closeModal(app.modals.globalSearch); }; }); };
        app.openEventoFinanzasModal = (eventoId) => { const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; document.getElementById('evento-finanzas-title').textContent = `Finanzas de: ${evento.nombre}`; app.renderEventoFinanzas(eventoId); app.openModal(app.modals.eventoFinanzas); };
        app.renderEventoFinanzas = (eventoId) => { const evento = state.eventos.find(e => e.id === eventoId); const container = document.getElementById('evento-finanzas-container'); if (!evento) return; const gastosPersonal = state.equipo.flatMap(m => [...(m.honorarios || []).map(p => ({...p, tipo: 'Personal', miembroId: m.id})), ...(m.desplazamientos || []).map(p => ({...p, tipo: 'Personal', miembroId: m.id}))]).filter(p => p.eventoId === eventoId); const gastosGenerales = (state.gastosGenerales || []).filter(g => g.eventoId === eventoId).map(g => ({...g, tipo: 'General'})); const todosLosGastos = [...gastosPersonal, ...gastosGenerales].sort((a,b) => new Date(a.fechaInicio || a.fecha) - new Date(b.fechaInicio || b.fecha)); const gastoTotal = todosLosGastos.reduce((sum, gasto) => sum + (Number(gasto.valor) || 0), 0); const presupuesto = Number(evento.presupuesto) || 0; const saldo = presupuesto - gastoTotal; container.innerHTML = ` <div class="finance-summary-grid"> <div class="summary-card budget"> <h4>Presupuesto Asignado</h4> <div class="amount">${app.formatCurrency(presupuesto)}</div> </div> <div class="summary-card spent"> <h4>Gasto Total Ejecutado</h4> <div class="amount">${app.formatCurrency(gastoTotal)}</div> </div> <div class="summary-card balance ${saldo < 0 ? 'negative' : ''}"> <h4>Saldo Restante</h4> <div class="amount">${app.formatCurrency(saldo)}</div> </div> </div> <div class="evento-finanzas-body"> <div class="card"> <div class="card-header"><h4><i class="fas fa-list-ul"></i> Desglose de Gastos</h4></div> <div class="card-body"> <div class="table-responsive" style="max-height: 400px; overflow-y: auto;"> <table> <thead> <tr> <th>Fecha</th> <th>Concepto</th> <th>Tipo</th> <th>Responsable/Item</th> <th>Valor</th> <th>Acc.</th> </tr> </thead> <tbody> ${todosLosGastos.map(g => ` <tr> <td>${app.formatDate(g.fechaInicio || g.fecha)}</td> <td>${g.concepto}</td> <td>${g.tipo}</td> <td>${g.miembroId ? app.getMiembroNombre(g.miembroId) : 'N/A'}</td> <td>${app.formatCurrency(g.valor)}</td> <td> ${g.tipo === 'General' ? `<div class="finanzas-pago-actions"><button class="btn btn-warning btn-sm" onclick="app.openEditGastoGeneralModal('${eventoId}', '${g.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" onclick="app.handleDeleteGastoGeneral('${eventoId}', '${g.id}')"><i class="fas fa-trash"></i></button></div>` : ''} </td> </tr> `).join('') || `<tr><td colspan="6" class="empty-state">No hay gastos asociados.</td></tr>`} </tbody> </table> </div> </div> </div> <div class="card"> <div class="card-header"><h4><i class="fas fa-plus-circle"></i> Añadir Gasto General</h4></div> <div class="card-body"> <form id="form-add-general-expense" class="add-expense-form" onsubmit="event.preventDefault(); app.handleAddGeneralExpense('${eventoId}')"> <div class="form-group"> <label for="gasto-concepto">Concepto</label> <input type="text" id="gasto-concepto" required> </div> <div class="form-group"> <label for="gasto-valor">Valor</label> <input type="number" id="gasto-valor" required> </div> <div class="form-group"> <label for="gasto-fecha">Fecha</label> <input type="date" id="gasto-fecha" required> </div> <button type="submit" class="btn btn-primary" style="width: 100%;">Añadir Gasto</button> </form> </div> </div> </div> `; };
        app.handleAddGeneralExpense = (eventoId) => { const concepto = document.getElementById('gasto-concepto').value; const valor = document.getElementById('gasto-valor').value; const fecha = document.getElementById('gasto-fecha').value; if (!concepto || !valor || !fecha) { alert('Todos los campos son obligatorios.'); return; } const newGasto = { id: Date.now(), eventoId, concepto, valor: parseFloat(valor), fecha }; state.gastosGenerales.push(newGasto); app.logActivity(eventoId, `añadió un gasto general: "${concepto}" por ${app.formatCurrency(valor)}.`); app.saveState(); app.renderEventoFinanzas(eventoId); };
        app.openEditGastoGeneralModal = (eventoId, gastoId) => { const gasto = state.gastosGenerales.find(g => g.id == gastoId); if (!gasto) return; document.getElementById('edit-gasto-evento-id').value = eventoId; document.getElementById('edit-gasto-id').value = gastoId; document.getElementById('edit-gasto-concepto').value = gasto.concepto; document.getElementById('edit-gasto-valor').value = gasto.valor; document.getElementById('edit-gasto-fecha').value = gasto.fecha; app.openModal(app.modals.editGastoGeneral); };
        app.handleUpdateGastoGeneral = () => { const eventoId = document.getElementById('edit-gasto-evento-id').value; const gastoId = document.getElementById('edit-gasto-id').value; const gasto = state.gastosGenerales.find(g => g.id == gastoId); if (!gasto) return; gasto.concepto = document.getElementById('edit-gasto-concepto').value; gasto.valor = parseFloat(document.getElementById('edit-gasto-valor').value); gasto.fecha = document.getElementById('edit-gasto-fecha').value; app.logActivity(eventoId, `actualizó el gasto general: "${gasto.concepto}".`); app.saveState(); app.renderEventoFinanzas(eventoId); app.closeModal(app.modals.editGastoGeneral); };
        app.handleDeleteGastoGeneral = (eventoId, gastoId) => { if (confirm('¿Seguro que desea eliminar este gasto?')) { const index = state.gastosGenerales.findIndex(g => g.id == gastoId); if (index > -1) { const deletedGasto = state.gastosGenerales.splice(index, 1)[0]; app.logActivity(eventoId, `eliminó el gasto general: "${deletedGasto.concepto}".`); app.saveState(); app.renderEventoFinanzas(eventoId); } } };
        app.showActivityLogModal = (eventoId) => { const evento = state.eventos.find(e => e.id === eventoId); if (!evento) return; document.getElementById('activity-log-title').textContent = `Historial de: ${evento.nombre}`; const container = document.getElementById('activity-log-container'); container.innerHTML = (evento.activityLog || []).map(log => `<div class="activity-log-item"> <i class="fas fa-history activity-log-icon"></i> <div class="activity-log-details"> <span class="activity-log-message">${log.user} ${log.message}</span> <span class="activity-log-timestamp">${app.formatDateTime(log.timestamp)}</span> </div> </div>`).join('') || emptyStateMsg('No hay actividades registradas para este evento.'); app.openModal(app.modals.activityLog); };
        app.openSaveTemplateModal = (eventoId) => { document.getElementById('form-save-template').reset(); document.getElementById('template-source-event-id').value = eventoId; app.openModal(app.modals.saveTemplate); };
        app.handleSaveTemplate = () => { const eventoId = document.getElementById('template-source-event-id').value; const templateName = document.getElementById('template-name').value; const sourceEvent = state.eventos.find(e => e.id === eventoId); if (!sourceEvent || !templateName) return; const cleanFases = JSON.parse(JSON.stringify(sourceEvent.fases)); Object.values(cleanFases).forEach(fase => fase.forEach(task => { task.responsables = []; task.fechaInicio = ''; task.fechaFin = ''; task.completado = false; task.estado = 'En proceso'; task.observacion = ''; task.dependencies = []; task.subtareas.forEach(sub => { sub.responsables = []; sub.fechaInicio = ''; sub.fechaFin = ''; sub.completado = false; sub.estado = 'En proceso'; sub.observacion = ''; sub.dependencies = []; }); })); state.eventTemplates.push({ id: 'tpl-' + Date.now(), name: templateName, fases: cleanFases }); app.saveState(); app.closeModal(app.modals.saveTemplate); alert(`Plantilla "${templateName}" guardada con éxito.`); app.renderTemplateManager(); };
        app.renderTemplateManager = () => { const container = document.getElementById('template-manager-container'); if (!container) return; container.innerHTML = ''; if (!state.eventTemplates || state.eventTemplates.length === 0) { container.innerHTML = emptyStateMsg('No hay plantillas guardadas. Cree una desde cualquier evento.'); return; } const table = document.createElement('table'); table.innerHTML = `<thead><tr><th>Nombre de Plantilla</th><th>Acciones</th></tr></thead><tbody>` + state.eventTemplates.map(tpl => `<tr><td>${tpl.name}</td><td class="actions"><button class="btn btn-sm btn-danger" onclick="app.deleteTemplate('${tpl.id}')"><i class="fas fa-trash"></i> Eliminar</button></td></tr>`).join('') + `</tbody>`; container.appendChild(table); };
        app.deleteTemplate = (templateId) => { if (confirm('¿Seguro que desea eliminar esta plantilla?')) { state.eventTemplates = state.eventTemplates.filter(t => t.id !== templateId); app.saveState(); app.renderTemplateManager(); } };
        app.populateTemplateDropdown = () => { const select = document.getElementById('evento-template'); select.innerHTML = '<option value="">Empezar desde cero</option>'; state.eventTemplates.forEach(tpl => { select.innerHTML += `<option value="${tpl.id}">${tpl.name}</option>`; }); };
        app.renderKanbanView = (eventoId) => {
            const evento = state.eventos.find(e => e.id === eventoId);
            const container = document.getElementById('checklist-kanban-container');
            container.innerHTML = '';
            const allTasks = app.getAllTasksForEvent(evento);
            const columns = [...app.taskStates];

            columns.forEach(status => {
                const statusKey = status.replace(/\s+/g, '-');
                const columnEl = document.createElement('div');
                columnEl.className = 'kanban-column';
                columnEl.innerHTML = `<div class="kanban-column-header">${status}</div><div class="kanban-tasks" id="kanban-col-${statusKey}" data-status="${status}"></div>`;
                container.appendChild(columnEl);
            });

            allTasks.forEach(task => {
                const taskStatus = task.completado ? 'Completado' : task.estado;
                const colId = taskStatus.replace(/\s+/g, '-');
                const col = document.getElementById(`kanban-col-${colId}`);
                if (col) {
                    const card = document.createElement('div');
                    card.className = 'kanban-card';
                    card.dataset.taskId = task.id;
                    card.innerHTML = `<h5>${task.texto}</h5><div class="kanban-card-footer"><span>${app.formatDate(task.fechaFin) || 'Sin fecha'}</span><span class="responsables-display" title="${app.getMiembrosNombres(task.responsables)}">${app.getMiembrosNombres(task.responsables) || 'N/A'}</span></div>`;
                    col.appendChild(card);
                }
            });

            Object.values(app.kanbanSortableInstances).forEach(s => s.destroy());
            columns.forEach(status => {
                const statusKey = status.replace(/\s+/g, '-');
                const colEl = document.getElementById(`kanban-col-${statusKey}`);
                if (colEl) {
                    app.kanbanSortableInstances[statusKey] = new Sortable(colEl, {
                        group: 'kanban',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        disabled: !app.isCoordinator() && !app.canEditTask(app.getTaskById(colEl.querySelector('.kanban-card')?.dataset.taskId)),
                        onEnd: (evt) => {
                            const taskId = evt.item.dataset.taskId;
                            const newStatus = evt.to.dataset.status;
                            
                            // Llamar a la función centralizada y robusta
                            if (!updateTaskStatus(eventoId, taskId, newStatus)) {
                                // Si la actualización falla (ej. por dependencias), revertir el cambio visual
                                evt.from.appendChild(evt.item);
                            } else {
                                // Si el cambio fue exitoso, re-renderizar todo el tablero para asegurar consistencia
                                // Esto es más seguro que solo mover el elemento DOM
                                app.renderKanbanView(eventoId);
                                app.render(); // Re-render general para actualizar charts y otros componentes
                            }
                        }
                    });
                }
            });
        };
        // User & Permissions
        app.setupUserSelector = () => { const selector = document.getElementById('user-selector'); if (!selector) return; selector.innerHTML = state.equipo.map(m => `<option value="${m.id}">${m.nombre}</option>`).join(''); selector.value = state.settings.currentUser; };
        app.setCurrentUser = (userId) => { state.settings.currentUser = userId; app.saveState(); app.render(); const myTasksLink = document.querySelector('.nav-link[data-tab="mis-tareas"]'); if (myTasksLink) myTasksLink.click(); };
        app.isCoordinator = () => state.equipo.length > 0 && state.settings.currentUser === state.equipo[0].id;
        app.canEditTask = (task) => { if (!task) return false; if (app.isCoordinator()) return true; return task.responsables.includes(state.settings.currentUser); };
        app.applyPermissions = () => { const isCoord = app.isCoordinator(); document.querySelectorAll('[data-permission="coordinator"]').forEach(el => { el.style.display = isCoord ? '' : 'none'; }); };
        // My Tasks Tab
        app.renderMyTasksTab = () => { const container = document.getElementById('my-tasks-container'); if (!container) return; const userId = state.settings.currentUser; if (!userId) { container.innerHTML = emptyStateMsg('Seleccione un usuario para ver su dashboard.'); return; } const allTasks = app.getAllTasksFlat(); const myTasks = allTasks.filter(t => t.responsables.includes(userId) && !t.completado); const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); const endOfWeek = new Date(today); endOfWeek.setDate(today.getDate() + (7 - today.getDay())); const tasks = { overdue: [], today: [], thisWeek: [], later: [] }; myTasks.forEach(t => { if (!t.fechaFin) { tasks.later.push(t); return; } const dueDate = new Date(t.fechaFin); if (dueDate < today) tasks.overdue.push(t); else if (dueDate.getTime() === today.getTime()) tasks.today.push(t); else if (dueDate <= endOfWeek) tasks.thisWeek.push(t); else tasks.later.push(t); }); const renderTaskGroup = (title, taskList, colorClass) => { if (taskList.length === 0) return ''; return ` <div class="card"> <div class="card-header" style="background-color: var(--${colorClass}-color); color: white;"><h3>${title} (${taskList.length})</h3></div> <div class="card-body" style="padding: 0.5rem 1rem;"> ${taskList.map(t => `<div class="day-task-item" style="cursor:pointer;" onclick="app.openChecklistModal('${t.eventoId}')"> <div class="day-task-status"><i class="fas fa-exclamation-circle" style="color: var(--${colorClass}-color);"></i></div> <div class="day-task-info"> <strong>${t.texto}</strong> <small><strong>Evento:</strong> ${t.eventoNombre} | <strong>Vence:</strong> ${app.formatDate(t.fechaFin)}</small> </div> </div>`).join('')} </div> </div>`; }; container.innerHTML = ` <div class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));"> <div>${renderTaskGroup('Atrasadas', tasks.overdue, 'danger')} ${renderTaskGroup('Para Hoy', tasks.today, 'warning')}</div> <div>${renderTaskGroup('Esta Semana', tasks.thisWeek, 'info')} ${renderTaskGroup('Próximas', tasks.later, 'gray')}</div> </div>`; };
        // Dependencies
        app.highlightTask = (taskId) => { const taskCard = document.querySelector(`.task-card[data-task-id="${taskId}"]`); if (taskCard) { taskCard.scrollIntoView({ behavior: 'smooth', block: 'center' }); taskCard.style.transition = 'background-color 0.2s ease-out, box-shadow 0.2s ease-out'; taskCard.style.backgroundColor = 'color-mix(in srgb, var(--secondary-color) 30%, transparent)'; taskCard.style.boxShadow = '0 0 15px var(--secondary-color)'; setTimeout(() => { taskCard.style.backgroundColor = ''; taskCard.style.boxShadow = ''; }, 2000); } else { alert('La tarea no está visible en la vista actual. Intente cambiar a la vista de lista.'); } };
        app.checkDependencies = (task) => { const incomplete = (task.dependencies || []).map(app.getTaskById).filter(dep => dep && !dep.completado); if (incomplete.length > 0) { alert(`No se puede continuar. Primero debe completar las siguientes tareas:\n- ${incomplete.map(t => t.texto).join('\n- ')}`); return false; } return true; };
        app.openDependenciesModal = (eId, f, tId, stId=null) => { const task = stId ? state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId).subtareas.find(st=>st.id==stId) : state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId); const evento = state.eventos.find(e => e.id === eId); if (!task || !evento) return; document.getElementById('dependency-task-name').textContent = `"${task.texto}"`; const container = document.getElementById('dependencies-checkbox-container'); const descendantIds = stId ? [] : (task.subtareas || []).map(st => st.id); const allPossibleDeps = app.getAllTasksForEvent(evento).filter(t => t.id !== task.id && !descendantIds.includes(t.id)); container.innerHTML = allPossibleDeps.map(t => `<div class="dependency-option"><label><input type="checkbox" value="${t.id}" ${(task.dependencies || []).includes(t.id) ? 'checked' : ''}>${t.texto} <small>(${t.faseNombre})</small></label></div>`).join('') || emptyStateMsg('No hay otras tareas en este evento para establecer dependencias.'); document.getElementById('btn-save-dependencies').onclick = () => app.handleSaveDependencies(eId, f, tId, stId); app.openModal(app.modals.dependencies); };
        app.handleSaveDependencies = (eId, f, tId, stId) => { const task = stId ? state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId).subtareas.find(st=>st.id==stId) : state.eventos.find(e=>e.id==eId).fases[f].find(t=>t.id==tId); const newDeps = []; document.querySelectorAll('#dependencies-checkbox-container input:checked').forEach(cb => newDeps.push(cb.value)); for (const depId of newDeps) { const depTask = app.getTaskById(depId); if (depTask && (depTask.dependencies || []).includes(task.id)) { alert(`Error: Dependencia circular detectada. La tarea "${depTask.texto}" ya depende de "${task.texto}". No se pueden guardar los cambios.`); return; } } task.dependencies = newDeps; app.logActivity(eId, `actualizó las dependencias de la tarea "${task.texto}".`); app.saveState(); app.closeModal(app.modals.dependencies); app.switchChecklistView('list'); };
        // Gantt Chart
        app.switchCronogramaView = (view) => { if (view === 'calendar') { document.getElementById('calendar-view-container').style.display = 'block'; document.getElementById('gantt-view-container').style.display = 'none'; document.getElementById('cronograma-view-calendar-btn').classList.add('active'); document.getElementById('cronograma-view-gantt-btn').classList.remove('active'); } else { document.getElementById('calendar-view-container').style.display = 'none'; document.getElementById('gantt-view-container').style.display = 'block'; document.getElementById('cronograma-view-calendar-btn').classList.remove('active'); document.getElementById('cronograma-view-gantt-btn').classList.add('active'); app.renderGanttChart(); } };
        app.renderGanttChart = () => { const ganttContainer = document.getElementById('gantt-chart-container'); ganttContainer.innerHTML = ''; const tasksWithDates = app.getAllTasksFlat().filter(t => t.fechaInicio && t.fechaFin); const taskIdsWithDates = new Set(tasksWithDates.map(t => t.id)); const ganttData = tasksWithDates.map(t => ({ id: t.id, name: t.texto, start: t.fechaInicio.split('T')[0], end: t.fechaFin.split('T')[0], progress: t.completado ? 100 : 0, dependencies: (t.dependencies || []).filter(depId => taskIdsWithDates.has(depId)).join(','), custom_class: t.completado ? 'bar-complete' : '' })); if (ganttData.length === 0) { ganttContainer.innerHTML = emptyStateMsg('No hay tareas con fechas de inicio y fin para mostrar en el diagrama de Gantt.'); return; } try { new Gantt("#gantt-chart-container", ganttData, { view_modes: ['Day', 'Week', 'Month'], view_mode: 'Week', language: 'es', on_click: (task) => { const taskDetails = app.getAllTasksFlat().find(t => t.id === task.id); if (taskDetails) { const evento = state.eventos.find(e => e.id === taskDetails.eventoId); if (evento) app.openChecklistModal(evento.id); } }, on_date_change: (task, start, end) => { const t = app.getTaskById(task.id); if (t) { t.fechaInicio = new Date(start).toISOString(); t.fechaFin = new Date(end).toISOString(); app.logActivity(t.eventoId, `actualizó las fechas de la tarea "${t.texto}" desde el Gantt.`); app.saveState(); } } }); } catch (e) { console.error("Error al renderizar el Gantt:", e); ganttContainer.innerHTML = emptyStateMsg('Ocurrió un error al generar el diagrama de Gantt. Verifique los datos de las tareas.'); } };
        
        app.handleEditEventDetails = (eventoId) => {
            const evento = state.eventos.find(e => e.id === eventoId);
            if (!evento) return;
            document.getElementById('edit-evento-id').value = evento.id;
            document.getElementById('edit-evento-nombre').value = evento.nombre;
            document.getElementById('edit-evento-fecha-inicio').value = evento.fechaInicio || '';
            document.getElementById('edit-evento-fecha-fin').value = evento.fechaFin || '';
            document.getElementById('edit-evento-proyecto-tipo').value = evento.projectType || '';
            document.getElementById('edit-evento-municipio').value = evento.municipio || '';
            document.getElementById('edit-evento-modalidad').value = evento.modalidad || 'Presencial';
            document.getElementById('edit-evento-presupuesto').value = evento.presupuesto || 0;
            const liderSelect = document.getElementById('edit-evento-lider');
            liderSelect.innerHTML = '<option value="">-- Sin asignar --</option>' + state.equipo.map(m => `<option value="${m.id}" ${evento.liderId === m.id ? 'selected' : ''}>${m.nombre}</option>`).join('');
            liderSelect.value = evento.liderId || '';
            document.getElementById('edit-evento-orden-salida').value = evento.necesitaOrdenSalida ? 'true' : 'false';
            document.getElementById('edit-evento-requiere-ma').value = evento.requiereMA ? 'true' : 'false';
            document.getElementById('edit-evento-link-ma').value = evento.linkMA || '';
            app.openModal(app.modals.editEvento);
        };
        app.showEquipoListView = () => { document.getElementById('equipo-list-view').style.display = 'block'; document.getElementById('equipo-profile-view').style.display = 'none'; document.getElementById('equipo-finanzas-view').style.display = 'none'; app.renderEquipoTable(); };
        app.showMemberProfile = (miembroId) => {
            document.getElementById('equipo-list-view').style.display = 'none';
            document.getElementById('equipo-finanzas-view').style.display = 'none';
            const profileView = document.getElementById('equipo-profile-view');
            profileView.style.display = 'block';
            const miembro = state.equipo.find(m => m.id == miembroId); // Use == for safety
            if (!miembro) {
                profileView.innerHTML = emptyStateMsg('Miembro no encontrado.');
                return;
            }
            const allTasks = app.getAllTasksFlat().filter(t => t.responsables.includes(miembroId));
            const tasksCompleted = allTasks.filter(t => t.completado).length;
            const tasksPending = allTasks.filter(t => !t.completado && t.estado !== 'Atrasado');
            const tasksOverdue = allTasks.filter(t => !t.completado && t.estado === 'Atrasado');
            const totalHonorarios = (miembro.honorarios || []).reduce((sum, p) => sum + Number(p.valor), 0);
            const totalDesplazamientos = (miembro.desplazamientos || []).reduce((sum, p) => sum + Number(p.valor), 0);
            profileView.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3>Perfil de Miembro</h3>
                        <button class="btn btn-secondary" onclick="app.showEquipoListView()"><i class="fas fa-arrow-left"></i> Volver a la lista</button>
                    </div>
                    <div class="card-body">
                        <div class="profile-header">
                            <div class="profile-avatar">${miembro.nombre.charAt(0)}</div>
                            <div class="profile-info">
                                <h2>${miembro.nombre}</h2>
                                <p><i class="fas fa-user-tie fa-fw"></i> ${miembro.rol || 'Sin rol asignado'}</p>
                                <p><i class="fas fa-envelope fa-fw"></i> ${miembro.contacto || 'Sin contacto'}</p>
                            </div>
                            <button class="btn btn-warning" onclick="app.handleEditMiembro('${miembroId}')" data-permission="coordinator"><i class="fas fa-edit"></i> Editar Perfil</button>
                        </div>
                        <div class="card">
                            <div class="card-header"><h4><i class="fas fa-chart-bar"></i> Resumen de Carga de Trabajo</h4></div>
                            <div class="card-body">
                                <div class="profile-stats">
                                    <div class="report-card" style="background-color: var(--info-color); color: white;"><h4>Tareas Totales</h4><div class="amount">${allTasks.length}</div></div>
                                    <div class="report-card" style="background-color: var(--success-color); color: white;"><h4>Completadas</h4><div class="amount">${tasksCompleted}</div></div>
                                    <div class="report-card" style="background-color: var(--warning-color); color: black;"><h4>Pendientes</h4><div class="amount">${tasksPending.length}</div></div>
                                    <div class="report-card" style="background-color: var(--danger-color); color: white;"><h4>Atrasadas</h4><div class="amount">${tasksOverdue.length}</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h4><i class="fas fa-tasks"></i> Tareas Asignadas</h4></div>
                            <div class="card-body"><div class="table-responsive">${allTasks.length > 0 ? `<table><thead><tr><th>Tarea</th><th>Evento</th><th>Estado</th><th>Vencimiento</th></tr></thead><tbody>${allTasks.map(t => `<tr><td>${t.texto}</td><td>${t.eventoNombre}</td><td><span class="status-badge status-${t.estado.replace(/\s+/g, '-')}">${t.estado}</span></td><td>${app.formatDate(t.fechaFin)}</td></tr>`).join('')}</tbody></table>` : emptyStateMsg('Este miembro no tiene tareas asignadas.')}</div></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h4><i class="fas fa-wallet"></i> Resumen Financiero</h4></div>
                            <div class="card-body">
                                <div class="profile-stats">
                                    <div class="report-card"><h4>Total Honorarios</h4><div class="amount">${app.formatCurrency(totalHonorarios)}</div></div>
                                    <div class="report-card"><h4>Total Desplazamientos</h4><div class="amount">${app.formatCurrency(totalDesplazamientos)}</div></div>
                                </div>
                                <div style="text-align: right; margin-top: 1rem;"><button class="btn btn-primary" onclick="app.showMemberFinanceView('${miembroId}')"><i class="fas fa-search-dollar"></i> Gestionar Pagos en Detalle</button></div>
                            </div>
                        </div>
                    </div>
                </div>`;
            app.applyPermissions();
        };
        app.showMemberFinanceView = (miembroId) => {
            document.getElementById('equipo-list-view').style.display = 'none';
            document.getElementById('equipo-profile-view').style.display = 'none';
            document.getElementById('equipo-finanzas-view').style.display = 'block';
            app.renderMemberFinanceView(miembroId);
        };
        app.openHitoModal = (hitoId = null) => { const form = document.getElementById('form-hito'); form.reset(); if (hitoId) { const hito = state.hitos.find(h => h.id === hitoId); if (hito) { document.getElementById('modal-hito-title').textContent = 'Editar Hito'; document.getElementById('hito-id').value = hito.id; document.getElementById('hito-nombre').value = hito.nombre; document.getElementById('hito-fecha').value = hito.fecha; } } else { document.getElementById('modal-hito-title').textContent = 'Añadir Hito'; } app.openModal(app.modals.hito); };
        app.deleteHito = (hitoId) => { if(confirm('¿Seguro que desea eliminar este hito?')) { state.hitos = state.hitos.filter(h => h.id !== hitoId); app.saveState(); app.renderCalendar(); app.closeModal(app.modals.dayTasks); } };
        app.openAusenciaModal = (ausenciaId = null) => { const form = document.getElementById('form-ausencia'); form.reset(); const select = document.getElementById('ausencia-miembro'); select.innerHTML = state.equipo.map(m => `<option value="${m.id}">${m.nombre}</option>`).join(''); if (ausenciaId) { const ausencia = state.ausencias.find(a => a.id === ausenciaId); if(ausencia) { document.getElementById('modal-ausencia-title').textContent = 'Editar Ausencia'; document.getElementById('ausencia-id').value = ausencia.id; select.value = ausencia.miembroId; document.getElementById('ausencia-motivo').value = ausencia.motivo; document.getElementById('ausencia-fecha-inicio').value = ausencia.fechaInicio; document.getElementById('ausencia-fecha-fin').value = ausencia.fechaFin; } } else { document.getElementById('modal-ausencia-title').textContent = 'Registrar Ausencia'; } app.openModal(app.modals.ausencia); };
        app.deleteAusencia = (ausenciaId) => { if(confirm('¿Seguro que desea eliminar este registro de ausencia?')) { state.ausencias = state.ausencias.filter(a => a.id !== ausenciaId); app.saveState(); app.renderCalendar(); app.closeModal(app.modals.dayTasks); } };

        // --- EVENT LISTENER BINDING ---
        Object.values(app.modals).forEach(modal => { if (modal) { modal.querySelector('.close-btn').addEventListener('click', () => app.closeModal(modal)); modal.addEventListener('click', (e) => { if (e.target === modal) app.closeModal(modal); }); }});
        document.addEventListener('click', (e) => { if (!e.target.closest('.actions-menu-wrapper')) { document.querySelectorAll('.actions-menu-wrapper.show').forEach(menu => menu.classList.remove('show')); } });
        document.getElementById('dark-mode-toggle').addEventListener('click', () => app.toggleDarkMode());
        document.getElementById('sidebar-toggle').addEventListener('click', () => app.toggleSidebar());
        document.getElementById('mobile-menu-toggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('open'));
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', app.handleTabClick));
        document.getElementById('user-selector').addEventListener('change', (e) => app.setCurrentUser(e.target.value));
        document.getElementById('btn-add-evento').addEventListener('click', () => { document.getElementById('form-evento').reset(); app.populateTemplateDropdown(); app.renderProjectTabs(); app.openModal(app.modals.evento); });
        document.getElementById('form-evento').addEventListener('submit', e => { e.preventDefault(); const fechaInicio = document.getElementById('evento-fecha-inicio').value; const fechaFin = document.getElementById('evento-fecha-fin').value; const projectType = document.getElementById('evento-proyecto-tipo').value.trim(); if (!fechaInicio || !fechaFin) { alert('Las fechas de inicio y fin son obligatorias.'); return; } if (new Date(fechaFin) < new Date(fechaInicio.split('T')[0])) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; } if (!projectType) { alert('Por favor, ingrese un tipo de proyecto para el evento.'); return; } const templateId = document.getElementById('evento-template').value; const template = state.eventTemplates.find(t => t.id === templateId); const fases = template ? JSON.parse(JSON.stringify(template.fases)) : createChecklistTemplate(); const newEvent = { id: 'evt-' + Date.now(), nombre: document.getElementById('evento-nombre').value, fechaInicio: fechaInicio, fechaFin: fechaFin, projectType: projectType, descripcion: '', order: state.eventos.length, fases: fases, activityLog: [], municipio: document.getElementById('evento-municipio').value, modalidad: document.getElementById('evento-modalidad').value, liderId: '', responsablesEvento: [], necesitaOrdenSalida: false, requiereMA: false, linkMA: '', presupuesto: 0 }; app.logActivity(newEvent.id, `creó el evento.`); state.eventos.push(newEvent); if (!state.eventProjectTypes.includes(projectType)) { state.eventProjectTypes.push(projectType); } app.saveState(); currentEventProjectTypeFilter = 'all'; app.render(); app.closeModal(app.modals.evento); });
        document.getElementById('form-edit-evento').addEventListener('submit', e => { e.preventDefault(); const eventoId = document.getElementById('edit-evento-id').value; const evento = state.eventos.find(evt => evt.id === eventoId); if (!evento) { alert('Error: Evento no encontrado.'); return; } evento.nombre = document.getElementById('edit-evento-nombre').value; evento.fechaInicio = document.getElementById('edit-evento-fecha-inicio').value; evento.fechaFin = document.getElementById('edit-evento-fecha-fin').value; evento.projectType = document.getElementById('edit-evento-proyecto-tipo').value.trim(); evento.municipio = document.getElementById('edit-evento-municipio').value; evento.modalidad = document.getElementById('edit-evento-modalidad').value; evento.liderId = document.getElementById('edit-evento-lider').value; evento.presupuesto = parseFloat(document.getElementById('edit-evento-presupuesto').value) || 0; evento.necesitaOrdenSalida = document.getElementById('edit-evento-orden-salida').value === 'true'; evento.requiereMA = document.getElementById('edit-evento-requiere-ma').value === 'true'; evento.linkMA = document.getElementById('edit-evento-link-ma').value; if (new Date(evento.fechaFin) < new Date(evento.fechaInicio.split('T')[0])) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; } if (!evento.projectType) { alert('Por favor, ingrese un tipo de proyecto para el evento.'); return; } if (!state.eventProjectTypes.includes(evento.projectType)) { state.eventProjectTypes.push(evento.projectType); } app.logActivity(eventoId, 'actualizó los detalles del evento.'); app.saveState(); app.render(); app.closeModal(app.modals.editEvento); });
        document.getElementById('btn-add-miembro').addEventListener('click', () => { document.getElementById('form-miembro').reset(); document.getElementById('miembro-id').value = ''; document.getElementById('modal-miembro-title').innerText = 'Añadir Miembro'; app.openModal(app.modals.miembro); });
        document.getElementById('form-miembro').addEventListener('submit', e => { e.preventDefault(); const id = document.getElementById('miembro-id').value; const nombre = document.getElementById('miembro-nombre').value; const rol = document.getElementById('miembro-rol').value; const contacto = document.getElementById('miembro-contacto').value; if(id) { const miembro = state.equipo.find(m => m.id == id); miembro.nombre = nombre; miembro.rol = rol; miembro.contacto = contacto; } else { state.equipo.push({ id: 'user-' + Date.now(), nombre, rol, contacto, honorarios: [], desplazamientos: [] }); } app.saveState(); app.render(); app.setupUserSelector(); if (document.getElementById('equipo-profile-view').style.display === 'block') { app.showMemberProfile(id); } app.closeModal(app.modals.miembro); });
        document.getElementById('btn-bulk-add-miembro').addEventListener('click', () => { document.getElementById('bulk-miembro-names').value = ''; app.openModal(app.modals.bulkMiembro); });
        document.getElementById('btn-save-bulk-miembros').addEventListener('click', app.handleBulkAddMiembros);
        document.getElementById('equipo-search-input').addEventListener('input', (e) => app.renderEquipoTable(e.target.value));
        document.getElementById('prev-month-btn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); app.renderCalendar();});
        document.getElementById('next-month-btn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); app.renderCalendar();});
        document.getElementById('form-edit-pago').addEventListener('submit', e => { e.preventDefault(); const miembroId = document.getElementById('edit-pago-miembro-id').value; const pagoId = document.getElementById('edit-pago-id').value; const tipo = document.getElementById('edit-pago-tipo').value; const miembro = state.equipo.find(m => m.id == miembroId); const pago = (miembro[tipo] || []).find(p => p.id == pagoId); if (!pago) return; pago.concepto = document.getElementById('edit-pago-concepto').value; pago.valor = parseFloat(document.getElementById('edit-pago-valor').value); pago.fechaInicio = document.getElementById('edit-pago-fechaInicio').value; pago.fechaFin = document.getElementById('edit-pago-fechaFin').value; pago.eventoId = document.getElementById('edit-pago-evento-asociado').value || null; if (new Date(pago.fechaFin) < new Date(pago.fechaInicio)) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; } app.saveState(); app.renderMemberFinanceView(miembroId); app.closeModal(app.modals.editPago); });
        document.getElementById('form-edit-gasto-general').addEventListener('submit', (e) => { e.preventDefault(); app.handleUpdateGastoGeneral(); });
        document.getElementById('form-transfer-task').addEventListener('submit', e => { e.preventDefault(); app.handleTransferTask(); });
        document.getElementById('btn-download-tareas-persona').addEventListener('click', () => { const data = []; state.eventos.slice().sort((a,b)=>(a.order||0)-(b.order||0)).forEach(e => { app.getAllTasksForEvent(e).forEach(t => { data.push({ "Responsables": app.getMiembrosNombres(t.responsables), "Evento": e.nombre, "Tipo de Proyecto": e.projectType || 'N/A', "Fase": t.faseNombre, "Nivel": t.nivel, "Tarea Padre": t.parentTaskId ? (app.getTaskById(t.parentTaskId)?.texto || 'N/A') : '', "Tarea": t.texto, "Fecha Inicio": t.fechaInicio, "Fecha Fin": t.fechaFin, "Estado": t.estado }); }); }); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Tareas por Persona"); XLSX.writeFile(wb, "Reporte_Tareas_por_Persona.xlsx"); });
        document.getElementById('btn-download-avance-evento').addEventListener('click', () => { const data = state.eventos.slice().sort((a,b)=>(a.order||0)-(b.order||0)).map(e => { const { total, completadas } = app.getEventProgress(e); return { "Evento": e.nombre, "Fecha Inicio": e.fechaInicio, "Fecha Fin": e.fechaFin, "Tipo de Proyecto": e.projectType || 'N/A', "Total Tareas": total, "Completadas": completadas, "Avance (%)": total > 0 ? ((completadas / total) * 100).toFixed(2) : 0 }; }); const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Avance por Evento"); XLSX.writeFile(wb, "Reporte_Avance_por_Evento.xlsx"); });
        document.getElementById('btn-download-estado-general').addEventListener('click', () => { const wb = XLSX.utils.book_new(); state.eventos.slice().sort((a,b)=>(a.order||0)-(b.order||0)).forEach(e => { const eventTasksData = []; app.getAllTasksForEvent(e).forEach(t => { eventTasksData.push({ "Fase": t.faseNombre, "Nivel": t.nivel, "Tarea Padre": t.parentTaskId ? (app.getTaskById(t.parentTaskId)?.texto || 'N/A') : '', "Tarea": t.texto, "Fecha Inicio": t.fechaInicio, "Fecha Fin": t.fechaFin, "Estado": t.estado, "Responsables": app.getMiembrosNombres(t.responsables) }); }); const ws = XLSX.utils.json_to_sheet(eventTasksData); const sheetName = e.nombre.substring(0, 30).replace(/[\\/?*\[\]:]/g, ''); XLSX.utils.book_append_sheet(wb, ws, sheetName); }); XLSX.writeFile(wb, "Reporte_General_Eventos.xlsx"); });
        document.getElementById('btn-download-finanzas-general').addEventListener('click', () => { const wb = XLSX.utils.book_new(); const allPayments = []; let summaryData = []; let grandTotalBudget = 0, grandTotalSpent = 0; state.equipo.forEach(miembro => { (miembro.honorarios || []).forEach(p => allPayments.push({ 'Miembro del Equipo': miembro.nombre, 'Tipo de Pago': 'Honorario', 'Concepto': p.concepto, 'Valor': p.valor, 'Fecha Inicio': p.fechaInicio, 'Fecha Fin': p.fechaFin, 'Evento Asociado': state.eventos.find(e => e.id === p.eventoId)?.nombre || 'N/A' })); (miembro.desplazamientos || []).forEach(p => allPayments.push({ 'Miembro del Equipo': miembro.nombre, 'Tipo de Pago': 'Desplazamiento', 'Concepto': p.concepto, 'Valor': p.valor, 'Fecha Inicio': p.fechaInicio, 'Fecha Fin': p.fechaFin, 'Evento Asociado': state.eventos.find(e => e.id === p.eventoId)?.nombre || 'N/A' })); }); state.gastosGenerales.forEach(g => { allPayments.push({ 'Miembro del Equipo': 'GASTO GENERAL', 'Tipo de Pago': 'General', 'Concepto': g.concepto, 'Valor': g.valor, 'Fecha Inicio': g.fecha, 'Fecha Fin': g.fecha, 'Evento Asociado': state.eventos.find(e => e.id === g.eventoId)?.nombre || 'N/A' }); }); const ws_pagos = XLSX.utils.json_to_sheet(allPayments); XLSX.utils.book_append_sheet(wb, ws_pagos, "Desglose de Pagos"); state.eventos.forEach(evento => { const gastosPersonal = state.equipo.flatMap(m => [...(m.honorarios || []), ...(m.desplazamientos || [])]).filter(p => p.eventoId === evento.id); const gastosGenerales = (state.gastosGenerales || []).filter(g => g.eventoId === evento.id); const gastoTotal = [...gastosPersonal, ...gastosGenerales].reduce((sum, gasto) => sum + (Number(gasto.valor) || 0), 0); const presupuesto = Number(evento.presupuesto) || 0; grandTotalBudget += presupuesto; grandTotalSpent += gastoTotal; summaryData.push({ 'Evento': evento.nombre, 'Presupuesto': presupuesto, 'Gasto Total': gastoTotal, 'Saldo': presupuesto - gastoTotal }); }); summaryData.push({}); summaryData.push({ 'Evento': 'GRAN TOTAL', 'Presupuesto': grandTotalBudget, 'Gasto Total': grandTotalSpent, 'Saldo': grandTotalBudget - grandTotalSpent }); const ws_summary = XLSX.utils.json_to_sheet(summaryData); XLSX.utils.book_append_sheet(wb, ws_summary, "Resumen Financiero"); XLSX.writeFile(wb, `Reporte_Financiero_General.xlsx`); });
        document.getElementById('btn-download-finanzas-individual').addEventListener('click', () => { const miembroId = document.getElementById('select-finanzas-persona').value; if (miembroId) { app.handleDownloadIndividualReport(miembroId); } else { alert('Por favor, seleccione una persona de la lista.'); } });
        document.getElementById('btn-export-data').addEventListener('click', () => { const dataStr = JSON.stringify(state, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `proyecto_backup_${new Date().toISOString().slice(0,10)}.json`; link.click(); URL.revokeObjectURL(url); });
        document.getElementById('import-file-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file && confirm("¿Importar archivo? Se sobreescribirán todos los datos actuales.")) { const reader = new FileReader(); reader.onload = (e) => { try { let importedState = JSON.parse(e.target.result); if (!importedState || !importedState.eventos || !importedState.equipo) { throw new Error("El archivo de backup no tiene el formato esperado (faltan 'eventos' o 'equipo')."); } importedState = app.migrateState(importedState); Object.keys(state).forEach(key => delete state[key]); Object.assign(state, importedState); app.saveState(); location.reload(); alert("¡Datos importados con éxito! La página se recargará."); } catch (err) { alert("Error al importar el archivo: " + err.message); } }; reader.readAsText(file); } event.target.value = ''; });
        document.getElementById('btn-add-otro-item').addEventListener('click', app.addOtroItem);
        document.getElementById('btn-view-all-tasks').addEventListener('click', () => { app.openModal(app.modals.allTasks); app.renderAllTasksModal(); });
        document.getElementById('all-tasks-event-filter').addEventListener('change', (e) => app.renderAllTasksModal(e.target.value, document.getElementById('all-tasks-status-filter').value));
        document.getElementById('all-tasks-status-filter').addEventListener('change', (e) => app.renderAllTasksModal(document.getElementById('all-tasks-event-filter').value, e.target.value));
        document.getElementById('btn-download-cronograma-eventos').addEventListener('click', () => app.handleDownloadCronogramaReport());
        document.getElementById('global-search-input').addEventListener('keyup', (e) => { if (e.target.value.length >= 3) { app.performGlobalSearch(e.target.value); app.openModal(app.modals.globalSearch); } else if(e.target.value.length === 0) { app.closeModal(app.modals.globalSearch); } });
        document.getElementById('global-search-input').addEventListener('search', (e) => { if(!e.target.value) app.closeModal(app.modals.globalSearch); });
        document.getElementById('form-save-template').addEventListener('submit', (e) => { e.preventDefault(); app.handleSaveTemplate(); });
        document.getElementById('checklist-view-list-btn').addEventListener('click', () => app.switchChecklistView('list'));
        document.getElementById('checklist-view-board-btn').addEventListener('click', () => app.switchChecklistView('board'));
        document.getElementById('cronograma-view-calendar-btn').addEventListener('click', () => app.switchCronogramaView('calendar'));
        document.getElementById('cronograma-view-gantt-btn').addEventListener('click', () => app.switchCronogramaView('gantt'));
        document.getElementById('form-hito').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('hito-id').value; const nombre = document.getElementById('hito-nombre').value; const fecha = document.getElementById('hito-fecha').value; if(id) { const hito = state.hitos.find(h => h.id === id); hito.nombre = nombre; hito.fecha = fecha; } else { state.hitos.push({id: 'hito-' + Date.now(), nombre, fecha}); } app.saveState(); app.renderCalendar(); app.closeModal(app.modals.hito); });
        document.getElementById('form-ausencia').addEventListener('submit', (e) => { e.preventDefault(); const id = document.getElementById('ausencia-id').value; const miembroId = document.getElementById('ausencia-miembro').value; const motivo = document.getElementById('ausencia-motivo').value; const fechaInicio = document.getElementById('ausencia-fecha-inicio').value; const fechaFin = document.getElementById('ausencia-fecha-fin').value; if (new Date(fechaFin) < new Date(fechaInicio)) { alert('La fecha de fin no puede ser anterior a la de inicio.'); return; } if(id) { const ausencia = state.ausencias.find(a => a.id === id); Object.assign(ausencia, {miembroId, motivo, fechaInicio, fechaFin}); } else { state.ausencias.push({id: 'ausencia-' + Date.now(), miembroId, motivo, fechaInicio, fechaFin}); } app.saveState(); app.renderCalendar(); app.closeModal(app.modals.ausencia); });
        

        // --- INITIALIZATION ---
        quillEditor = new Quill('#evento-descripcion-editor', { modules: { toolbar: [ [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'image', 'code-block'], ['clean'] ] }, placeholder: 'Escribe la descripción detallada...', theme: 'snow' });
        document.getElementById('btn-enter-edit-mode').addEventListener('click', () => { const viewContainer = document.querySelector('#descripcion-view-container .ql-editor'); const currentContent = viewContainer.innerHTML; if (viewContainer.querySelector('i')) { quillEditor.root.innerHTML = ''; } else { quillEditor.root.innerHTML = currentContent; } document.getElementById('descripcion-view-container').style.display = 'none'; document.getElementById('descripcion-editor-container').style.display = 'block'; document.getElementById('btn-enter-edit-mode').style.display = 'none'; document.getElementById('descripcion-actions-container').style.display = 'flex'; });
        document.getElementById('btn-cancel-descripcion').addEventListener('click', () => { document.getElementById('descripcion-view-container').style.display = 'block'; document.getElementById('descripcion-editor-container').style.display = 'none'; document.getElementById('btn-enter-edit-mode').style.display = 'inline-block'; document.getElementById('descripcion-actions-container').style.display = 'none'; });
        document.getElementById('btn-save-descripcion').addEventListener('click', app.handleSaveDescripcion);
        
        quillObservacionEditor = new Quill('#task-observacion-editor', { modules: { toolbar: [ ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean'] ] }, placeholder: 'Escribe las observaciones...', theme: 'snow' });
        document.getElementById('btn-enter-observacion-edit-mode').addEventListener('click', () => { const viewContainer = document.querySelector('#observacion-view-container .ql-editor'); const currentContent = viewContainer.innerHTML; if (viewContainer.querySelector('i')) { quillObservacionEditor.root.innerHTML = ''; } else { quillObservacionEditor.root.innerHTML = currentContent; } document.getElementById('observacion-view-container').style.display = 'none'; document.getElementById('observacion-editor-container').style.display = 'block'; document.getElementById('btn-enter-observacion-edit-mode').style.display = 'none'; document.getElementById('observacion-actions-container').style.display = 'flex'; });
        document.getElementById('btn-cancel-observacion').addEventListener('click', () => { document.getElementById('observacion-view-container').style.display = 'block'; document.getElementById('observacion-editor-container').style.display = 'none'; document.getElementById('btn-enter-observacion-edit-mode').style.display = 'inline-block'; document.getElementById('observacion-actions-container').style.display = 'none'; });
        document.getElementById('btn-save-observacion').addEventListener('click', app.handleSaveObservacion);

        app.loadState();
        app.setupUserSelector();
        app.render();
        document.querySelector('.nav-link[data-tab="mis-tareas"]').click(); // Start on My Tasks tab

        window.app = app;
        window.resetApp = () => { if (confirm('¿Estás seguro? Se borrarán todos los datos y la aplicación se recargará.')) { localStorage.removeItem('projectManagementState_v22'); location.reload(); } };
        window.verEstado = () => { console.log('Estado actual:', state); };
    });

    const inputs = document.querySelectorAll("input");
    inputs.forEach(function (input) { input.setAttribute("autocomplete", "off"); });
</script>

</body>
</html>
