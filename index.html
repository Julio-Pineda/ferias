<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Proyectos</title>
    
    <!-- LIBRERÍAS EXTERNAS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- NUEVO: LIBRERÍA PARA EDITOR DE TEXTO ENRIQUECIDO (Quill.js - Alternativa gratuita) -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.min.js"></script>

    <style>
        :root {
            --primary-color: #003366; --secondary-color: #D4AF37; --background-color: #f0f2f5;
            --card-background: #ffffff; --text-color: #333; --light-text-color: #6c757d;
            --border-color: #e0e0e0; --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --danger-color: #dc3545; --warning-color: #ffc107; --success-color: #28a745; --full-color: #0080ff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--background-color); color: var(--text-color); }
        .container { max-width: 1800px; margin: 0 auto; padding: 2rem; }
        header { text-align: center; margin-bottom: 2rem; }
        header h1 { font-size: 2.5rem; color: var(--primary-color); }
        header p { font-size: 1.1rem; color: var(--light-text-color); margin-bottom: 0; }

        .tabs-nav { display: flex; justify-content: center; border-bottom: 2px solid var(--border-color); margin-bottom: 2rem; flex-wrap: wrap; }
        .tab-link { padding: 1rem 1.5rem; cursor: pointer; border: none; background: none; font-size: 1.1rem; font-weight: 600; color: var(--light-text-color); border-bottom: 4px solid transparent; transition: all 0.3s ease; display: flex; align-items: center; gap: 0.5rem; }
        .tab-link:hover { color: var(--primary-color); }
        .tab-link.active { color: var(--primary-color); border-bottom-color: var(--secondary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Styles for Project Type Tabs */
        .project-type-tabs-nav { 
            display: flex;
            justify-content: center;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 0;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        .project-type-tab-link { 
            padding: 0.75rem 1.2rem;
            cursor: pointer;
            border: 1px solid var(--border-color);
            border-bottom: none;
            background-color: var(--card-background);
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--light-text-color);
            transition: all 0.2s ease;
        }
        .project-type-tab-link:hover {
            background-color: #e9ecef;
            color: var(--primary-color);
        }
        .project-type-tab-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }


        .card { background: var(--card-background); border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 2rem; overflow: hidden; }
        .card-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background-color: #fafafa; }
        .card-header h3 { font-size: 1.5rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.75rem; }
        .card-body { padding: 1.5rem; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; }
        .report-card { padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between; }
        .empty-state { text-align: center; padding: 3rem; color: var(--light-text-color); font-style: italic; }

        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background-color: #f8f9fa; font-weight: 600; }
        td.actions { display: flex; gap: 0.5rem; align-items: center; }

        .event-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 1.5rem;}
        .event-card-item { background: var(--card-background); border-radius: 22px; box-shadow: var(--shadow); display: flex; flex-direction: column;  border: 1px lightgray solid;}
        .event-card-item-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .event-card-item-header h4 { color: var(--primary-color); cursor: pointer; transition: background-color 0.2s; padding: 5px; border-radius: 4px; width: calc(100% - 40px); }
        .event-card-item-header h4:hover { background-color: #f0f2f5; }
        .inline-edit-input { width: 100%; font-size: 1.1rem; font-weight: bold; color: var(--primary-color); border: 2px solid var(--secondary-color); border-radius: 4px; padding: 4px; font-family: inherit; }
        .event-card-item-body { padding: 1rem; display: flex; flex-direction: column; gap: 1rem; flex-grow: 1; }
        .event-card-progress { display: flex; align-items: center; gap: 1rem; }
        .progress-chart-container { width: 80px; height: 80px; position: relative; flex-shrink: 0;}
        .progress-chart-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; font-weight: 700; }
        .event-card-info { font-size: 0.9rem; color: var(--light-text-color); }
        .responsables-list { list-style: none; font-size: 0.9rem; margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 5px;}
        .responsables-list span { background-color: var(--border-color); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
        .event-card-item-footer { padding: 1rem; border-top: 1px solid var(--border-color); text-align: right; display: flex; justify-content: flex-end; gap: 0.5rem; flex-wrap: wrap; }
        .btn-manage { background-color: var(--success-color); color: white; }
        .btn-edit-details { background-color: var(--primary-color); color: white; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 2rem; border-radius: 22px; max-width: 90%; width: 900px; position: relative; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-btn { color: #aaa; position: absolute; top: 1rem; right: 1.5rem; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .modal-content h3 { margin-bottom: 1.5rem; color: var(--primary-color); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; }

        #checklist-container { max-height: 60vh; overflow-y: auto; padding-right: 1rem; }
        .checklist-phase h4 { margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--primary-color); }
        .checklist-task { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0; border-bottom: 1px dashed var(--border-color); flex-wrap: wrap;}
        .checklist-task input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--success-color); flex-shrink: 0; }
        .task-description { flex-grow: 1; display: flex; align-items: center; gap: 0.5rem;}
        .task-description input[type="text"] { width: 100%; border: none; border-bottom: 1px solid var(--border-color); padding: 0.5rem; }
        .task-assignment { display: flex; align-items: center; gap: 0.5rem; flex-shrink: 0; flex-wrap: wrap; width: 450px;}
        .task-assignment input[type="datetime-local"] { padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); width: 180px;}
        .task-assignment label { font-size: 0.8rem; margin-left: 5px; }
        .responsables-display { flex-grow: 1; font-size: 0.85rem; color: var(--light-text-color); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .checklist-task.completed .task-description input[type="text"] { text-decoration: line-through; color: var(--light-text-color); }
        .add-task-btn-container { text-align: right; margin-top: 1rem; }
        .btn-add-task { background: var(--secondary-color); color: var(--primary-color); }

        /* New styles for subtasks */
        .subtasks-container { margin-left: 30px; border-left: 2px solid var(--border-color); padding-left: 10px; margin-top: 10px; }
        .subtask-item { display: flex; align-items: center; gap: 1rem; padding: 0.5rem 0; border-bottom: 1px dashed #e9e9e9; flex-wrap: wrap; font-size: 0.95rem; }
        .subtask-item:last-child { border-bottom: none; }
        .subtask-item .task-description input[type="text"] { font-size: 0.95rem; }
        .subtask-item .task-assignment { width: 420px; } /* Adjust width for subtasks */
        .subtask-item .task-assignment input[type="datetime-local"] { width: 160px; } /* Adjust width for subtasks */
        .add-subtask-btn-container { text-align: right; margin-top: 0.5rem; }
        .btn-add-subtask { background: #e0f7fa; color: #00796b; padding: 0.3rem 0.8rem; border-radius: 8px; font-size: 0.85rem; }

        #responsables-checkbox-container { max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 1rem; border-radius: 6px; }
        .responsable-option { display: block; margin-bottom: 0.5rem; }
        .responsable-option label { margin-left: 0.5rem; }
        
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .calendar-nav h2 { color: var(--primary-color); }
        #calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; padding: 0 42px 42px 42px;}
        .calendar-header { font-weight: bold; text-align: center; color: var(--primary-color); padding: 42px 42px 0 42px; display:grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .calendar-day { border: 1px solid var(--border-color); min-height: 80px; padding: 0.5rem; background-color: var(--card-background); position: relative; border-radius: 12px; }
        .calendar-day.other-month { background-color: #f8f9fa; color: #ccc; }
        .day-number { font-weight: bold; }
        .day-tasks-badge { position: absolute; bottom: 8px; right: 8px; background-color: var(--secondary-color); color: var(--primary-color); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; }
        .calendar-day.has-tasks { cursor: pointer; background-color: #fffac3; }
        .calendar-day.event-start-day { 
            background-color: #ffe0e6; /* Light red/pink background */
            border: 2px solid var(--danger-color); /* Red border */
        }
        .calendar-day.event-start-day::after {
            content: "\f144"; /* Unicode for fa-play-circle */
            font-family: "Font Awesome 6 Free"; /* Font Awesome family */
            font-weight: 900; /* For solid icon */
            color: var(--danger-color);
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 1.2rem;
        }
        #day-tasks-list li { margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--border-color); list-style: none;}
        p { margin-bottom: 1.2rem; }

        #modal-finanzas .modal-content { width: 1000px; }
        .finanzas-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .finanzas-section h4 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .pagos-list { max-height: 250px; overflow-y: auto; margin-bottom: 1rem; padding-right: 10px; }
        .pago-item { display: grid; grid-template-columns: 2fr 1.5fr 1fr auto; gap: 1rem; align-items: center; padding: 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
        .pago-actions { display: flex; gap: 0.5rem; }
        .add-pago-form { display: flex; flex-direction: column; gap: 1rem; }
        .add-pago-form .form-group { margin-bottom: 0; }
        .add-pago-form input { padding: 0.5rem; }
        .report-card select { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 6px; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>PROYECTO</h1>
        <p>FORTALECIMIENTO ECONÓMICO DE UNIDADES PRODUCTIVAS Y EMPRESAS MEDIANTE LA COMERCIALIZACIÓN EN MERCADOS INTERNOS Y EXTERNOS DEL DEPARTAMENTO DEL CAUCA</p>
    </header>

    <div class="tabs-nav">
        <button class="tab-link active" data-tab="analitica"><i class="fas fa-chart-pie"></i> Analítica</button>
        <button class="tab-link" data-tab="gestion"><i class="fas fa-tasks"></i> Gestión de Eventos</button>
        <button class="tab-link" data-tab="cronograma"><i class="fas fa-calendar-alt"></i> Cronograma</button>
        <button class="tab-link" data-tab="equipo"><i class="fas fa-users"></i> Gestión de Equipo</button>
        <button class="tab-link" data-tab="finanzas"><i class="fas fa-money-bill-wave"></i> Finanzas</button>
        <button class="tab-link" data-tab="reportes"><i class="fas fa-download"></i> Reportes</button>
    </div>

    <!-- MÓDULO 1: ANALÍTICA -->
    <div id="analitica" class="tab-content active">
        <div class="grid-container" style="grid-template-columns: 1fr 2fr;">
            <div class="card"><div class="card-header"><h3><i class="fas fa-tachometer-alt"></i> Avance general</h3></div><div class="card-body" style="height: 350px;"><canvas id="generalChart"></canvas></div></div>
            <div class="card"><div class="card-header"><h3><i class="fas fa-calendar-check"></i> Avance por evento</h3></div><div class="card-body" style="height: 350px;"><canvas id="eventosChart"></canvas></div></div>
        </div>
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-user-check"></i> Desempeño por persona</h3></div>
            <div class="card-body" style="height: 400px;"><canvas id="personasChart"></canvas></div>
        </div>
    </div>

    <!-- MÓDULO 2: GESTIÓN DE EVENTOS -->
    <div id="gestion" class="tab-content">
        <!-- Project Type Tabs for Event Classification -->
        <div class="project-type-tabs-nav" id="event-project-type-nav">
            <!-- Project Type buttons will be rendered here dynamically by JS -->
        </div>

        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-clipboard-list" style="color:var(--success-color);"></i> Eventos del proyecto</h3>
                <button class="btn btn-primary" id="btn-add-evento"><i class="fas fa-plus"></i> Crear nuevo</button>
            </div>
            <div class="card-body"><div id="event-grid-container" class="event-grid"></div></div>
        </div>
    </div>
    
    <!-- MÓDULO 3: CRONOGRAMA -->
    <div id="cronograma" class="tab-content">
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-calendar-alt" style="color:var(--primary-color);"></i> Cronograma mensual de tareas</h3></div>
            <div class="card-body">
                <div class="calendar-nav">
                    <button class="btn btn-primary" id="prev-month-btn"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="calendar-month-year"></h2>
                    <button class="btn btn-primary" id="next-month-btn"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div id="calendar-grid-header" class="calendar-header">
                    <div>Dom</div><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div>
                </div>
                <div id="calendar-grid"></div>
            </div>
        </div>
    </div>

    <!-- MÓDULO 4: GESTIÓN DE EQUIPO -->
    <div id="equipo" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-users-cog" style="color:#6f42c1;"></i> Miembros del equipo</h3>
                <div>
                    <button class="btn btn-primary" id="btn-add-miembro"><i class="fas fa-user-plus"></i> Añadir miembro</button>
                    <button class="btn btn-primary" id="btn-bulk-add-miembro"><i class="fas fa-users"></i> Carga masiva</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive" id="equipo-table-container">
                    <table id="tabla-equipo">
                        <thead><tr><th>Nombre</th><th>Tareas asignadas</th><th>Acciones</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MÓDULO 5: FINANZAS -->
    <div id="finanzas" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-wallet" style="color:var(--success-color);"></i> Gestión de Pagos</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive" id="finanzas-table-container">
                    <table id="tabla-finanzas">
                        <thead>
                            <tr>
                                <th>Miembro del Equipo</th>
                                <th>Total Honorarios</th>
                                <th>Total Desplazamientos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>


    <!-- MÓDULO 6: REPORTES -->
    <div id="reportes" class="tab-content">
        <div class="card">
             <div class="card-header"><h3><i class="fas fa-file-excel" style="color:var(--success-color);"></i> Reportes en Excel</h3></div>
             <div class="card-body grid-container" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                 <div class="report-card"><h4><i class="fas fa-tasks"></i> Tareas por Persona</h4><p>Genera un archivo con el detalle de tareas asignadas a cada miembro del equipo.</p><button class="btn btn-primary" id="btn-download-tareas-persona"><i class="fas fa-file-excel"></i> Descargar</button></div>
                 <div class="report-card"><h4><i class="fas fa-chart-line"></i> Avance por Evento</h4><p>Genera un archivo con el resumen de avance (total de tareas, completadas, %) de cada evento.</p><button class="btn btn-primary" id="btn-download-avance-evento"><i class="fas fa-file-excel"></i> Descargar</button></div>
                 <div class="report-card"><h4><i class="fas fa-clipboard-list"></i> Estado General de Eventos</h4><p>Genera un archivo con una hoja por cada evento, detallando todas sus tareas, fases y responsables.</p><button class="btn btn-primary" id="btn-download-estado-general"><i class="fas fa-file-excel"></i> Descargar</button></div>
                 <div class="report-card"><h4><i class="fas fa-wallet"></i> Finanzas (General)</h4><p>Genera un archivo con todos los pagos (honorarios y desplazamientos) de todo el equipo.</p><button class="btn btn-primary" id="btn-download-finanzas-general"><i class="fas fa-file-excel"></i> Descargar</button></div>
                 <div class="report-card"><h4><i class="fas fa-user-tag"></i> Finanzas (Individual)</h4><p>Seleccione una persona para generar un reporte detallado de sus pagos.</p><div><select id="select-finanzas-persona"></select><button class="btn btn-primary" id="btn-download-finanzas-individual" style="width: 100%; margin-top: 1rem;"><i class="fas fa-file-excel"></i> Descargar</button></div></div>
             </div>
        </div>
        <div class="card">
            <div class="card-header"><h3><i class="fas fa-database" style="color: var(--primary-color);"></i> Gestión de Datos de la App</h3></div>
            <div class="card-body grid-container">
                <div class="report-card">
                    <h4>Exportar Datos (Backup)</h4>
                    <p>Guarda todo el estado de la aplicación (eventos, equipo, tareas, finanzas) en un archivo .json.</p>
                    <button class="btn btn-primary" id="btn-export-data"><i class="fas fa-file-export"></i> Exportar Backup</button>
                </div>
                <div class="report-card">
                    <h4>Importar Datos (Restaurar)</h4>
                    <p>Carga un archivo de backup (.json) para restaurar el estado de la aplicación. ¡Sobrescribirá los datos actuales!</p>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    <button class="btn btn-danger" onclick="document.getElementById('import-file-input').click();"><i class="fas fa-file-import"></i> Importar Backup</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODALES -->
<div id="modal-checklist" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="checklist-title"></h3><div id="checklist-container"></div></div></div>
<div id="modal-miembro" class="modal"><div class="modal-content" style="width: 500px;"><span class="close-btn">&times;</span><h3 id="modal-miembro-title"></h3><form id="form-miembro"><input type="hidden" id="miembro-id"><div class="form-group"><label for="miembro-nombre">Nombre del Miembro</label><input type="text" id="miembro-nombre" required></div><button type="submit" class="btn btn-primary">Guardar</button></form></div></div>
<div id="modal-evento" class="modal"><div class="modal-content" style="width: 500px;"><span class="close-btn">&times;</span><h3>Crear Nuevo Evento</h3><form id="form-evento"><div class="form-group"><label for="evento-nombre">Nombre del Evento</label><input type="text" id="evento-nombre" placeholder="Ej: Feria Subregional Popayán" required></div><div class="form-group"><label for="evento-fecha-inicio">Fecha de Inicio</label><input type="date" id="evento-fecha-inicio" required></div><div class="form-group"><label for="evento-fecha-fin">Fecha de Fin</label><input type="date" id="evento-fecha-fin" required></div><div class="form-group"><label for="evento-proyecto-tipo">Tipo de Proyecto</label><input type="text" id="evento-proyecto-tipo" list="proyecto-tipos-list" placeholder="Ej: Ferias, Talleres, Internos" required><datalist id="proyecto-tipos-list"></datalist></div><button type="submit" class="btn btn-primary">Crear Evento</button></form></div></div>
<div id="modal-edit-evento" class="modal"><div class="modal-content" style="width: 500px;"><span class="close-btn">&times;</span><h3 id="edit-evento-title">Editar Evento</h3><form id="form-edit-evento"><input type="hidden" id="edit-evento-id"><div class="form-group"><label for="edit-evento-nombre">Nombre del Evento</label><input type="text" id="edit-evento-nombre" required></div><div class="form-group"><label for="edit-evento-fecha-inicio">Fecha de Inicio</label><input type="date" id="edit-evento-fecha-inicio" required></div><div class="form-group"><label for="edit-evento-fecha-fin">Fecha de Fin</label><input type="date" id="edit-evento-fecha-fin" required></div><div class="form-group"><label for="edit-evento-proyecto-tipo">Tipo de Proyecto</label><input type="text" id="edit-evento-proyecto-tipo" list="proyecto-tipos-list-edit" required><datalist id="proyecto-tipos-list-edit"></datalist></div><button type="submit" class="btn btn-primary">Guardar Cambios</button></form></div></div>
<div id="modal-responsables" class="modal"><div class="modal-content" style="width: 400px;"><span class="close-btn">&times;</span><h3>Asignar Responsables</h3><div id="responsables-checkbox-container"></div><div style="text-align: right; margin-top: 1rem;"><button id="btn-save-responsables" class="btn btn-primary">Guardar</button></div></div></div>
<div id="modal-day-tasks" class="modal"><div class="modal-content" style="width: 600px;"><span class="close-btn">&times;</span><h3 id="day-tasks-title"></h3><ul id="day-tasks-list"></ul></div></div>
<div id="modal-finanzas" class="modal"><div class="modal-content"><span class="close-btn">&times;</span><h3 id="finanzas-title">Gestión de Pagos para: [Nombre]</h3><div class="finanzas-container"><div class="finanzas-section"><h4><i class="fas fa-file-invoice-dollar"></i> Honorarios</h4><div class="pagos-list" id="honorarios-list"></div><form class="add-pago-form" onsubmit="event.preventDefault(); app.handleAddPago('honorarios');"><div class="form-group"><label>Concepto</label><input type="text" id="honorario-concepto" placeholder="Ej: Pago mes de Mayo" required></div><div class="form-group"><label>Valor</label><input type="number" id="honorario-valor" placeholder="Ej: 1500000" required></div><div class="form-group"><label>Fecha Inicio</label><input type="date" id="honorario-fechaInicio" required></div><div class="form-group"><label>Fecha Fin</label><input type="date" id="honorario-fechaFin" required></div><button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Añadir Honorario</button></form></div><div class="finanzas-section"><h4><i class="fas fa-route"></i> Desplazamientos</h4><div class="pagos-list" id="desplazamientos-list"></div><form class="add-pago-form" onsubmit="event.preventDefault(); app.handleAddPago('desplazamientos');"><div class="form-group"><label>Concepto</label><input type="text" id="desplazamiento-concepto" placeholder="Ej: Viaje a Popayán" required></div><div class="form-group"><label>Valor</label><input type="number" id="desplazamiento-valor" placeholder="Ej: 80000" required></div><div class="form-group"><label>Fecha Inicio</label><input type="date" id="desplazamiento-fechaInicio" required></div><div class="form-group"><label>Fecha Fin</label><input type="date" id="desplazamiento-fechaFin" required></div><button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Añadir Desplazamiento</button></form></div></div></div></div>

<div id="modal-edit-pago" class="modal">
    <div class="modal-content" style="width: 500px;">
        <span class="close-btn">&times;</span>
        <h3 id="edit-pago-title">Editar Pago</h3>
        <form id="form-edit-pago">
            <input type="hidden" id="edit-pago-id">
            <input type="hidden" id="edit-pago-tipo">
            <div class="form-group">
                <label for="edit-pago-concepto">Concepto</label>
                <input type="text" id="edit-pago-concepto" required>
            </div>
            <div class="form-group">
                <label for="edit-pago-valor">Valor</label>
                <input type="number" id="edit-pago-valor" required>
            </div>
            <div class="form-group">
                <label for="edit-pago-fechaInicio">Fecha Inicio</label>
                <input type="date" id="edit-pago-fechaInicio" required>
            </div>
            <div class="form-group">
                <label for="edit-pago-fechaFin">Fecha Fin</label>
                <input type="date" id="edit-pago-fechaFin" required>
            </div>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </form>
    </div>
</div>

<div id="modal-bulk-miembro" class="modal">
    <div class="modal-content" style="width: 500px;">
        <span class="close-btn">&times;</span>
        <h3>Carga Masiva de Miembros de Equipo</h3>
        <p>Introduce un nombre por línea. Cada línea se convertirá en un nuevo miembro del equipo.</p>
        <div class="form-group">
            <label for="bulk-miembro-names">Nombres de Miembros</label>
            <textarea id="bulk-miembro-names" rows="10" placeholder="Ejemplo:&#10;Juan Pérez&#10;María García&#10;Carlos Ruiz"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" id="btn-save-bulk-miembros">Añadir Miembros</button>
    </div>
</div>

<!-- MODIFICADO: MODAL PARA DESCRIPCIÓN DEL EVENTO CON MODO VISTA Y EDICIÓN -->
<div id="modal-descripcion" class="modal">
    <div class="modal-content" style="width: 800px;">
        <span class="close-btn">&times;</span>
        <h3 id="modal-descripcion-title">Descripción del Evento</h3>
        <input type="hidden" id="descripcion-evento-id">

        <!-- Botón para entrar en modo edición -->
        <button id="btn-enter-edit-mode" class="btn btn-warning btn-sm" style="position: absolute; top: 1.5rem; right: 4rem;"><i class="fas fa-pencil-alt"></i> Editar</button>

        <!-- Contenedor para VISTA de la descripción (no editable) -->
        <div id="descripcion-view-container" class="ql-snow">
            <div class="ql-editor" style="height: auto; min-height: 300px; max-height: 60vh; overflow-y: auto; background-color: #f9f9f9; border-radius: 5px; padding: 1rem; border: 1px solid #f0f2f5;">
                <!-- El contenido renderizado va aquí -->
            </div>
        </div>

        <!-- Contenedor para el EDITOR Quill (oculto por defecto) -->
        <div id="descripcion-editor-container" style="display: none;">
            <div id="evento-descripcion-editor" style="height: 300px;"></div>
        </div>

        <!-- Contenedor para los botones de acción del editor (oculto por defecto) -->
        <div id="descripcion-actions-container" style="text-align: right; margin-top: 1.5rem; display: none; gap: 0.5rem;">
            <button class="btn btn-secondary" id="btn-cancel-descripcion">Cancelar</button>
            <button class="btn btn-primary" id="btn-save-descripcion">Guardar Cambios</button>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. STATE AND CONFIGURATION ---
        const state = {
            eventos: [],
            equipo: [],
            eventProjectTypes: ['Ferias locales', 'Ferias subregionles', 'Ferias especializadas', 'Rutas', 'Misiones'] 
        };
        const charts = {};
        const app = {};
        let quillEditor = null; // Variable para la instancia del editor Quill
        let currentCalendarDate = new Date();
        let currentMiembroIdFinanzas = null;
        let currentEventProjectTypeFilter = 'all'; 
        const emptyStateMsg = (msg) => `<div class="empty-state">${msg}</div>`;
        const checklistTemplate = {
            planeacion: [
                { id: 1, texto: 'Definir objetivos y alcance del evento', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
                { id: 2, texto: 'Elaborar presupuesto detallado', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
                { id: 3, texto: 'Seleccionar y reservar lugar del evento', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
                { id: 4, texto: 'Convocar unidades productivas/empresas participantes', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
            ],
            ejecucion: [
                { id: 5, texto: 'Montaje de stands y logística', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
                { id: 6, texto: 'Registro y atención de participantes', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
                { id: 7, texto: 'Desarrollo de agenda (charlas, ruedas de negocio)', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
                { id: 8, texto: 'Seguimiento y soporte durante el evento', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
            ],
            cierre: [
                { id: 9, texto: 'Desmontaje y limpieza del lugar', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
                { id: 10, texto: 'Recopilar encuestas de satisfacción', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
                { id: 11, texto: 'Consolidar base de datos de asistentes/contactos', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
            ],
            otro: [
                { id: 12, texto: 'Elaborar informe final del evento', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
                { id: 13, texto: 'Gestionar pagos a proveedores y personal', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
                { id: 14, texto: 'Archivar toda la documentación y soportes', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] },
            ]
        };

        // --- 2. MODALS AND UTILITIES ---
        app.modals = { checklist: document.getElementById('modal-checklist'), miembro: document.getElementById('modal-miembro'), evento: document.getElementById('modal-evento'), editEvento: document.getElementById('modal-edit-evento'), responsables: document.getElementById('modal-responsables'), dayTasks: document.getElementById('modal-day-tasks'), finanzas: document.getElementById('modal-finanzas'), editPago: document.getElementById('modal-edit-pago'), bulkMiembro: document.getElementById('modal-bulk-miembro'), descripcion: document.getElementById('modal-descripcion') };
        app.openModal = (modal) => modal.style.display = 'block';
        app.closeModal = (modal) => modal.style.display = 'none';
        
        app.getMiembroNombre = (id) => state.equipo.find(m => m.id == id)?.nombre || 'N/A';
        app.getMiembrosNombres = (ids) => ids.map(id => app.getMiembroNombre(id)).join(', ');
        
        app.getAllTasks = (evento) => {
            const allTasks = [];
            if (!evento || !evento.fases) return allTasks;
            for (const faseName of Object.keys(evento.fases)) {
                evento.fases[faseName].forEach(task => {
                    allTasks.push({ ...task, eventoNombre: evento.nombre, faseNombre: faseName, nivel: "Tarea Principal", tareaPadre: "" });
                    if (task.subtareas && Array.isArray(task.subtareas)) {
                        task.subtareas.forEach(subtask => {
                            allTasks.push({ ...subtask, eventoNombre: evento.nombre, faseNombre: faseName, nivel: "Sub-tarea", tareaPadre: task.texto });
                        });
                    }
                });
            }
            return allTasks;
        };

        app.getEventProgress = (evento) => { const t = app.getAllTasks(evento); return { total: t.length, completadas: t.filter(x => x.completado).length }; };
        app.getSemaforoColor = (v) => v === 100 ? 'var(--full-color)' : v >= 67 ? 'var(--success-color)' : v >= 34 ? 'var(--warning-color)' : 'var(--danger-color)';
        app.formatCurrency = (value) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value);
        app.formatDateTime = (dt) => dt ? new Date(dt).toLocaleString('es-CO', {hour12: true, year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'}) : 'N/A';
        app.formatDate = (d) => d ? new Date(d + 'T00:00:00').toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric' }) : 'N/A';


        // --- 3. DATA PERSISTENCE & CALCULATIONS ---
        app.loadState = () => {
            let dataToLoad = localStorage.getItem('projectManagementState_v15_temp_import') || localStorage.getItem('projectManagementState_v15');
            let loadedState = JSON.parse(dataToLoad) || { 
                equipo: [
                    { id: Date.now(), nombre: 'Coordinación de Proyecto' },
                    ...['Andres Felipe Samboni Perez', 'Daniela Alejandra Mera Lopez', 'Daniela Popo Choco', 'Javier Mariano Mera Rivera', 'Jose Sebastian Restrepo Muñoz', 'Juan Diego Aza Arcos', 'José Fernando Ruíz López', 'Luz Elena Laverde Urrea', 'Manuel Vicente Córdoba Martinez', 'María Fernanda Montenegro Mera', 'María Inés Sánchez', 'Sindy Paola Zuñiga Arrechea'].map((nombre, i) => ({ id: Date.now() + i + 1, nombre }))
                ],
                eventos: [],
                eventProjectTypes: state.eventProjectTypes
            };

            if (!loadedState.eventProjectTypes || loadedState.eventProjectTypes.length === 0) {
                loadedState.eventProjectTypes = state.eventProjectTypes; 
            } else {
                loadedState.eventProjectTypes = Array.from(new Set([...state.eventProjectTypes, ...loadedState.eventProjectTypes]));
            }
            
            loadedState.equipo.forEach(miembro => {
                if (!miembro.honorarios) miembro.honorarios = [];
                if (!miembro.desplazamientos) miembro.desplazamientos = [];
                [...miembro.honorarios, ...miembro.desplazamientos].forEach(pago => {
                    if(pago.fecha && pago.fechaInicio === undefined) { pago.fechaInicio = pago.fecha; pago.fechaFin = pago.fecha; delete pago.fecha; }
                    if (pago.fechaInicio === undefined) pago.fechaInicio = ''; 
                    if (pago.fechaFin === undefined) pago.fechaFin = '';     
                });
            });

            loadedState.eventos.forEach(evento => {
                if (evento.fecha && evento.fechaInicio === undefined) { evento.fechaInicio = evento.fecha; delete evento.fecha; }
                if (evento.fechaInicio === undefined) evento.fechaInicio = ''; 
                if (evento.fechaFin === undefined) { evento.fechaFin = ''; }
                if (evento.category !== undefined && evento.projectType === undefined) { evento.projectType = evento.category; delete evento.category; }
                if (evento.projectType === undefined) { evento.projectType = 'Otros'; }
                if (evento.descripcion === undefined) { evento.descripcion = ''; }
                if (evento.fases === undefined) { evento.fases = JSON.parse(JSON.stringify(checklistTemplate));}

                const migrateTask = (tarea) => {
                    if (tarea.responsable && !Array.isArray(tarea.responsables)) { tarea.responsables = tarea.responsable ? [String(tarea.responsable)] : []; delete tarea.responsable; }
                    if (!tarea.responsables) tarea.responsables = [];
                    if (tarea.fecha && !tarea.fechaInicio) { tarea.fechaInicio = tarea.fecha; tarea.fechaFin = ''; delete tarea.fecha; }
                    if (tarea.fechaInicio === undefined) tarea.fechaInicio = '';
                    if (tarea.fechaFin === undefined) tarea.fechaFin = '';
                    if (tarea.subtareas === undefined) { tarea.subtareas = [];
                    } else if (Array.isArray(tarea.subtareas)) { tarea.subtareas.forEach(sub => migrateTask(sub)); }
                };
                Object.values(evento.fases).flat().forEach(task => migrateTask(task));
            });
            Object.assign(state, loadedState);
        };
        app.saveState = () => localStorage.setItem('projectManagementState_v15', JSON.stringify(state)); 

        app.calculateAnalytics = () => {
            let totalTasks = 0, completedTasks = 0;
            const progressByEvent = { labels: [], data: [] };
            const performanceByPerson = {};

            state.equipo.forEach(m => performanceByPerson[m.id] = { name: m.nombre, completed: 0, total: 0 });
            
            state.eventos.forEach(e => {
                const { total, completadas } = app.getEventProgress(e);
                totalTasks += total;
                completedTasks += completadas;
                progressByEvent.labels.push(e.nombre);
                progressByEvent.data.push(total > 0 ? (completadas / total) * 100 : 0);
                
                app.getAllTasks(e).forEach(t => { 
                    t.responsables.forEach(rId => {
                        if (performanceByPerson[rId]) {
                            performanceByPerson[rId].total++;
                            if (t.completado) performanceByPerson[rId].completed++;
                        }
                    });
                });
            });
            return {
                general: { completado: completedTasks, pendiente: totalTasks - completedTasks },
                byEvent: progressByEvent,
                byPerson: {
                    labels: Object.values(performanceByPerson).map(p => p.name),
                    completadas: Object.values(performanceByPerson).map(p => p.completed),
                    pendientes: Object.values(performanceByPerson).map(p => p.total - p.completed)
                }
            };
        };


        // --- 4. RENDER FUNCTIONS (VIEWS) ---
        app.render = () => { 
            app.renderCharts(); 
            app.renderProjectTabs();
            app.renderEventGrid(currentEventProjectTypeFilter);
            app.renderEquipoTable(); 
            app.renderCalendar(); 
            app.renderFinanzasTable();
            app.renderReportOptions();
        };

        app.renderCharts = () => {
            const data = app.calculateAnalytics();
            if (charts.general) charts.general.destroy();
            charts.general = new Chart(document.getElementById('generalChart').getContext('2d'), { type: 'doughnut', data: { labels: ['Completado', 'Pendiente'], datasets: [{ data: [data.general.completado, data.general.pendiente], backgroundColor: ['#28a745', '#dc3545'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            
            if (charts.eventos) charts.eventos.destroy();
            charts.eventos = new Chart(document.getElementById('eventosChart').getContext('2d'), { type: 'bar', data: { labels: data.byEvent.labels, datasets: [{ label: 'Avance (%)', data: data.byEvent.data, backgroundColor: '#003366' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } } });
            
            if (charts.personas) charts.personas.destroy();
            charts.personas = new Chart(document.getElementById('personasChart').getContext('2d'), {type: 'bar', data: { labels: data.byPerson.labels, datasets: [ { label: 'Completadas', data: data.byPerson.completadas, backgroundColor: '#28a745'}, { label: 'Pendientes', data: data.byPerson.pendientes, backgroundColor: '#dc3545'} ] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } }, plugins: { legend: { position: 'top' } } }});
        };
        
        app.renderProjectTabs = () => { 
            const projectTypeNav = document.getElementById('event-project-type-nav');
            const projectTypeListCreate = document.getElementById('proyecto-tipos-list');
            const projectTypeListEdit = document.getElementById('proyecto-tipos-list-edit');
            
            projectTypeNav.innerHTML = '';
            projectTypeListCreate.innerHTML = ''; 
            projectTypeListEdit.innerHTML = ''; 

            const existingProjectTypes = new Set(state.eventos.map(e => e.projectType).filter(Boolean));
            const allProjectTypes = Array.from(new Set([...state.eventProjectTypes, ...existingProjectTypes])).sort();

            const allBtn = document.createElement('button');
            allBtn.className = `project-type-tab-link ${currentEventProjectTypeFilter === 'all' ? 'active' : ''}`;
            allBtn.dataset.projectType = 'all';
            allBtn.textContent = 'Todos';
            allBtn.addEventListener('click', () => {
                currentEventProjectTypeFilter = 'all';
                app.renderEventGrid(currentEventProjectTypeFilter);
                app.renderProjectTabs(); 
            });
            projectTypeNav.appendChild(allBtn);

            allProjectTypes.forEach(projectType => {
                const btn = document.createElement('button');
                btn.className = `project-type-tab-link ${currentEventProjectTypeFilter === projectType ? 'active' : ''}`;
                btn.dataset.projectType = projectType;
                btn.textContent = projectType;
                btn.addEventListener('click', () => {
                    currentEventProjectTypeFilter = projectType;
                    app.renderEventGrid(currentEventProjectTypeFilter);
                    app.renderProjectTabs(); 
                });
                projectTypeNav.appendChild(btn);

                const optionCreate = document.createElement('option');
                optionCreate.value = projectType;
                projectTypeListCreate.appendChild(optionCreate);

                const optionEdit = document.createElement('option');
                optionEdit.value = projectType;
                projectTypeListEdit.appendChild(optionEdit);
            });
        };

        app.renderEventGrid = (projectTypeFilter = 'all') => { 
            const container = document.getElementById('event-grid-container');
            const filteredEvents = projectTypeFilter === 'all'
                ? state.eventos
                : state.eventos.filter(e => e.projectType === projectTypeFilter);

            if (filteredEvents.length === 0) {
                let msg = `No hay eventos en el tipo de proyecto "${projectTypeFilter}".`;
                if (projectTypeFilter === 'all' && state.eventos.length === 0) { msg = "No hay eventos creados. ¡Crea el primero para empezar!"; }
                container.innerHTML = emptyStateMsg(msg);
                return;
            }
            container.innerHTML = '';
            filteredEvents.forEach(evento => { 
                const { total, completadas } = app.getEventProgress(evento);
                const avance = total > 0 ? Math.round((completadas / total) * 100) : 0;
                const card = document.createElement('div');
                card.className = 'event-card-item';
                card.innerHTML = `<div class="event-card-item-header">
                                    <h4 onclick="app.handleEditEventNameClick(this, '${evento.id}')" title="Haz clic para editar">${evento.nombre}</h4>
                                    <button class="btn btn-danger btn-sm" onclick="app.handleDeleteEvento('${evento.id}')"><i class="fas fa-trash"></i></button>
                                  </div>
                                  <div class="event-card-item-body">
                                    <div class="event-card-progress">
                                        <div class="progress-chart-container">
                                            <canvas id="progress-${evento.id}"></canvas>
                                            <div class="progress-chart-text" style="color:${app.getSemaforoColor(avance)};">${avance}%</div>
                                        </div>
                                        <div class="event-card-info">
                                            <strong>Fecha Inicio:</strong> ${app.formatDate(evento.fechaInicio)}<br>
                                            <strong>Fecha Fin:</strong> ${app.formatDate(evento.fechaFin)}<br>
                                            <strong>Tipo de Proyecto:</strong> ${evento.projectType || 'N/A'}<br>
                                            <strong>Tareas:</strong> ${completadas}/${total}
                                        </div>
                                    </div>
                                  </div>
                                  <div class="event-card-item-footer">
                                    <button class="btn btn-secondary" onclick="app.openDescripcionModal('${evento.id}')"><i class="fas fa-file-alt"></i> Descripción</button>
                                    <button class="btn btn-edit-details" onclick="app.handleEditEventDetails('${evento.id}')"><i class="fas fa-info-circle"></i> Detalles</button>
                                    <button class="btn btn-manage" onclick="app.renderChecklistModal('${evento.id}')"><i class="fas fa-edit"></i> Tareas</button>
                                  </div>`;
                container.appendChild(card);
                new Chart(document.getElementById(`progress-${evento.id}`).getContext('2d'), { type: 'doughnut', data: { datasets: [{ data: [avance, 100 - avance], backgroundColor: [app.getSemaforoColor(avance), '#e9ecef'], borderWidth: 0 }] }, options: { cutout: '70%', plugins: { tooltip: { enabled: false } } } });
            });
        };
        
        app.renderEquipoTable = () => {
            const container = document.getElementById('equipo-table-container');
            const tbody = document.getElementById('tabla-equipo').querySelector('tbody');
            if (state.equipo.length === 0) {
                container.innerHTML = emptyStateMsg("No hay miembros en el equipo. Añade el primero.");
                tbody.innerHTML = '';
                return;
            }
            container.querySelector('table').style.display = '';
            tbody.innerHTML = '';
            state.equipo.forEach(miembro => {
                const tareasAsignadas = state.eventos.flatMap(e => app.getAllTasks(e)).filter(t => t.responsables.includes(String(miembro.id))).length;
                tbody.innerHTML += `<tr><td>${miembro.nombre}</td><td>${tareasAsignadas}</td><td class="actions"><button class="btn btn-sm btn-warning" onclick="app.handleEditMiembro(${miembro.id})"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-danger" onclick="app.handleDeleteMiembro(${miembro.id})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        };
        
        app.renderFinanzasTable = () => {
            const container = document.getElementById('finanzas-table-container');
            const tbody = document.getElementById('tabla-finanzas').querySelector('tbody');
            if (state.equipo.length === 0) {
                container.innerHTML = emptyStateMsg("No hay miembros de equipo para gestionar finanzas.");
                tbody.innerHTML = '';
                return;
            }
            container.querySelector('table').style.display = '';
            tbody.innerHTML = '';
            state.equipo.forEach(miembro => {
                const totalHonorarios = miembro.honorarios.reduce((sum, p) => sum + (Number(p.valor) || 0), 0);
                const totalDesplazamientos = miembro.desplazamientos.reduce((sum, p) => sum + (Number(p.valor) || 0), 0);
                tbody.innerHTML += `<tr><td>${miembro.nombre}</td><td>${app.formatCurrency(totalHonorarios)}</td><td>${app.formatCurrency(totalDesplazamientos)}</td><td class="actions"><button class="btn btn-sm btn-primary" onclick="app.openFinanzasModal(${miembro.id})"><i class="fas fa-edit"></i> Gestionar Pagos</button></td></tr>`;
            });
        };

        app.renderChecklistModal = (eventoId) => {
            const evento = state.eventos.find(e => e.id === eventoId); 
            if (!evento) return;
            document.getElementById('checklist-title').textContent = `Gestionar Tareas de: ${evento.nombre}`;
            const container = document.getElementById('checklist-container');
            container.innerHTML = '';

            for (const [fase, tareas] of Object.entries(evento.fases)) {
                let faseHtml = `<div class="checklist-phase" data-fase-id="${fase}"><h4>${fase.charAt(0).toUpperCase() + fase.slice(1)}</h4><div id="task-list-${fase}">`;
                
                tareas.forEach(tarea => {
                    const tieneResponsables = tarea.responsables && tarea.responsables.length > 0;
                    faseHtml += `
                        <div class="checklist-task ${tarea.completado ? 'completed' : ''}" data-task-id="${tarea.id}">
                            <input type="checkbox" onchange="app.handleToggleTask('${evento.id}', '${fase}', '${tarea.id}')" ${tarea.completado ? 'checked' : ''}>
                            <div class="task-description"><input type="text" value="${tarea.texto}" onchange="app.handleEditTaskText('${evento.id}', '${fase}', '${tarea.id}', this.value)"></div>
                            <div class="task-assignment">
                                <label>Inicio:</label><input type="datetime-local" value="${tarea.fechaInicio || ''}" onchange="app.handleEditTaskDate('${evento.id}', '${fase}', '${tarea.id}', 'fechaInicio', this.value)">
                                <label>Fin:</label><input type="datetime-local" value="${tarea.fechaFin || ''}" onchange="app.handleEditTaskDate('${evento.id}', '${fase}', '${tarea.id}', 'fechaFin', this.value)">
                                <div class="responsables-display" title="${app.getMiembrosNombres(tarea.responsables)}">${app.getMiembrosNombres(tarea.responsables) || 'Sin asignar'}</div>
                                <button class="btn btn-sm ${tieneResponsables ? 'btn-success' : ''}" onclick="app.openResponsablesModalForTask('${evento.id}', '${fase}', '${tarea.id}')">${tieneResponsables ? 'Asignado' : 'Asignar'}</button>
                                <button class="btn btn-sm btn-danger" style="background:none; color:var(--danger-color);" onclick="app.handleDeleteTask('${evento.id}', '${fase}', '${tarea.id}')"><i class="fas fa-times"></i></button>
                            </div>
                        </div>`;
                    
                    if (tarea.subtareas && tarea.subtareas.length > 0) {
                        faseHtml += `<div class="subtasks-container">`;
                        tarea.subtareas.forEach(subtarea => {
                            const tieneSubResponsables = subtarea.responsables && subtarea.responsables.length > 0;
                            faseHtml += `
                                <div class="subtask-item ${subtarea.completado ? 'completed' : ''}" data-subtask-id="${subtarea.id}">
                                    <input type="checkbox" onchange="app.handleToggleSubtask('${evento.id}', '${fase}', '${tarea.id}', '${subtarea.id}')" ${subtarea.completado ? 'checked' : ''}>
                                    <div class="task-description"><input type="text" value="${subtarea.texto}" onchange="app.handleEditSubtaskText('${evento.id}', '${fase}', '${tarea.id}', '${subtarea.id}', this.value)"></div>
                                    <div class="task-assignment">
                                        <label>Inicio:</label><input type="datetime-local" value="${subtarea.fechaInicio || ''}" onchange="app.handleEditSubtaskDate('${evento.id}', '${fase}', '${tarea.id}', '${subtarea.id}', 'fechaInicio', this.value)">
                                        <label>Fin:</label><input type="datetime-local" value="${subtarea.fechaFin || ''}" onchange="app.handleEditSubtaskDate('${evento.id}', '${fase}', '${tarea.id}', '${subtarea.id}', 'fechaFin', this.value)">
                                        <div class="responsables-display" title="${app.getMiembrosNombres(subtarea.responsables)}">${app.getMiembrosNombres(subtarea.responsables) || 'Sin asignar'}</div>
                                        <button class="btn btn-sm ${tieneSubResponsables ? 'btn-success' : ''}" onclick="app.openResponsablesModalForSubtask('${evento.id}', '${fase}', '${tarea.id}', '${subtarea.id}')">${tieneSubResponsables ? 'Asignado' : 'Asignar'}</button>
                                        <button class="btn btn-sm btn-danger" style="background:none; color:var(--danger-color);" onclick="app.handleDeleteSubtask('${evento.id}', '${fase}', '${tarea.id}', '${subtarea.id}')"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>`;
                        });
                        faseHtml += `</div>`;
                    }
                    faseHtml += `<div class="add-subtask-btn-container"><button class="btn btn-add-subtask" onclick="app.handleAddSubtask('${evento.id}', '${fase}', '${tarea.id}')"><i class="fas fa-plus"></i> Añadir Sub-tarea</button></div>`;
                });
                
                faseHtml += `</div><div class="add-task-btn-container"><button class="btn btn-add-task btn-sm" onclick="app.handleAddTask('${evento.id}', '${fase}')"><i class="fas fa-plus"></i> Añadir Tarea Principal</button></div></div>`;
                container.innerHTML += faseHtml;
            }
            app.openModal(app.modals.checklist);
        };
        
        app.renderCalendar = () => {
            const grid = document.getElementById('calendar-grid');
            const monthYearEl = document.getElementById('calendar-month-year');
            grid.innerHTML = '';
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            monthYearEl.textContent = `${currentCalendarDate.toLocaleString('es-ES', { month: 'long' })} ${year}`.toUpperCase();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const tasksByDate = {};
            const eventsStartingByDate = {}; 

            state.eventos.forEach(evento => {
                const eventStartDate = evento.fechaInicio ? new Date(evento.fechaInicio.split('T')[0]) : null;
                if (eventStartDate && !isNaN(eventStartDate.getTime()) && eventStartDate.getFullYear() === year && eventStartDate.getMonth() === month) {
                    const datePart = eventStartDate.toISOString().split('T')[0];
                    if (!eventsStartingByDate[datePart]) eventsStartingByDate[datePart] = [];
                    eventsStartingByDate[datePart].push(evento);
                }

                app.getAllTasks(evento).forEach(tarea => {
                    const startDate = tarea.fechaInicio ? new Date(tarea.fechaInicio.split('T')[0]) : null;
                    const endDate = tarea.fechaFin ? new Date(tarea.fechaFin.split('T')[0]) : null;

                    if (startDate && !isNaN(startDate.getTime())) { 
                        let currentDatePointer = new Date(startDate);
                        const endBoundary = endDate && !isNaN(endDate.getTime()) ? endDate.getTime() : startDate.getTime();

                        while (currentDatePointer.getTime() <= endBoundary) {
                            if (currentDatePointer.getFullYear() === year && currentDatePointer.getMonth() === month) {
                                const datePart = currentDatePointer.toISOString().split('T')[0];
                                if (!tasksByDate[datePart]) tasksByDate[datePart] = [];
                                tasksByDate[datePart].push(tarea); 
                            }
                            currentDatePointer.setDate(currentDatePointer.getDate() + 1); 
                        }
                    }
                });
            });
            for (let i = 0; i < firstDay; i++) { grid.innerHTML += `<div class="calendar-day other-month"></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.innerHTML = `<div class="day-number">${day}</div>`;
                
                const isEventStartDate = eventsStartingByDate[dateStr] && eventsStartingByDate[dateStr].length > 0;
                const hasTasks = tasksByDate[dateStr] && tasksByDate[dateStr].length > 0;

                if (isEventStartDate) {
                    dayEl.classList.add('event-start-day');
                }

                if (hasTasks) {
                    dayEl.classList.add('has-tasks');
                    dayEl.innerHTML += `<div class="day-tasks-badge">${tasksByDate[dateStr].length}</div>`;
                }

                if (hasTasks || isEventStartDate) {
                    dayEl.style.cursor = 'pointer';
                    dayEl.onclick = () => app.showDayDetails(dateStr, tasksByDate[dateStr] || [], eventsStartingByDate[dateStr] || []);
                }
                grid.appendChild(dayEl);
            }
        };


        app.renderPagosList = (miembro, tipo, containerId) => {
            const container = document.getElementById(containerId);
            const header = `
                <div class="pago-item" style="font-weight:bold; border-bottom-width: 2px;">
                    <span>Concepto</span>
                    <span>Periodo</span>
                    <span>Valor</span>
                    <span>Acciones</span>
                </div>`;
            container.innerHTML = header + miembro[tipo].map(pago => `
                <div class="pago-item" data-pago-id="${pago.id}">
                    <span>${pago.concepto || 'Sin concepto'}</span>
                    <span>${app.formatDate(pago.fechaInicio)} al ${app.formatDate(pago.fechaFin)}</span>
                    <span>${app.formatCurrency(pago.valor)}</span>
                    <div class="pago-actions">
                        <button class="btn btn-warning btn-sm" onclick="app.handleEditPago('${tipo}', ${pago.id})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger btn-sm" onclick="app.handleDeletePago('${tipo}', ${pago.id})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`).join('');
        };
        
        app.renderReportOptions = () => {
            const select = document.getElementById('select-finanzas-persona');
            if (!select) return;
            select.innerHTML = '<option value="">-- Seleccione una persona --</option>';
            state.equipo.forEach(miembro => {
                select.innerHTML += `<option value="${miembro.id}">${miembro.nombre}</option>`;
            });
        };

        // --- 5. EVENT HANDLERS (CONTROLLERS) ---
        app.handleTabClick = (e) => {
            document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active'));
            e.currentTarget.classList.add('active');
            document.getElementById(e.currentTarget.dataset.tab).classList.add('active');
            app.render();
        };

        app.handleAddTask = (eId, f) => { 
            state.eventos.find(e => e.id === eId).fases[f].push({ id: Date.now(), texto: 'Nueva Tarea (Editar)', completado: false, responsables: [], fechaInicio: '', fechaFin: '', subtareas: [] }); 
            app.saveState(); 
            app.renderChecklistModal(eId); 
        };
        
        app.handleDeleteTask = (eId, f, tId) => { 
            if(confirm('¿Seguro que desea eliminar esta tarea y todas sus sub-tareas?')) {
                const e = state.eventos.find(x => x.id === eId); 
                e.fases[f] = e.fases[f].filter(t => t.id != tId); 
                app.saveState(); 
                app.renderChecklistModal(eId); 
            }
        };
        
        app.handleToggleTask = (eId, f, tId) => { 
            const task = state.eventos.find(e => e.id === eId).fases[f].find(x => x.id == tId); 
            task.completado = !task.completado; 
            if (task.subtareas && Array.isArray(task.subtareas)) {
                task.subtareas.forEach(subtask => subtask.completado = task.completado);
            }
            app.saveState(); 
            app.render(); 
            app.renderChecklistModal(eId); 
        };

        app.handleEditTaskText = (eId, f, tId, txt) => { state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).texto = txt; app.saveState(); };
        app.handleEditTaskDate = (eId, f, tId, tipoFecha, date) => { state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId)[tipoFecha] = date; app.saveState(); app.render(); };
        
        app.handleAddSubtask = (eId, f, tId) => {
            const parentTask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId);
            if (!parentTask.subtareas) parentTask.subtareas = [];
            parentTask.subtareas.push({ id: Date.now(), texto: 'Nueva Sub-tarea (Editar)', completado: false, responsables: [], fechaInicio: '', fechaFin: '' });
            app.saveState();
            app.renderChecklistModal(eId);
        };

        app.handleDeleteSubtask = (eId, f, tId, stId) => {
            if(confirm('¿Seguro que desea eliminar esta sub-tarea?')) {
                const parentTask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId);
                parentTask.subtareas = parentTask.subtareas.filter(st => st.id != stId);
                app.saveState();
                app.renderChecklistModal(eId);
            }
        };

        app.handleToggleSubtask = (eId, f, tId, stId) => {
            const subtask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId);
            subtask.completado = !subtask.completado;
            app.saveState();
            app.render(); 
            document.querySelector(`.subtask-item[data-subtask-id='${stId}']`).classList.toggle('completed', subtask.completado);
        };

        app.handleEditSubtaskText = (eId, f, tId, stId, txt) => {
            state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId).texto = txt;
            app.saveState();
        };

        app.handleEditSubtaskDate = (eId, f, tId, stId, tipoFecha, date) => {
            state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId)[tipoFecha] = date;
            app.saveState();
            app.render();
        };

        app.openResponsablesModalForTask = (eId, f, tId) => {
            const tarea = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId);
            const container = document.getElementById('responsables-checkbox-container');
            container.innerHTML = state.equipo.map(m => `<div class="responsable-option"><label><input type="checkbox" value="${m.id}" ${tarea.responsables.includes(String(m.id)) ? 'checked' : ''}>${m.nombre}</label></div>`).join('');
            document.getElementById('btn-save-responsables').onclick = () => app.handleSaveResponsablesForTask(eId, f, tId);
            app.openModal(app.modals.responsables);
        };

        app.handleSaveResponsablesForTask = (eId, f, tId) => {
            const nuevosResponsables = [];
            document.querySelectorAll('#responsables-checkbox-container input:checked').forEach(checkbox => {nuevosResponsables.push(checkbox.value);});
            state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).responsables = nuevosResponsables;
            app.saveState();
            app.render(); 
            app.renderChecklistModal(eId); 
            app.closeModal(app.modals.responsables);
        };

        app.openResponsablesModalForSubtask = (eId, f, tId, stId) => {
            const subtask = state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId);
            const container = document.getElementById('responsables-checkbox-container');
            container.innerHTML = state.equipo.map(m => `<div class="responsable-option"><label><input type="checkbox" value="${m.id}" ${subtask.responsables.includes(String(m.id)) ? 'checked' : ''}>${m.nombre}</label></div>`).join('');
            document.getElementById('btn-save-responsables').onclick = () => app.handleSaveResponsablesForSubtask(eId, f, tId, stId);
            app.openModal(app.modals.responsables);
        };

        app.handleSaveResponsablesForSubtask = (eId, f, tId, stId) => {
            const nuevosResponsables = [];
            document.querySelectorAll('#responsables-checkbox-container input:checked').forEach(checkbox => {nuevosResponsables.push(checkbox.value);});
            state.eventos.find(e => e.id === eId).fases[f].find(t => t.id == tId).subtareas.find(st => st.id == stId).responsables = nuevosResponsables;
            app.saveState();
            app.render();
            app.renderChecklistModal(eId);
            app.closeModal(app.modals.responsables);
        };

        app.handleEditEventNameClick = (h4Element, eventoId) => {const originalName = h4Element.textContent.trim();h4Element.innerHTML = ''; const input = document.createElement('input');input.type = 'text';input.value = originalName;input.className = 'inline-edit-input';const save = () => {const newName = input.value.trim();if (newName && newName !== originalName) {app.handleSaveEventName(eventoId, newName);} else {h4Element.textContent = originalName;}};input.addEventListener('blur', save);input.addEventListener('keydown', (e) => {if (e.key === 'Enter') {input.blur();} else if (e.key === 'Escape') {h4Element.textContent = originalName; h4Element.focus();}});h4Element.appendChild(input);input.focus();input.select();};
        app.handleSaveEventName = (eventoId, newName) => {const evento = state.eventos.find(e => e.id === eventoId);if (evento) {evento.nombre = newName;app.saveState();app.render();}};
        app.handleDeleteEvento = (id) => { if(confirm('¿Seguro que desea eliminar este evento?')) { state.eventos = state.eventos.filter(e => e.id !== id); app.saveState(); app.render(); } };
        
        app.handleEditMiembro = (id) => { const m = state.equipo.find(x => x.id === id); document.getElementById('miembro-id').value = m.id; document.getElementById('miembro-nombre').value = m.nombre; document.getElementById('modal-miembro-title').innerText = 'Editar Miembro'; app.openModal(app.modals.miembro); };
        app.handleDeleteMiembro = (id) => { 
            if(confirm('¿Está seguro? Las tareas y pagos asignados a esta persona se eliminarán.')) { 
                state.equipo = state.equipo.filter(m => m.id !== id); 
                state.eventos.forEach(e => app.getAllTasks(e).forEach(t => { t.responsables = t.responsables.filter(rId => rId != id); })); 
                app.saveState(); 
                app.render(); 
            } 
        };
        
        app.showDayDetails = (dateStr, tasks, events) => {
            const dateObj = new Date(dateStr + 'T00:00:00');
            document.getElementById('day-tasks-title').textContent = `Detalle del Día: ${dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            const listEl = document.getElementById('day-tasks-list'); 

            let contentHtml = '';

            if (events && events.length > 0) {
                contentHtml += `<h4 style="color: var(--danger-color); margin-bottom: 0.5rem;"><i class="fas fa-play-circle"></i> Eventos que inician este día:</h4><ul style="list-style: none; padding: 0;">`;
                events.forEach(event => {
                    contentHtml += `<li><strong>${event.nombre}</strong><br><small><em>Tipo:</em> ${event.projectType || 'N/A'}</small><br><small><em>Inicio:</em> ${app.formatDate(event.fechaInicio)} | <em>Fin:</em> ${app.formatDate(event.fechaFin)}</small></li>`;
                });
                contentHtml += `</ul>`;
                if (tasks && tasks.length > 0) { contentHtml += `<hr style="margin: 1.5rem 0; border-top: 1px dashed var(--border-color);">`; }
            }

            if (tasks && tasks.length > 0) {
                contentHtml += `<h4 style="color: var(--primary-color); margin-bottom: 0.5rem;"><i class="fas fa-tasks"></i> Tareas asignadas para este día:</h4><ul style="list-style: none; padding: 0;">`;
                tasks.forEach(t => {
                    let taskTitle = t.texto; let indentStyle = '';
                    if (t.nivel === "Sub-tarea") { taskTitle = `&nbsp;&nbsp;&nbsp;<i class="fas fa-indent"></i> ${t.texto}`; indentStyle = 'padding-left: 20px;'; }
                    contentHtml += `<li style="${indentStyle}"><strong>${taskTitle}</strong><br><small><em>Evento:</em> ${t.eventoNombre}</small><br>`;
                    if (t.nivel === "Sub-tarea" && t.tareaPadre) { contentHtml += `<small><em>Tarea Padre:</em> ${t.tareaPadre}</small><br>`; }
                    contentHtml += `<small><em>Fase:</em> ${t.faseNombre}</small><br><small><em>Inicio:</em> ${app.formatDateTime(t.fechaInicio)} | <em>Fin:</em> ${app.formatDateTime(t.fechaFin)}</small><br><small><em>Responsables:</em> ${app.getMiembrosNombres(t.responsables) || 'Sin asignar'}</small></li>`;
                });
                contentHtml += `</ul>`;
            } else if (!events || events.length === 0) {
                 contentHtml += `<p style="text-align: center; color: var(--light-text-color); padding: 1.5rem 0;">No hay eventos que inicien ni tareas asignadas para este día.</p>`;
            }

            listEl.innerHTML = contentHtml;
            app.openModal(app.modals.dayTasks); 
        };
        
        app.openFinanzasModal = (miembroId) => {currentMiembroIdFinanzas = miembroId;const miembro = state.equipo.find(m => m.id === miembroId);if (!miembro) return;document.getElementById('finanzas-title').textContent = `Gestión de Pagos para: ${miembro.nombre}`;app.renderPagosList(miembro, 'honorarios', 'honorarios-list');app.renderPagosList(miembro, 'desplazamientos', 'desplazamientos-list');app.openModal(app.modals.finanzas);};
        
        app.handleAddPago = (tipo) => {
            if (!currentMiembroIdFinanzas) return;
            const miembro = state.equipo.find(m => m.id === currentMiembroIdFinanzas);
            const tipoSingular = tipo.slice(0, -1);
            
            const conceptoInput = document.getElementById(`${tipoSingular}-concepto`);
            const valorInput = document.getElementById(`${tipoSingular}-valor`);
            const fechaInicioInput = document.getElementById(`${tipoSingular}-fechaInicio`);
            const fechaFinInput = document.getElementById(`${tipoSingular}-fechaFin`);

            const concepto = conceptoInput.value; const valor = valorInput.value;
            const fechaInicio = fechaInicioInput.value; const fechaFin = fechaFinInput.value;

            if (!concepto || !valor || !fechaInicio || !fechaFin) { alert('El concepto, valor y ambas fechas son obligatorios.'); return; }
            if (new Date(fechaFin) < new Date(fechaInicio)) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; }

            miembro[tipo].push({ id: Date.now(), concepto, valor: parseFloat(valor), fechaInicio, fechaFin });
            app.saveState();
            
            conceptoInput.value = ''; valorInput.value = ''; fechaInicioInput.value = ''; fechaFinInput.value = '';
            
            app.renderPagosList(miembro, tipo, `${tipo}-list`);
            app.renderFinanzasTable(); 
        };

        app.handleDeletePago = (tipo, pagoId) => {if (!currentMiembroIdFinanzas) return;const miembro = state.equipo.find(m => m.id === currentMiembroIdFinanzas);miembro[tipo] = miembro[tipo].filter(p => p.id !== pagoId);app.saveState();app.renderPagosList(miembro, tipo, `${tipo}-list`);app.renderFinanzasTable();};

        app.handleEditPago = (tipo, pagoId) => {
            if (!currentMiembroIdFinanzas) return;
            const miembro = state.equipo.find(m => m.id === currentMiembroIdFinanzas);
            const pago = miembro[tipo].find(p => p.id === pagoId);
            if (!pago) return;

            document.getElementById('edit-pago-id').value = pago.id;
            document.getElementById('edit-pago-tipo').value = tipo;
            document.getElementById('edit-pago-concepto').value = pago.concepto;
            document.getElementById('edit-pago-valor').value = pago.valor;
            document.getElementById('edit-pago-fechaInicio').value = pago.fechaInicio;
            document.getElementById('edit-pago-fechaFin').value = pago.fechaFin;
            
            app.openModal(app.modals.editPago);
        };

        app.handleEditEventDetails = (eventoId) => {
            const evento = state.eventos.find(e => e.id === eventoId);
            if (!evento) return;

            document.getElementById('edit-evento-id').value = evento.id;
            document.getElementById('edit-evento-nombre').value = evento.nombre;
            document.getElementById('edit-evento-fecha-inicio').value = evento.fechaInicio;
            document.getElementById('edit-evento-fecha-fin').value = evento.fechaFin;
            document.getElementById('edit-evento-proyecto-tipo').value = evento.projectType;
            
            app.renderProjectTabs();
            app.openModal(app.modals.editEvento);
        };
        
        app.handleDownloadIndividualReport = (miembroId) => {
            const miembro = state.equipo.find(m => m.id == miembroId);
            if (!miembro) { alert('Persona no encontrada.'); return; }
            const reportData = [];
            miembro.honorarios.forEach(p => reportData.push({ 'Tipo de Pago': 'Honorario', 'Concepto': p.concepto, 'Valor': p.valor, 'Fecha Inicio': p.fechaInicio, 'Fecha Fin': p.fechaFin }));
            miembro.desplazamientos.forEach(p => reportData.push({ 'Tipo de Pago': 'Desplazamiento', 'Concepto': p.concepto, 'Valor': p.valor, 'Fecha Inicio': p.fechaInicio, 'Fecha Fin': p.fechaFin }));
            if (reportData.length === 0) { alert('Este miembro no tiene pagos registrados.'); return; }
            const ws = XLSX.utils.json_to_sheet(reportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Pagos");
            XLSX.writeFile(wb, `Reporte_Financiero_${miembro.nombre.replace(/ /g, '_')}.xlsx`);
        };

        app.handleBulkAddMiembros = () => {
            const textarea = document.getElementById('bulk-miembro-names');
            const names = textarea.value.split('\n').map(name => name.trim()).filter(Boolean);

            if (names.length === 0) { alert('Por favor, ingrese al menos un nombre.'); return; }

            let newMembersAdded = 0;
            const existingNames = new Set(state.equipo.map(m => m.nombre.toLowerCase()));

            names.forEach(name => {
                if (!existingNames.has(name.toLowerCase())) {
                    state.equipo.push({ id: Date.now() + Math.random(), nombre: name, honorarios: [], desplazamientos: [] });
                    newMembersAdded++;
                }
            });

            if (newMembersAdded > 0) {
                app.saveState(); app.render();
                alert(`Se añadieron ${newMembersAdded} nuevos miembros.`);
                textarea.value = '';
                app.closeModal(app.modals.bulkMiembro);
            } else { alert('No se añadieron nuevos miembros. Es posible que ya existan en la lista.'); }
        };

        // MODIFICADO: Funciones para el modal de descripción con modo VISTA y EDICIÓN
        app.openDescripcionModal = (eventoId) => {
            const evento = state.eventos.find(e => e.id === eventoId);
            if (!evento) return;

            document.getElementById('descripcion-evento-id').value = eventoId;
            document.getElementById('modal-descripcion-title').textContent = `Descripción de: ${evento.nombre}`;
            
            const viewContainer = document.querySelector('#descripcion-view-container .ql-editor');
            viewContainer.innerHTML = evento.descripcion || '<p><i>No hay descripción. Haga clic en "Editar" para añadir una.</i></p>';

            document.getElementById('descripcion-view-container').style.display = 'block';
            document.getElementById('descripcion-editor-container').style.display = 'none';
            document.getElementById('btn-enter-edit-mode').style.display = 'inline-block';
            document.getElementById('descripcion-actions-container').style.display = 'none';

            app.openModal(app.modals.descripcion);
        };

        app.handleSaveDescripcion = () => {
            const eventoId = document.getElementById('descripcion-evento-id').value;
            const evento = state.eventos.find(e => e.id === eventoId);
            if (!evento || !quillEditor) return;

            const newDescription = quillEditor.root.innerHTML;
            evento.descripcion = (newDescription === '<p><br></p>') ? '' : newDescription;

            app.saveState();
            
            const viewContainer = document.querySelector('#descripcion-view-container .ql-editor');
            viewContainer.innerHTML = evento.descripcion || '<p><i>No hay descripción. Haga clic en "Editar" para añadir una.</i></p>';

            document.getElementById('descripcion-view-container').style.display = 'block';
            document.getElementById('descripcion-editor-container').style.display = 'none';
            document.getElementById('btn-enter-edit-mode').style.display = 'inline-block';
            document.getElementById('descripcion-actions-container').style.display = 'none';
        };


        // --- 6. EVENT LISTENERS BINDING ---
        Object.values(app.modals).forEach(modal => { if (modal) { modal.querySelector('.close-btn').addEventListener('click', () => app.closeModal(modal)); modal.addEventListener('click', (e) => { if (e.target === modal) app.closeModal(modal); }); }});
        
        document.querySelectorAll('.tab-link').forEach(link => link.addEventListener('click', app.handleTabClick));
        
        document.getElementById('btn-add-evento').addEventListener('click', () => { 
            document.getElementById('form-evento').reset(); 
            document.getElementById('evento-proyecto-tipo').value = ""; 
            app.renderProjectTabs();
            app.openModal(app.modals.evento); 
        });
        document.getElementById('form-evento').addEventListener('submit', e => { 
            e.preventDefault(); 
            const fechaInicio = document.getElementById('evento-fecha-inicio').value;
            const fechaFin = document.getElementById('evento-fecha-fin').value;
            const projectType = document.getElementById('evento-proyecto-tipo').value.trim(); 

            if (new Date(fechaFin) < new Date(fechaInicio)) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; }
            if (!projectType) { alert('Por favor, ingrese un tipo de proyecto para el evento.'); return; }

            const newEvent = { 
                id: 'evt-' + Date.now(), 
                nombre: document.getElementById('evento-nombre').value, 
                fechaInicio: fechaInicio, 
                fechaFin: fechaFin,       
                projectType: projectType,
                descripcion: '',
                fases: JSON.parse(JSON.stringify(checklistTemplate))
            }; 
            const assignIds = (tasks) => {
                tasks.forEach(task => {
                    task.id = Date.now() + Math.random(); 
                    if (task.subtareas && Array.isArray(task.subtareas)) { assignIds(task.subtareas); }
                });
            };
            Object.values(newEvent.fases).forEach(faseTasks => assignIds(faseTasks));
            state.eventos.push(newEvent); 
            if (!state.eventProjectTypes.includes(projectType)) { state.eventProjectTypes.push(projectType); }
            app.saveState(); 
            currentEventProjectTypeFilter = 'all';
            app.render(); 
            app.closeModal(app.modals.evento); 
        });

        document.getElementById('form-edit-evento').addEventListener('submit', e => {
            e.preventDefault();
            const eventoId = document.getElementById('edit-evento-id').value;
            const evento = state.eventos.find(evt => evt.id === eventoId);
            if (!evento) { alert('Error: Evento no encontrado.'); return; }

            const newNombre = document.getElementById('edit-evento-nombre').value;
            const newFechaInicio = document.getElementById('edit-evento-fecha-inicio').value;
            const newFechaFin = document.getElementById('edit-evento-fecha-fin').value;
            const newProjectType = document.getElementById('edit-evento-proyecto-tipo').value.trim();

            if (new Date(newFechaFin) < new Date(newFechaInicio)) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; }
            if (!newProjectType) { alert('Por favor, ingrese un tipo de proyecto para el evento.'); return; }

            evento.nombre = newNombre; evento.fechaInicio = newFechaInicio;
            evento.fechaFin = newFechaFin; evento.projectType = newProjectType;
            if (!state.eventProjectTypes.includes(newProjectType)) { state.eventProjectTypes.push(newProjectType); }
            app.saveState(); app.render(); app.closeModal(app.modals.editEvento);
        });
        
        document.getElementById('btn-add-miembro').addEventListener('click', () => { document.getElementById('form-miembro').reset(); document.getElementById('miembro-id').value = ''; document.getElementById('modal-miembro-title').innerText = 'Añadir Miembro'; app.openModal(app.modals.miembro); });
        document.getElementById('form-miembro').addEventListener('submit', e => { e.preventDefault(); const id = document.getElementById('miembro-id').value; const nombre = document.getElementById('miembro-nombre').value; if(id) { state.equipo.find(m => m.id == id).nombre = nombre; } else { state.equipo.push({ id: Date.now(), nombre, honorarios: [], desplazamientos: [] }); } app.saveState(); app.render(); app.closeModal(app.modals.miembro); });
        document.getElementById('btn-bulk-add-miembro').addEventListener('click', () => { document.getElementById('bulk-miembro-names').value = ''; app.openModal(app.modals.bulkMiembro); });
        document.getElementById('btn-save-bulk-miembros').addEventListener('click', app.handleBulkAddMiembros);
        document.getElementById('prev-month-btn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); app.renderCalendar(); });
        document.getElementById('next-month-btn').addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); app.renderCalendar(); });
        
        document.getElementById('form-edit-pago').addEventListener('submit', e => {
            e.preventDefault();
            const pagoId = document.getElementById('edit-pago-id').value;
            const tipo = document.getElementById('edit-pago-tipo').value;
            if (!currentMiembroIdFinanzas || !pagoId || !tipo) return;
            const miembro = state.equipo.find(m => m.id === currentMiembroIdFinanzas);
            const pago = miembro[tipo].find(p => p.id == pagoId);
            if (!pago) return;
            pago.concepto = document.getElementById('edit-pago-concepto').value;
            pago.valor = parseFloat(document.getElementById('edit-pago-valor').value);
            pago.fechaInicio = document.getElementById('edit-pago-fechaInicio').value;
            pago.fechaFin = document.getElementById('edit-pago-fechaFin').value;
            if (new Date(pago.fechaFin) < new Date(pago.fechaInicio)) { alert('La fecha de fin no puede ser anterior a la fecha de inicio.'); return; }
            app.saveState(); app.renderPagosList(miembro, tipo, `${tipo}-list`); app.renderFinanzasTable(); app.closeModal(app.modals.editPago);
        });

        // Report Listeners
        document.getElementById('btn-download-tareas-persona').addEventListener('click', () => { 
            const data = [];
            state.eventos.forEach(e => {
                app.getAllTasks(e).forEach(t => { 
                    data.push({ "Responsables": app.getMiembrosNombres(t.responsables), "Evento": e.nombre, "Tipo de Proyecto": e.projectType || 'N/A', "Fase": t.faseNombre, "Nivel": t.nivel, "Tarea Padre": t.tareaPadre, "Tarea": t.texto, "Fecha Inicio": t.fechaInicio, "Fecha Fin": t.fechaFin, "Estado": t.completado ? "Completado" : "Pendiente" });
                });
            });
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Tareas por Persona"); XLSX.writeFile(wb, "Reporte_Tareas_por_Persona.xlsx"); 
        });

        document.getElementById('btn-download-avance-evento').addEventListener('click', () => { 
            const data = state.eventos.map(e => { const { total, completadas } = app.getEventProgress(e); return { "Evento": e.nombre, "Fecha Inicio": e.fechaInicio, "Fecha Fin": e.fechaFin, "Tipo de Proyecto": e.projectType || 'N/A', "Total Tareas": total, "Completadas": completadas, "Avance (%)": total > 0 ? ((completadas / total) * 100).toFixed(2) : 0 }; }); 
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Avance por Evento"); XLSX.writeFile(wb, "Reporte_Avance_por_Evento.xlsx"); 
        });

        document.getElementById('btn-download-estado-general').addEventListener('click', () => { 
            const wb = XLSX.utils.book_new(); 
            state.eventos.forEach(e => { 
                const eventTasksData = [];
                app.getAllTasks(e).forEach(t => { eventTasksData.push({ "Fase": t.faseNombre, "Nivel": t.nivel, "Tarea Padre": t.tareaPadre, "Tarea": t.texto, "Fecha Inicio": t.fechaInicio, "Fecha Fin": t.fechaFin, "Estado": t.completado ? "Completado" : "Pendiente", "Responsables": app.getMiembrosNombres(t.responsables) }); });
                const ws = XLSX.utils.json_to_sheet(eventTasksData); 
                const sheetName = e.nombre.substring(0, 30).replace(/[\\/?*\[\]:]/g, '');
                XLSX.utils.book_append_sheet(wb, ws, sheetName); 
            }); 
            XLSX.writeFile(wb, "Reporte_General_Eventos.xlsx"); 
        });

        document.getElementById('btn-download-finanzas-general').addEventListener('click', () => { const reportData = []; state.equipo.forEach(miembro => { miembro.honorarios.forEach(p => reportData.push({ 'Miembro del Equipo': miembro.nombre, 'Tipo de Pago': 'Honorario', 'Concepto': p.concepto, 'Valor': p.valor, 'Fecha Inicio': p.fechaInicio, 'Fecha Fin': p.fechaFin })); miembro.desplazamientos.forEach(p => reportData.push({ 'Miembro del Equipo': miembro.nombre, 'Tipo de Pago': 'Desplazamiento', 'Concepto': p.concepto, 'Valor': p.valor, 'Fecha Inicio': p.fechaInicio, 'Fecha Fin': p.fechaFin })); }); if (reportData.length === 0) { alert('No hay pagos registrados.'); return; } const ws = XLSX.utils.json_to_sheet(reportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Pagos Generales"); XLSX.writeFile(wb, `Reporte_Financiero_General.xlsx`); });
        document.getElementById('btn-download-finanzas-individual').addEventListener('click', () => { const miembroId = document.getElementById('select-finanzas-persona').value; if (miembroId) { app.handleDownloadIndividualReport(miembroId); } else { alert('Por favor, seleccione una persona de la lista.'); } });
        
        document.getElementById('btn-export-data').addEventListener('click', () => { const dataStr = JSON.stringify(state, null, 2); const dataBlob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(dataBlob); const link = document.createElement('a'); link.href = url; link.download = `proyecto_backup_${new Date().toISOString().slice(0,10)}.json`; link.click(); URL.revokeObjectURL(url); });
        document.getElementById('import-file-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file && confirm("¿Importar archivo? Se sobreescribirán todos los datos actuales.")) { const reader = new FileReader(); reader.onload = (e) => { try { const imported = JSON.parse(e.target.result); 
                if (imported.eventos && imported.equipo) { 
                    localStorage.setItem('projectManagementState_v15_temp_import', JSON.stringify(imported)); 
                    Object.keys(state).forEach(key => delete state[key]);
                    app.loadState(); 
                    if (imported.eventProjectTypes && Array.isArray(imported.eventProjectTypes)) {
                        state.eventProjectTypes = Array.from(new Set([...state.eventProjectTypes, ...imported.eventProjectTypes]));
                    } else {
                         state.eventProjectTypes = Array.from(new Set([...state.eventProjectTypes, ...state.eventos.map(e => e.projectType).filter(Boolean)]));
                    }
                    localStorage.removeItem('projectManagementState_v15_temp_import'); 
                    app.saveState(); app.render(); 
                    alert("¡Datos importados con éxito!"); 
                } else { throw new Error("Formato de archivo inválido."); } } catch (err) { alert("Error al importar: " + err.message); } }; reader.readAsText(file); } event.target.value = ''; });

        // --- 7. INITIALIZATION ---
        
        quillEditor = new Quill('#evento-descripcion-editor', {
            modules: { toolbar: [ [{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'image', 'code-block'], ['clean'] ] },
            placeholder: 'Escribe la descripción detallada, objetivos, participantes clave, etc.',
            theme: 'snow'
        });

        document.getElementById('btn-enter-edit-mode').addEventListener('click', () => {
            const viewContainer = document.querySelector('#descripcion-view-container .ql-editor');
            const currentContent = viewContainer.innerHTML;
            
            if (viewContainer.querySelector('i')) { // If it's showing the placeholder text
                quillEditor.root.innerHTML = '';
            } else {
                quillEditor.root.innerHTML = currentContent;
            }

            document.getElementById('descripcion-view-container').style.display = 'none';
            document.getElementById('descripcion-editor-container').style.display = 'block';
            document.getElementById('btn-enter-edit-mode').style.display = 'none';
            document.getElementById('descripcion-actions-container').style.display = 'flex';
        });

        document.getElementById('btn-cancel-descripcion').addEventListener('click', () => {
            document.getElementById('descripcion-view-container').style.display = 'block';
            document.getElementById('descripcion-editor-container').style.display = 'none';
            document.getElementById('btn-enter-edit-mode').style.display = 'inline-block';
            document.getElementById('descripcion-actions-container').style.display = 'none';
        });
        
        document.getElementById('btn-save-descripcion').addEventListener('click', app.handleSaveDescripcion);

        app.loadState();
        app.render();

        window.app = app;
        window.resetApp = () => { if (confirm('¿Estás seguro? Se borrarán todos los datos y la aplicación se recargará.')) { localStorage.removeItem('projectManagementState_v15'); location.reload(); } };
        window.verEstado = () => { console.log('Estado actual:', state); };
    });

    const inputs = document.querySelectorAll("input");
    inputs.forEach(function (input) { input.setAttribute("autocomplete", "off"); });
</script>

</body>
</html>
